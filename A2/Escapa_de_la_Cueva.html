<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape de la Cueva: La Gran Odisea (A2)</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Metamorphous&family=Share+Tech+Mono&display=swap');

        /* --- ESTILOS INMERSIVOS --- */
        body {
            background-color: #000;
            color: #e2e8f0;
            font-family: 'Metamorphous', serif;
            overflow: hidden;
            user-select: none;
        }

        .font-tech {
            font-family: 'Share Tech Mono', monospace;
        }

        .font-cinzel {
            font-family: 'Cinzel', serif;
        }

        /* ANIMACIONES */
        @keyframes float-ethereal {

            0%,
            100% {
                transform: translateY(0) scale(1);
                filter: drop-shadow(0 0 5px rgba(251, 191, 36, 0.3));
            }

            50% {
                transform: translateY(-10px) scale(1.02);
                filter: drop-shadow(0 0 15px rgba(251, 191, 36, 0.6));
            }
        }

        @keyframes pulse-danger {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }

        @keyframes slide-in-bottom {
            0% {
                transform: translateY(50px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fade-in {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes shake-screen {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px) rotate(-1deg);
            }

            75% {
                transform: translateX(5px) rotate(1deg);
            }
        }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            15% { transform: scale(1.3); }
            30% { transform: scale(1); }
            45% { transform: scale(1.3); }
            60% { transform: scale(1); }
        }

        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(251, 191, 36, 0.3); }
            50% { box-shadow: 0 0 40px rgba(251, 191, 36, 0.6); }
        }

        @keyframes stagger-in {
            0% { opacity: 0; transform: translateY(20px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes particle-float {
            0%, 100% { opacity: 0.3; transform: translateY(0) translateX(0); }
            50% { opacity: 0.6; transform: translateY(-15px) translateX(5px); }
        }

        @keyframes text-reveal {
            0% { clip-path: inset(0 100% 0 0); opacity: 0; }
            100% { clip-path: inset(0 0 0 0); opacity: 1; }
        }

        .animate-float {
            animation: float-ethereal 4s ease-in-out infinite;
        }

        .animate-enter {
            animation: slide-in-bottom 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .animate-enter-stagger > * {
            animation: stagger-in 0.5s ease-out backwards;
        }

        .animate-enter-stagger > *:nth-child(1) { animation-delay: 0.1s; }
        .animate-enter-stagger > *:nth-child(2) { animation-delay: 0.2s; }
        .animate-enter-stagger > *:nth-child(3) { animation-delay: 0.3s; }
        .animate-enter-stagger > *:nth-child(4) { animation-delay: 0.4s; }
        .animate-enter-stagger > *:nth-child(5) { animation-delay: 0.5s; }
        .animate-enter-stagger > *:nth-child(6) { animation-delay: 0.6s; }

        .animate-fade {
            animation: fade-in 1s ease-out;
        }

        .animate-shake {
            animation: shake-screen 0.4s ease-in-out;
        }

        .animate-heartbeat {
            animation: heartbeat 1.5s infinite;
        }

        .animate-glow {
            animation: glow-pulse 2s ease-in-out infinite;
        }

        .animate-particle {
            animation: particle-float 5s ease-in-out infinite;
        }

        @keyframes enemy-float {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 1; }
            25% { transform: translateY(-8px) translateX(5px); opacity: 0.9; }
            50% { transform: translateY(-3px) translateX(-5px); opacity: 1; }
            75% { transform: translateY(-10px) translateX(-2px); opacity: 0.85; }
        }
        @keyframes enemy-pulse {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 8px rgba(239, 68, 68, 0.5)); }
            50% { transform: scale(1.15); filter: drop-shadow(0 0 20px rgba(239, 68, 68, 0.8)); }
        }
        .enemy-float { animation: enemy-float 2s ease-in-out infinite; }
        .enemy-pulse { animation: enemy-pulse 1.5s ease-in-out infinite; }

        /* UI */
        .glass-panel {
            background: rgba(10, 10, 20, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .item-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .typewriter::after {
            content: '|';
            animation: blink 1s infinite;
        }

        /* Evitar que se corten las primeras letras del texto */
        .text-story {
            padding: 0 1.5rem;
            overflow: visible;
            min-width: 0;
            box-sizing: border-box;
            width: 100%;
        }
        .text-story p {
            padding-left: 0.5rem;
            overflow: visible;
            word-wrap: break-word;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        /* FONDOS TEMÁTICOS */
        .bg-start {
            background: radial-gradient(circle at 50% 50%, #1e293b 0%, #020617 100%);
        }

        .bg-forest {
            background: radial-gradient(circle at 50% 30%, #064e3b 0%, #020617 90%);
        }

        .bg-river {
            background: radial-gradient(circle at 50% 70%, #1e3a8a 0%, #020617 80%);
        }

        .bg-ruins {
            background: radial-gradient(circle at 50% 50%, #7c2d12 0%, #020617 90%);
        }

        .bg-boss {
            background: radial-gradient(circle at 50% 50%, #7f1d1d 0%, #000000 80%);
        }

        /* BOTONES */
        .btn-rpg {
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .btn-rpg:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(251, 191, 36, 0.2);
        }

        .btn-rpg:active {
            transform: translateY(0);
        }
    </style>
</head>

<body class="h-screen w-screen overflow-hidden">
    <audio id="bg-music" loop>
        <source src="https://cdn.pixabay.com/audio/2021/10/25/audio_4b2de670f2.mp3" type="audio/mpeg">
    </audio>

    <div id="header-container"></div>

    <div id="root" class="w-full h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- AUDIO ENGINE ---
        class AudioEngine {
            constructor() {
                this.ctx = null;
                this.bgNodes = [];
                this.isMuted = false;
            }

            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.ctx.state === 'suspended') this.ctx.resume();
            }

            playTone(freq, type, duration, vol = 0.1, slideTo = null) {
                if (this.isMuted) return;
                this.init();
                const t = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, t);
                if (slideTo) osc.frequency.exponentialRampToValueAtTime(slideTo, t + duration);
                gain.gain.setValueAtTime(vol, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start(t);
                osc.stop(t + duration);
            }

            sfx = {
                click: () => this.playTone(800, 'sine', 0.05, 0.05),
                hover: () => this.playTone(300, 'triangle', 0.05, 0.02),
                step: () => this.playTone(100, 'noise', 0.1, 0.1), // Placeholder for noise
                item: () => {
                    [600, 800, 1200].forEach((f, i) => setTimeout(() => this.playTone(f, 'sine', 0.2, 0.1), i * 100));
                },
                damage: () => {
                    this.playTone(150, 'sawtooth', 0.3, 0.3, 50);
                },
                heal: () => {
                    [400, 500, 600].forEach((f, i) => setTimeout(() => this.playTone(f, 'sine', 0.5, 0.05), i * 150));
                },
                win: () => {
                    [440, 554, 659, 880, 440, 554, 659, 880].forEach((f, i) => setTimeout(() => this.playTone(f, 'square', 0.2, 0.1), i * 100));
                }
            }

            startAmbience() {
                if (this.bgNodes.length > 0 || this.isMuted) return;
                this.init();
                const osc = this.ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.value = 60;
                const gain = this.ctx.createGain();
                gain.gain.value = 0.03;
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                this.bgNodes.push(osc);
            }
        }
        const audio = new AudioEngine();

        // --- CONTENIDO: Aventura A2 con lógica, acertijos y combates ---
        // Items: 'torch', 'key'

        const STORY = {
            'start': {
                id: 'start',
                bg: 'bg-start',
                icon: 'fa-dungeon',
                text: "Despiertas en una cueva húmeda. La memoria te falla. Solo una tenue luz al final del túnel te guía. (Nivel: A2)",
                options: [{ text: "Avanzar con cautela", next: 's2_crossroads' }]
            },
            's2_crossroads': {
                id: 's2_crossroads',
                bg: 'bg-start',
                icon: 'fa-signs-post',
                text: "El camino se divide. A la izquierda, escuchas el eco de una corriente de agua. A la derecha, un silencio sepulcral.",
                options: [
                    { text: "Seguir el sonido del agua (Izquierda)", next: 's3_river' },
                    { text: "Adentrarse en el silencio (Derecha)", next: 's3_dry' }
                ]
            },
            's3_river': {
                id: 's3_river',
                bg: 'bg-river',
                icon: 'fa-water',
                type: 'puzzle',
                text: "Un río bloquea tu paso. Hay piedras grabadas en la orilla. Forma una frase correcta en PASADO para crear un puente mágico.",
                solution: ["Ayer", "perdí", "mi", "mapa", "aquí"],
                words: ["mapa", "perdí", "Ayer", "aquí", "pierdo", "mi"],
                successMsg: "Las piedras flotan y forman un camino seguro.",
                next: 's4_camp'
            },
            's3_dry': {
                id: 's3_dry',
                bg: 'bg-start',
                icon: 'fa-bat',
                type: 'combat',
                enemyName: "Enjambre de Murciélagos",
                text: "¡El techo se mueve! Para espantarlos, debes recordar lo que pasó antes. Usa los tiempos del pasado.",
                hp: 3,
                topic: 'past_tenses',
                next: 's4_camp'
            },
            's4_camp': {
                id: 's4_camp',
                bg: 'bg-ruins',
                icon: 'fa-campground',
                type: 'rest',
                item: 'torch',
                text: "Hallas los restos de un campamento abandonado. Recoges una antorcha que misteriosamente sigue ardiendo. Tu fuerza se recupera.",
                heal: true,
                options: [{ text: "Tomar la antorcha y continuar", next: 's4b_sala' }]
            },
            's4b_sala': {
                id: 's4b_sala',
                bg: 'bg-ruins',
                icon: 'fa-map',
                text: "Frente a ti hay dos túneles. Uno parece una antigua biblioteca en ruinas. El otro desciende hacia la oscuridad total.",
                options: [
                    { text: "Entrar a la biblioteca en ruinas", next: 's4c_mapas' },
                    { text: "Bajar a la oscuridad", next: 's5_dark_tunnel' }
                ]
            },
            's4c_mapas': {
                id: 's4c_mapas',
                bg: 'bg-forest',
                icon: 'fa-book-dead',
                type: 'logic',
                text: "(Nivel B1) Lees el diario de un explorador: «Si hubiera sabido que el dragón escupía veneno, no habría venido sin la máscara.» ¿Qué significa esto?",
                correct: "Vino sin la máscara porque no sabía lo del veneno.",
                options: [
                    "Sabía lo del veneno, pero olvidó la máscara.",
                    "Vino sin la máscara porque no sabía lo del veneno.",
                    "Trajo la máscara porque sabía lo del veneno.",
                    "No vino porque el dragón escupía veneno."
                ],
                next: 's4d_logic'
            },
            's4d_logic': {
                id: 's4d_logic',
                bg: 'bg-forest',
                icon: 'fa-brain',
                type: 'logic',
                text: "En la pared hay otro enigma: «Salgo de la ciudad pero nunca me muevo. Conecto casas, pero no tengo puertas.» ¿Qué soy?",
                correct: "La calle / La carretera",
                options: ["El coche", "El río", "La calle / La carretera", "El mapa"],
                next: 's5_dark_tunnel'
            },
            's5_dark_tunnel': {
                id: 's5_dark_tunnel',
                bg: 'bg-start',
                icon: 'fa-eye-slash',
                text: "Una oscuridad antinatural envuelve el pasillo. No puedes ver ni tus propias manos.",
                checkItem: 'torch',
                itemSuccess: { text: "La luz de tu antorcha revela unas estacas afiladas en el suelo. Las esquivas con cuidado.", next: 's6_ruins' },
                itemFail: { text: "Caminas a ciegas y caes sobre unas rocas afiladas. Te lastimas, pero logras arrastrarte fuera.", damage: 1, next: 's6_ruins' }
            },
            's6_ruins': {
                id: 's6_ruins',
                bg: 'bg-ruins',
                icon: 'fa-archway',
                text: "Llegas a la puerta de una cripta. Un Guardián de Piedra bloquea el paso. Sus ojos brillan.",
                options: [
                    { text: "Intentar responder a su acertijo", next: 's7_skeleton_riddle' },
                    { text: "Atacar al Guardián", next: 's7_combat_skeleton' }
                ]
            },
            's7_skeleton_riddle': {
                id: 's7_skeleton_riddle',
                bg: 'bg-ruins',
                icon: 'fa-monument',
                type: 'riddle',
                text: "El Guardián habla: «Te digo qué hacer pero no tengo voz. Tengo mares sin agua y ciudades sin gente. ¿Qué soy?»",
                correct: "Un mapa",
                options: ["Un libro", "Un mapa", "El viento", "Un espíritu"],
                next: 's7b_logic'
            },
            's7b_logic': {
                id: 's7b_logic',
                bg: 'bg-ruins',
                icon: 'fa-balance-scale',
                type: 'logic',
                text: "«Una prueba más», dice el Guardián. «¿Qué oración expresa una DUDA correctamente en español?»",
                correct: "Dudo que mañana haga buen tiempo.",
                options: [
                    "Dudo que mañana hace buen tiempo.",
                    "Dudo que mañana hará buen tiempo.",
                    "Dudo que mañana haga buen tiempo.",
                    "Dudo si mañana hace buen tiempo."
                ],
                next: 's8_lab'
            },
            's7_combat_skeleton': {
                id: 's7_combat_skeleton',
                bg: 'bg-ruins',
                icon: 'fa-khanda',
                type: 'combat',
                enemyName: "Guardián de Piedra",
                text: "El Guardián te ataca. Debes defenderte usando pronombres avanzados.",
                hp: 3,
                topic: 'pronouns_b1',
                next: 's8_lab'
            },
            's8_lab': {
                id: 's8_lab',
                bg: 'bg-ruins',
                icon: 'fa-flask',
                text: "Entras al laboratorio del antiguo alquimista. Sobre una mesa de obsidiana hay dos objetos. Solo tienes tiempo de coger uno antes de que la sala colapse.",
                options: [
                    { text: "Coger la llave de cristal", getItem: 'key', next: 's8b_logic' },
                    { text: "Beber el elixir carmesí (curación)", heal: true, next: 's8b_logic' }
                ]
            },
            's8b_logic': {
                id: 's8b_logic',
                bg: 'bg-ruins',
                icon: 'fa-box',
                type: 'logic',
                text: "Una puerta mágica te hace una pregunta lógica: «Si Ana es más alta que Beatriz, y Beatriz es más alta que Carmen... ¿Es Carmen más alta que Ana?»",
                correct: "No, Carmen es la más baja.",
                options: ["Sí, Carmen es más alta.", "No, Carmen es la más baja.", "Son de la misma altura.", "Falta información."],
                next: 's9_hallway'
            },
            's9_hallway': {
                id: 's9_hallway',
                bg: 'bg-start',
                icon: 'fa-wind',
                type: 'logic',
                text: "Un Espectro aparece de la nada y exige saber: «¿Qué frase condicional es correcta?»",
                correct: "Si tuviera dinero, viajaría por el mundo.",
                options: [
                    "Si tengo dinero, viajaría por el mundo.",
                    "Si tendría dinero, viajaré por el mundo.",
                    "Si tuviera dinero, viajaría por el mundo.",
                    "Si tuviera dinero, viajo por el mundo."
                ],
                next: 's9b_combat'
            },
            's9b_combat': {
                id: 's9b_combat',
                bg: 'bg-start',
                icon: 'fa-ghost',
                type: 'combat',
                enemyName: "Espectro de las Sombras",
                text: "El espectro se enfurece. ¡Derrótalo usando el subjuntivo y condicional!",
                hp: 3,
                topic: 'subjunctive',
                next: 's10_locked_door'
            },
            's10_locked_door': {
                id: 's10_locked_door',
                bg: 'bg-ruins',
                icon: 'fa-door-closed',
                text: "Una inmensa puerta de cristal te separa de la salida. No tiene manija, solo una cerradura mágica.",
                checkItem: 'key',
                itemSuccess: { text: "La llave de cristal encaja perfectamente. La puerta se desvanece.", next: 's12_boss_intro' },
                itemFail: { text: "Sin la llave, debes golpear el cristal hasta romperlo. Los cristales te hieren gravemente.", damage: 2, next: 's12_boss_intro' }
            },
            's12_boss_intro': {
                id: 's12_boss_intro',
                bg: 'bg-boss',
                icon: 'fa-dragon',
                text: "Sientes el viento del exterior. ¡Casi eres libre! Pero un gigantesco Dragón de las Palabras desciende del techo. «Nadie escapa sin dominar el subjuntivo», ruge.",
                options: [{ text: "¡Lucha por tu libertad!", next: 's13_boss_p1' }]
            },
            's13_boss_p1': {
                id: 's13_boss_p1',
                bg: 'bg-boss',
                icon: 'fa-fire-flame-curved',
                type: 'combat',
                enemyName: "Dragón (Fase 1)",
                text: "El dragón te lanza ráfagas de fuego lingüístico. ¡Responde rápido!",
                hp: 4,
                topic: 'subjunctive',
                next: 's14_boss_p2'
            },
            's14_boss_p2': {
                id: 's14_boss_p2',
                bg: 'bg-boss',
                icon: 'fa-wand-magic-sparkles',
                type: 'puzzle',
                text: "El dragón está herido pero prepara su ataque final. Ordena este hechizo usando el subjuntivo para sellarlo para siempre.",
                solution: ["Es", "imposible", "que", "tú", "me", "venzas"],
                words: ["imposible", "que", "venzas", "tú", "me", "Es", "vences"],
                successMsg: "¡La magia de tus palabras silencia al dragón! La cueva se abre.",
                next: 'victory'
            },
            'victory': { type: 'win' },
            'gameover': { type: 'lose' }
        };

        const QUESTIONS = {
            past_tenses: [
                { q: "Ayer, mientras yo ____ (caminar) por el bosque, vi una luz.", correct: "caminaba", opts: ["caminé", "camino", "caminaría"] },
                { q: "El año pasado, nosotros ____ (ir) a España de vacaciones.", correct: "fuimos", opts: ["íbamos", "vamos", "fueron"] },
                { q: "Cuando era niño, siempre ____ (jugar) en la calle.", correct: "jugaba", opts: ["jugué", "juego", "jugaría"] },
                { q: "Anoche no ____ (poder - yo) dormir por el ruido.", correct: "pude", opts: ["podía", "puedo", "podré"] }
            ],
            pronouns_b1: [
                { q: "¿Le diste el mapa al guía? Sí, ya ___ ___ di.", correct: "se lo", opts: ["le lo", "te lo", "me lo"] },
                { q: "¡No ___ ___ digas a nadie! Es un secreto.", correct: "se lo", opts: ["le lo", "lo le", "te le"] },
                { q: "¿Tienes las llaves? Por favor, ____.", correct: "dámelas", opts: ["dáselas", "médalas", "dálemelas"] },
                { q: "Estaba leyendo el libro, pero mi hermano ___ ___ quitó.", correct: "me lo", opts: ["se lo", "te lo", "nos lo"] }
            ],
            subjunctive: [
                { q: "Dudo que el dragón ____ (estar) dormido.", correct: "esté", opts: ["está", "estuvo", "estaba"] },
                { q: "Te daré el tesoro cuando ____ (llegar) a la salida.", correct: "llegues", opts: ["llegas", "llegaste", "llegarás"] },
                { q: "Si tuviera una espada más grande, te ____ (vencer).", correct: "vencería", opts: ["venceré", "venzo", "vencí"] },
                { q: "Es importante que nosotros no ____ (hacer) ruido.", correct: "hagamos", opts: ["hacemos", "hicimos", "haremos"] },
                { q: "Me pidió que le ____ (ayudar) con la puerta.", correct: "ayudara", opts: ["ayudo", "ayudaré", "ayudaba"] }
            ]
        };

        // --- COMPONENTES ---

        const Typewriter = ({ text, speed = 20, instant = false }) => {
            const [display, setDisplay] = useState(instant ? text : '');
            useEffect(() => {
                if (instant) {
                    setDisplay(text);
                    return;
                }
                setDisplay('');
                let i = 0;
                const t = setInterval(() => {
                    if (i < text.length) {
                        setDisplay(prev => prev + text.charAt(i));
                        i++;
                        if (i % 3 === 0) audio.sfx.click();
                    } else clearInterval(t);
                }, speed);
                return () => clearInterval(t);
            }, [text, instant]);
            return (
                <div className="text-story w-full max-w-xl px-4">
                    <p className={`text-xl md:text-2xl text-slate-200 leading-relaxed min-h-[80px] ${instant ? '' : 'typewriter'}`} style={{ fontFamily: 'Metamorphous, serif' }}>{display}</p>
                </div>
            );
        };

        const RuneGame = ({ puzzle, onWin, onFail }) => {
            const [slots, setSlots] = useState(Array(puzzle.solution.length).fill(null));
            const [pool, setPool] = useState(puzzle.words.map((w, i) => ({ id: i, w, active: true })));

            const clickPool = (item) => {
                if (!item.active) return;
                const emptyIdx = slots.indexOf(null);
                if (emptyIdx === -1) return;
                audio.playTone(800 + (emptyIdx * 100), 'sine', 0.1);
                const newSlots = [...slots]; newSlots[emptyIdx] = item; setSlots(newSlots);
                setPool(pool.map(p => p.id === item.id ? { ...p, active: false } : p));
            };

            const reset = () => {
                setSlots(Array(puzzle.solution.length).fill(null));
                setPool(puzzle.words.map((w, i) => ({ id: i, w, active: true })));
                onFail(); audio.sfx.damage();
            };

            const check = () => {
                if (slots.map(s => s ? s.w : '').join(' ') === puzzle.solution.join(' ')) {
                    audio.sfx.item(); onWin();
                } else reset();
            };

            return (
                <div className="w-full max-w-xl animate-enter">
                    <div className="flex flex-wrap gap-2 justify-center mb-6 min-h-[60px] p-4 glass-panel rounded-xl">
                        {slots.map((s, i) => (
                            <div key={i} className="border-b-2 border-slate-500 min-w-[5rem] flex-1 flex items-center justify-center text-amber-400 font-bold px-2">{s ? s.w : ''}</div>
                        ))}
                    </div>
                    <div className="flex flex-wrap justify-center gap-4 mb-8">
                        {pool.map((p) => (
                            <button key={p.id} disabled={!p.active} onClick={() => clickPool(p)} className={`px-6 py-3 rounded-lg font-bold border-2 transition-all ${p.active ? 'bg-slate-800 border-amber-600 hover:scale-105' : 'opacity-20 border-transparent'}`}>{p.w}</button>
                        ))}
                    </div>
                    <div className="flex justify-center gap-4">
                        <button onClick={check} className="bg-amber-600 hover:bg-amber-500 text-black font-bold px-8 py-3 rounded-lg">Invocar</button>
                        <button onClick={reset} className="bg-slate-700 text-white px-4 py-3 rounded-lg"><i className="fas fa-undo"></i></button>
                    </div>
                </div>
            );
        };

        const CombatGame = ({ type, enemy, hp, maxHp, onDamage, onWin }) => {
            const [q, setQ] = useState(null);

            const nextQ = useCallback(() => {
                const list = QUESTIONS[type] || QUESTIONS.past_tenses;
                const item = list[Math.floor(Math.random() * list.length)];
                setQ({ ...item, mixedOpts: [item.correct, ...item.opts].sort(() => Math.random() - 0.5) });
            }, [type]);

            useEffect(() => { nextQ(); }, [nextQ]);

            const answer = (txt) => {
                if (txt === q.correct) {
                    audio.sfx.hover();
                    setTimeout(() => { onWin(); nextQ(); }, 200);
                } else {
                    audio.sfx.damage(); onDamage();
                }
            };

            if (!q) return <div>Cargando...</div>;

            return (
                <div className="w-full max-w-lg animate-enter px-3">
                    <div className="glass-panel p-6 rounded-xl border-l-4 border-red-500 mb-6 relative overflow-visible">
                        <div className="absolute top-0 right-0 p-2 text-xs text-red-400 font-tech">ENEMIGO: {enemy}</div>
                        <div className="text-center text-xl mb-6 mt-4 px-4 font-[Metamorphous]" style={{ fontFamily: 'Metamorphous, serif' }}>
                            {q.q.split('____').map((part, i) => <span key={i}>{part}{i === 0 && <span className="text-amber-400 border-b-2 border-amber-400 px-1 font-bold">_____</span>}</span>)}
                        </div>
                        <div className="grid grid-cols-2 gap-4 animate-enter-stagger">
                            {q.mixedOpts.map((opt, i) => (
                                <button key={i} onClick={() => answer(opt)} className="p-4 bg-slate-800 border border-slate-600 hover:border-amber-400 rounded-lg font-bold transition-all hover:scale-[1.02]">{opt}</button>
                            ))}
                        </div>
                    </div>
                    <div className="w-full bg-slate-900 h-4 rounded-full overflow-hidden border border-slate-700">
                        <div className="h-full bg-red-600 transition-all duration-300" style={{ width: `${(hp / maxHp) * 100}%` }}></div>
                    </div>
                </div>
            );
        };

        // --- GAME CONTROLLER ---
        const Game = () => {
            const [nodeId, setNodeId] = useState(null);
            const [hp, setHp] = useState(5);
            const [items, setItems] = useState([]);
            const [overlay, setOverlay] = useState(null);
            const [subProgress, setSubProgress] = useState(0);
            const [musicOn, setMusicOn] = useState(true);

            const currentNode = STORY[nodeId];

            const toggleMusic = () => {
                const bgMusic = document.getElementById('bg-music');
                if (!bgMusic) return;
                const next = !musicOn;
                setMusicOn(next);
                if (next) {
                    bgMusic.volume = 0.25;
                    bgMusic.play().catch(() => {});
                } else {
                    bgMusic.pause();
                }
            };

            const start = () => {
                setNodeId('start');
                setHp(5);
                setItems([]);
                setSubProgress(0);
                const bgMusic = document.getElementById('bg-music');
                if (bgMusic && musicOn) {
                    bgMusic.volume = 0.25;
                    bgMusic.play().catch(e => console.log("El navegador bloqueó el autoplay", e));
                } else if (bgMusic && !musicOn) {
                    bgMusic.pause();
                }
                audio.startAmbience();
            };

            // Item check: el daño solo se aplica al pulsar "Continuar", no al entrar al nodo

            const takeDamage = (amount = 1) => {
                setOverlay('damage');
                setTimeout(() => setOverlay(null), 500);
                setHp(prev => {
                    const n = prev - amount;
                    if (n <= 0) {
                        audio.sfx.damage();
                        setNodeId('gameover');
                    }
                    return n;
                });
            };

            const heal = () => {
                setOverlay('heal');
                setTimeout(() => setOverlay(null), 500);
                audio.sfx.heal();
                setHp(prev => Math.min(prev + 1, 5));
            };

            const handleChoice = (opt) => {
                if (opt.getItem) {
                    setItems([...items, opt.getItem]);
                    audio.sfx.item();
                }
                if (opt.heal) heal();

                audio.sfx.step();
                setSubProgress(0);
                setNodeId(opt.next);
            };

            const handleRiddle = (txt) => {
                if (txt === currentNode.correct) {
                    audio.sfx.item();
                    setNodeId(currentNode.next);
                } else {
                    takeDamage(1);
                    audio.sfx.damage();
                }
            };

            const handleLogic = (txt) => {
                if (txt === currentNode.correct) {
                    audio.sfx.item();
                    setNodeId(currentNode.next);
                } else {
                    takeDamage(1);
                    audio.sfx.damage();
                }
            };

            // Item Check Special Render
            const renderItemCheck = () => {
                const hasItem = items.includes(currentNode.checkItem);
                const outcome = hasItem ? currentNode.itemSuccess : currentNode.itemFail;
                return (
                    <div className="max-w-xl text-center animate-enter">
                        <div className="text-4xl mb-4">{hasItem ? '✨' : '⚠️'}</div>
                        <Typewriter text={outcome.text} instant={true} />
                        <button
                            onClick={() => {
                                if (outcome.damage) takeDamage(outcome.damage);
                                setNodeId(outcome.next);
                            }}
                            className="mt-8 btn-rpg px-8 py-3 bg-slate-700 rounded-lg"
                        >
                            Continuar
                        </button>
                    </div>
                );
            };

            if (!currentNode && !nodeId) {
                return (
                    <div className="w-full h-full flex flex-col items-center justify-center bg-black bg-start text-center p-4 relative">
                        <button type="button" onClick={toggleMusic} className="absolute top-4 right-4 w-12 h-12 rounded-full bg-slate-800/80 border border-slate-600 flex items-center justify-center text-slate-300 hover:text-amber-400 hover:border-amber-500 transition-colors z-10" title={musicOn ? "Silenciar música" : "Activar música"}>
                            <i className={`fas text-xl ${musicOn ? "fa-volume-up" : "fa-volume-mute"}`}></i>
                        </button>
                        <i className="fas fa-mountain text-8xl text-slate-600 mb-4 animate-float"></i>
                        <h1 className="text-6xl md:text-8xl text-amber-500 font-cinzel mb-2 animate-float">ESCAPE</h1>
                        <h2 className="text-2xl text-slate-400 font-cinzel mb-12">La Gran Odisea</h2>
                        <button onClick={start} className="bg-amber-700 hover:bg-amber-600 text-white font-bold py-4 px-12 rounded-full animate-pulse transition-transform hover:scale-105">COMENZAR AVENTURA</button>
                        <p className="mt-4 text-slate-500 text-sm">Nivel A2 → B1 • Pasados, pronombres, subjuntivo y condicional • ~25 min</p>
                    </div>
                );
            }

            if (currentNode?.type === 'lose') return (
                <div className="w-full h-full bg-red-950/95 flex flex-col items-center justify-center animate-shake">
                    <i className="fas fa-skull text-8xl text-red-400 mb-6 animate-float"></i>
                    <h2 className="text-5xl md:text-6xl text-white font-cinzel">Has perdido</h2>
                    <p className="text-slate-300 mt-4 text-lg">La cueva te ha vencido. Pero puedes intentarlo otra vez.</p>
                    <button onClick={start} className="mt-10 px-8 py-4 bg-red-700 hover:bg-red-600 text-white rounded-xl font-bold transition-all hover:scale-105">Reintentar</button>
                </div>
            );

            if (currentNode?.type === 'win') return (
                <div className="w-full h-full bg-gradient-to-b from-amber-950/30 to-slate-900 flex flex-col items-center justify-center animate-fade">
                    <i className="fas fa-trophy text-8xl text-amber-400 mb-6 animate-float"></i>
                    <h2 className="text-5xl md:text-7xl text-amber-400 font-cinzel animate-glow">¡Victoria!</h2>
                    <p className="text-xl text-slate-300 mt-6 max-w-md text-center">Has escapado de la cueva. Has usado bien el español y la lógica. Enhorabuena.</p>
                    <button onClick={start} className="mt-10 px-8 py-4 bg-amber-600 hover:bg-amber-500 text-black font-bold rounded-xl transition-all hover:scale-105">Jugar de nuevo</button>
                </div>
            );

            return (
                <div className={`relative w-full h-full flex flex-col p-4 md:p-8 transition-colors duration-1000 ${currentNode.bg || 'bg-black'}`}>
                    {overlay === 'damage' && <div className="absolute inset-0 bg-red-500/30 z-50 pointer-events-none animate-shake"></div>}
                    {overlay === 'heal' && <div className="absolute inset-0 bg-green-500/20 z-50 pointer-events-none animate-fade"></div>}

                    {/* HUD */}
                    <div className="flex justify-between items-start mb-4 z-10">
                        <div>
                            <div className="flex gap-1 mb-2">
                                {[...Array(5)].map((_, i) => <i key={i} className={`fas fa-heart text-xl ${i < hp ? 'text-red-500' : 'text-slate-800'}`}></i>)}
                            </div>
                            <div className="flex gap-2 text-xl text-amber-400">
                                {items.includes('torch') && <i className="fas fa-fire" title="Antorcha"></i>}
                                {items.includes('key') && <i className="fas fa-key" title="Llave"></i>}
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <button type="button" onClick={toggleMusic} className="w-10 h-10 rounded-full bg-slate-800/80 border border-slate-600 flex items-center justify-center text-slate-400 hover:text-amber-400 hover:border-amber-500 transition-colors" title={musicOn ? "Silenciar música" : "Activar música"}>
                                <i className={`fas ${musicOn ? "fa-volume-up" : "fa-volume-mute"}`}></i>
                            </button>
                            <div className="text-xs text-slate-500 font-tech border border-slate-700 px-2 py-1 rounded bg-black/50">
                                SECCIÓN: {nodeId.toUpperCase()}
                            </div>
                        </div>
                    </div>

                    {/* Partículas de ambiente */}
                    <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">
                        {[...Array(6)].map((_, i) => (
                            <div key={i} className="absolute w-2 h-2 rounded-full bg-amber-500/20 animate-particle" style={{ left: `${15 + i * 15}%`, top: `${20 + (i % 3) * 25}%`, animationDelay: `${i * 0.5}s` }}></div>
                        ))}
                    </div>

                    {/* SCENE */}
                    <div className="flex-1 flex flex-col items-center justify-center relative z-0">
                        {/* Check Item Logic Overlay */}
                        {currentNode.checkItem ? (
                            renderItemCheck()
                        ) : (
                            <>
                                <div className="relative mb-8">
                                    {currentNode.type === 'combat' && (
                                        <>
                                            <i className={`fas ${currentNode.icon} text-6xl absolute -top-2 -left-4 text-red-400/60 enemy-float`} style={{ animationDelay: '0s' }}></i>
                                            <i className={`fas ${currentNode.icon} text-5xl absolute -top-4 right-0 text-red-400/50 enemy-float`} style={{ animationDelay: '0.5s' }}></i>
                                            <i className={`fas ${currentNode.icon} text-4xl absolute top-2 -right-6 text-red-400/40 enemy-float`} style={{ animationDelay: '1s' }}></i>
                                        </>
                                    )}
                                    <i className={`fas ${currentNode.icon} text-8xl text-slate-300 ${currentNode.type === 'combat' ? 'text-red-400 enemy-pulse' : 'animate-float'}`}></i>
                                </div>

                                <div className="w-full flex justify-center min-h-[40vh] overflow-visible">

                                    {/* NARRATIVE */}
                                    {(!currentNode.type || currentNode.type === 'rest') && (
                                        <div className="max-w-xl w-full flex flex-col items-center animate-enter text-center px-4">
                                            <Typewriter text={currentNode.text} instant={true} />
                                            {currentNode.heal && <div className="text-green-400 mt-2 font-mono text-sm animate-fade">+1 VIDA RECUPERADA</div>}
                                            <div className="mt-8 w-full grid gap-4 animate-enter-stagger">
                                                {currentNode.options.map((opt, i) => (
                                                    <button key={i} onClick={() => handleChoice(opt)} className="btn-rpg w-full p-4 bg-slate-800/90 border border-slate-600 rounded-xl text-lg hover:border-amber-400 hover:scale-[1.02] text-left transition-all duration-300">
                                                        {opt.text}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* PUZZLE */}
                                    {currentNode.type === 'puzzle' && (
                                        <div className="flex flex-col items-center w-full">
                                            <p className="mb-6 text-slate-300 text-center max-w-lg px-4">{currentNode.text}</p>
                                            <RuneGame puzzle={currentNode} onWin={() => { setOverlay('heal'); setNodeId(currentNode.next); }} onFail={() => takeDamage(1)} />
                                        </div>
                                    )}

                                    {/* COMBAT */}
                                    {currentNode.type === 'combat' && (
                                        <CombatGame
                                            type={currentNode.topic} enemy={currentNode.enemyName}
                                            hp={currentNode.hp - subProgress} maxHp={currentNode.hp}
                                            onDamage={() => takeDamage(1)}
                                            onWin={() => setSubProgress(p => {
                                                const n = p + 1;
                                                if (n >= currentNode.hp) { audio.sfx.win(); setNodeId(currentNode.next); return 0; }
                                                return n;
                                            })}
                                        />
                                    )}

                                    {/* RIDDLE */}
                                    {currentNode.type === 'riddle' && (
                                        <div className="max-w-xl w-full flex flex-col items-center animate-enter text-center px-4">
                                            <Typewriter text={currentNode.text} instant={true} />
                                            <div className="grid grid-cols-2 gap-4 mt-8 w-full animate-enter-stagger">
                                                {currentNode.options.map((opt, i) => (
                                                    <button key={i} onClick={() => handleRiddle(opt)} className="btn-rpg p-4 bg-slate-800 border border-slate-600 rounded-lg hover:border-amber-400 hover:bg-slate-700">{opt}</button>
                                                ))}
                                            </div>
                                        </div>
                                    )}

                                    {/* LÓGICA (situación + respuesta correcta) */}
                                    {currentNode.type === 'logic' && (
                                        <div className="max-w-xl w-full flex flex-col items-center animate-enter text-center px-4">
                                            <div className="mb-4 text-amber-300/80 text-sm font-tech flex items-center gap-2">
                                                <i className="fas fa-brain"></i> Piensa y elige la respuesta lógica
                                            </div>
                                            <Typewriter text={currentNode.text} instant={true} />
                                            <div className="grid grid-cols-2 gap-4 mt-8 w-full animate-enter-stagger">
                                                {currentNode.options.map((opt, i) => (
                                                    <button key={i} onClick={() => handleLogic(opt)} className="btn-rpg p-4 bg-slate-800/90 border border-slate-600 rounded-xl hover:border-amber-400 hover:bg-slate-700 text-left">{opt}</button>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Game />);
    </script>

  <script>
    fetch('/nav.html').then(function(r){ return r.text(); }).then(function(data){
      var el = document.getElementById('header-container');
      if (el) {
      el.innerHTML = data;
      var scripts = el.querySelectorAll('script');
      for (var i = 0; i < scripts.length; i++) {
        var sc = scripts[i];
        var ns = document.createElement('script');
        if (sc.src) ns.src = sc.src; else ns.textContent = sc.textContent;
        document.body.appendChild(ns);
      }
    }
    });
  </script>

</body>

</html>