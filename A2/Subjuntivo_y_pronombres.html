<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Tucaneo A2: Fundamentos Num√©ricos (Tropical)</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/theme/white.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;700&family=Handlee&display=swap"
        rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* =========================================
       1. VARIABLES Y BASE (VISIBILIDAD ALTA)
       ========================================= */
        :root {
            --primary: #004d40;
            --accent: #ff6f00;
            --text-main: #0f172a;
            /* Texto casi negro para m√°ximo contraste */
            --text-secondary: #334155;
            /* Gris oscuro (antes era muy claro) */
            --bg-light: #fefce8;
            --danger: #ef4444;
        }

        /* Mantenemos la magia del Zoom Nativo */
        html,
        body {
            background-color: var(--bg-light);
            font-family: 'Lato', sans-serif;
            height: 100%;
            overflow-y: auto !important;
            /* CR√çTICO: NO BORRAR */
        }

        /* =========================================
       2. REVEAL.JS - TIPOGRAF√çA (COMPACTA Y LEGIBLE)
       ========================================= */
        /* Bajamos un poco la base para que no se sienta "gigante" */
        .reveal {
            color: var(--text-main);
            font-size: 28px;
            font-weight: 500;
        }

        /* T√≠tulos */
        .reveal h1 {
            font-size: 2.5em !important;
            line-height: 1.1 !important;
            color: var(--primary);
            margin-bottom: 0.5em !important;
        }

        /* --- SKELETON FIX: ENFORCE TAILWIND COLORS --- */
        /* Overrides Reveal.js specific selectors like '.reveal h1' */
        .reveal .text-white {
            color: #ffffff !important;
        }

        .reveal .text-slate-50 {
            color: #f8fafc !important;
        }

        .reveal .text-yellow-200 {
            color: #fef08a !important;
        }

        .reveal .text-yellow-300 {
            color: #fde047 !important;
        }

        .reveal .text-yellow-400 {
            color: #facc15 !important;
        }

        .reveal .text-emerald-100 {
            color: #d1fae5 !important;
        }

        .reveal .text-emerald-200 {
            color: #a7f3d0 !important;
        }


        .reveal h2 {
            font-size: 1.8em !important;
            color: var(--primary);
            font-weight: 800;
            margin-bottom: 0.6em !important;
        }

        .reveal h3 {
            font-size: 1.4em !important;
            font-weight: 700;
            color: var(--text-main);
        }

        /* SOLUCI√ìN AL TEXTO GRIS INVISIBLE */
        /* Forzamos un color mucho m√°s oscuro y un peso semi-negrita */
        .reveal .text-sm,
        .reveal .text-xs,
        .reveal .text-gray-400,
        .reveal .text-gray-500 {
            color: var(--text-secondary) !important;
            /* Gris Oscuro */
            font-weight: 600 !important;
            /* M√°s gordita la letra */
            opacity: 0.9 !important;
            /* Quitamos transparencias */
        }

        .reveal .text-sm {
            font-size: 0.85em !important;
        }

        .reveal .text-xs {
            font-size: 0.75em !important;
        }

        /* =========================================
       3. ESTILO DE TARJETAS (CORREGIDO Y SEGURO)
       ========================================= */
        /* Modificado para permitir colores de fondo (como el verde) */
        .glass-card {
            /* Eliminamos la orden agresiva de transparencia */
            backdrop-filter: blur(8px);
            /* Efecto borroso bonito */
            -webkit-backdrop-filter: blur(8px);
            /* Para Safari/iPhone */

            /* El resto lo dejamos que Tailwind lo controle en el HTML */
            width: 100%;
            margin: 0 auto;
        }

        /* Tarjetas internas: M√°s compactas y definidas */
        .card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }

        /* =========================================
       4. LAYOUT CONTROLADO (SCROLL + ARREGLO DE T√çTULOS)
       ========================================= */
        .reveal .slides {
            width: 100% !important;
            height: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
            pointer-events: none;
        }

        .reveal section {
            height: 100vh !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            display: block !important;

            /* AUMENT√â ESTO: 100px arriba para bajar todo y que respete el men√∫ */
            padding: 100px 20px 80px 20px !important;

            pointer-events: auto !important;
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch;
        }

        /* --- REGLA M√ÅGICA NUEVA --- */
        /* Esto obliga al contenido a empezar desde arriba, anulando el 'justify-center' de Tailwind */
        .reveal section>div {
            height: auto !important;
            /* Permite que crezca hacia abajo */
            min-height: 100% !important;
            display: flex !important;
            flex-direction: column !important;
            justify-content: flex-start !important;
            /* ¬°CLAVE! Alinea al inicio, no al centro */
        }

        /* AQU√ç EST√Å EL TRUCO DE LA PROPORCI√ìN: */
        .slide-container {
            width: 90% !important;
            max-width: 1200px !important;
            margin: 0 auto;
        }

        /* =========================================
       5. INPUTS VISIBLES (IGUAL QUE ANTES)
       ========================================= */
        .clean-input {
            width: 100%;
            background: #f8fafc;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            padding: 12px 16px;
            font-family: 'Handlee', cursive;
            font-size: 1.1em;
            color: var(--primary) !important;
            font-weight: bold;
            outline: none;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.02);
        }

        .clean-input:focus {
            border-color: var(--accent);
            background: #fff;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .clean-input::placeholder {
            color: #64748b !important;
            font-family: 'Lato', sans-serif;
            font-size: 0.9em;
            font-weight: 500;
        }

        /* =========================================
       6. UI Y UTILIDADES
       ========================================= */
        #tucaneo-drawer {
            position: fixed;
            top: 0;
            right: -150vw;
            width: 50vw;
            height: 100vh;
            background: #fff;
            z-index: 20000;
            box-shadow: -10px 0 50px rgba(0, 0, 0, 0.2);
            transition: right 0.4s;
            display: flex;
            flex-direction: column;
        }

        #tucaneo-drawer.is-open {
            right: 0 !important;
        }

        #safe-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 20001;
            background: var(--danger);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #fixed-logo {
            position: fixed;
            top: 30px;
            left: 40px;
            width: 100px;
            z-index: 5000;
        }

        #top-nav {
            position: fixed;
            top: 30px;
            right: 40px;
            z-index: 5000;
            display: flex;
            gap: 15px;
        }

        #floating-cta {
            position: fixed;
            bottom: 30px;
            left: 40px;
            z-index: 5000;
            font-size: 12px;
            color: var(--primary);
            font-weight: bold;
            opacity: 0.8;
            letter-spacing: 1px;
        }

        .nav-btn {
            padding: 8px 20px;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            font-weight: bold;
            font-size: 13px;
            text-decoration: none;
        }

        .nav-btn.zoom {
            display: none !important;
        }

        .nav-btn.download {
            background-color: var(--primary);
        }

        .nav-btn.exit {
            background-color: #64748b;
        }

        #scroll-progress {
            position: fixed;
            top: 0;
            left: 0;
            height: 6px;
            background: var(--accent);
            width: 0%;
            z-index: 9999;
        }

        #back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            cursor: pointer;
        }

        #back-to-top.visible {
            display: flex;
        }


        /* =========================================
       7. M√ìVIL: SOLUCI√ìN FINAL (SCROLL REAL)
       ========================================= */
        @media (max-width: 1024px) {

            /* 1. FORZAR SCROLL EN EL CUERPO (La clave para que baje) */

            /* --- ¬°ESTO HACE VISIBLES LOS EJERCICIOS! --- */
            .reveal .fragment {
                opacity: 1 !important;
                visibility: visible !important;
                transform: none !important;
                animation: none !important;
            }


            html,
            body {
                height: auto !important;
                min-height: 100% !important;
                overflow-y: scroll !important;
                /* Fuerza la barra de scroll */
                -webkit-overflow-scrolling: touch;
                /* Scroll suave en iPhone */
                position: relative !important;
            }

            /* 2. DESACTIVAR REVEAL.JS (Convertir en lista vertical) */
            .reveal {
                height: auto !important;
                overflow: visible !important;
                position: relative !important;
                touch-action: auto !important;
            }

            .reveal .slides {
                position: static !important;
                /* Deja de flotar */
                width: 100% !important;
                height: auto !important;
                display: flex !important;
                flex-direction: column !important;
                /* Apilar uno tras otro */
                padding: 20px 15px 150px 15px !important;
                /* Espacio extra abajo */
                transform: none !important;
                top: auto !important;
                left: auto !important;
                pointer-events: none;
                /* El contenedor no bloquea, los hijos s√≠ */
            }

            /* 3. CADA DIAPOSITIVA ES UN BLOQUE */
            .reveal section {
                display: block !important;
                opacity: 1 !important;
                visibility: visible !important;
                position: relative !important;
                top: auto !important;
                height: auto !important;
                min-height: auto !important;
                margin-bottom: 40px !important;
                /* Espacio entre diapositivas */
                pointer-events: auto !important;
                /* ¬°Habilitar interacci√≥n! */
                transform: none !important;
            }

            /* 4. ELEMENTOS INTERNOS (Para que no se salgan) */
            .slide-container,
            .card,
            .glass-card {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 20px !important;
                box-sizing: border-box !important;
            }

            /* 5. INPUTS FUNCIONALES */
            .clean-input {
                pointer-events: auto !important;
                z-index: 5000 !important;
                /* Asegurar que est√© encima */
                font-size: 16px !important;
                background: #fff !important;
                width: 100% !important;
            }

            /* 6. ARREGLAR GRILLAS (Todo en una columna) */
            .grid,
            .grid-cols-2,
            .md\:grid-cols-2,
            .lg\:grid-cols-12 {
                display: flex !important;
                flex-direction: column !important;
                gap: 20px !important;
            }

            /* 7. LIMPIEZA VISUAL */
            .mobile-grid-2 {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 15px !important;
            }

            .reveal h1 {
                font-size: 2.2em !important;
                margin-top: 20px !important;
            }

            .reveal img {
                max-height: 250px !important;
                width: auto !important;
                margin: 0 auto !important;
            }

            /* Ocultar controles de PC */
            #btn-zoom,
            .nav-btn.zoom,
            #premium-dock,
            .reveal .controls,
            .reveal .progress {
                display: none !important;
            }

            /* Ajustar barra superior */
            #fixed-logo {
                width: 60px;
                top: 10px;
                left: 10px;
            }

            #top-nav {
                top: 10px;
                right: 10px;
            }

            .nav-btn {
                width: 36px;
                height: 36px;
                padding: 0;
                justify-content: center;
            }

            .nav-btn span {
                display: none;
            }
        }

        /* --- PARCHE DE CONTRASTE (CORREGIDO) --- */

        /* Usamos este selector especial para que el navegador entienda el color hexadecimal */
        [class*="bg-[#004d40]"] h1,
        [class*="bg-[#004d40]"] h2,
        [class*="bg-[#004d40]"] h3,
        [class*="bg-[#004d40]"] p,
        [class*="bg-[#004d40]"] i,
        [class*="bg-[#004d40]"] span,
        [class*="bg-[#004d40]"] li,
        [class*="bg-[#004d40]"] .text-sm,
        [class*="bg-[#004d40]"] .text-xs,
        [class*="bg-[#004d40]"] .text-gray-400,
        [class*="bg-[#004d40]"] .text-gray-500 {
            color: #ffffff !important;
            /* BLANCO OBLIGATORIO */
            opacity: 1 !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }

        /* Tambi√©n aplicamos la correcci√≥n para el color primario de Tailwind */
        .bg-primary h1,
        .bg-primary h2,
        .bg-primary h3,
        .bg-primary p,
        .bg-primary span,
        .bg-primary i {
            color: #ffffff !important;
        }

        /* --- CORRECCI√ìN DEFINITIVA PARA FONDOS OSCUROS (DETECTIVE) --- */
        /* Esto asegura que cualquier texto dentro de un contenedor oscuro SEA BLANCO, sin importar la regla global */
        .bg-slate-800 .text-sm,
        .bg-slate-800 .text-xs,
        .bg-slate-800 p,
        .bg-slate-800 h1,
        .bg-slate-800 h2,
        .bg-slate-800 h3,
        .bg-slate-800 .italic {
            color: rgba(255, 255, 255, 0.95) !important;
            opacity: 1 !important;
        }

        /* Y para el texto espec√≠ficamente coloreado (como Clue #1 en esmeralda), lo respetamos pero brillando */
        .bg-slate-800 .text-emerald-400 {
            color: #34d399 !important;
            /* Verde brillante */
        }


        /* --- CRITICAL CONTRAST FIX FOR DARK CARDS (V2.1 - GLOBAL MANAGE) --- */
        /* Support for both .class on section AND data-state on parent */

        /* 1. SLATE DARK CARDS */
        .reveal [class*="bg-slate-800"],
        .reveal.bg-slate-800,
        /* data-state support */
        .reveal [class*="from-slate-800"],
        .reveal.from-slate-800,
        /* data-state support */
        .reveal [class*="from-gray-800"],
        .reveal [class*="from-zinc-800"],
        .reveal [class*="from-stone-800"],
        .reveal [class*="from-neutral-800"] {
            background-color: #1e293b !important;
            color: #ffffff !important;
        }

        /* 2. PURPLE/INDIGO DARK CARDS */
        .reveal [class*="from-purple-900"],
        .reveal.from-purple-900,
        .reveal [class*="from-indigo-900"],
        .reveal.from-indigo-900 {
            background-color: #3b0764 !important;
            color: #ffffff !important;
        }

        /* 3. EMERALD/TEAL/BLUE DARK CARDS */
        .reveal [class*="from-emerald-900"],
        .reveal.from-emerald-900,
        .reveal [class*="from-teal-900"],
        .reveal.from-teal-900 {
            background-color: #064e3b !important;
            color: #ffffff !important;
        }


        .reveal [class*="from-blue-900"] {
            background-color: #1e3a8a !important;
            /* Fallback Solid Blue-900 */
            color: #ffffff !important;
        }

        /* 1. Force Headers to White/Light by default in these cards (Overrides .reveal h3 rule) */
        .reveal [class*="bg-slate-800"] h1,
        .reveal.bg-slate-800 h1,
        .reveal.bg-slate-800 h2,
        .reveal.bg-slate-800 h3,
        .reveal [class*="bg-slate-800"] h2,
        .reveal [class*="bg-slate-800"] h3,
        .reveal [class*="from-slate-800"] h1,
        .reveal.from-slate-800 h1,
        .reveal.from-slate-800 h2,
        .reveal.from-slate-800 h3,
        .reveal [class*="from-slate-800"] h2,
        .reveal [class*="from-slate-800"] h3,
        .reveal [class*="from-purple-900"] h1,
        .reveal.from-purple-900 h1,
        .reveal.from-purple-900 h2,
        .reveal.from-purple-900 h3,
        .reveal [class*="from-purple-900"] h2,
        .reveal [class*="from-purple-900"] h3,
        .reveal [class*="from-emerald-900"] h1,
        .reveal.from-emerald-900 h1,
        .reveal.from-emerald-900 h2,
        .reveal.from-emerald-900 h3,
        .reveal [class*="from-emerald-900"] h2,
        .reveal [class*="from-emerald-900"] h3 {
            color: #ffffff !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            /* Add shadow for better legibility */
        }

        /* 2. Force .text-sm and .text-xs to Light Slate (Overriding the dark gray rule) */
        .reveal [class*="bg-slate-800"] .text-sm,
        .reveal.bg-slate-800 .text-sm,
        .reveal [class*="bg-slate-800"] .text-xs,
        .reveal [class*="from-slate-800"] .text-sm,
        .reveal.from-slate-800 .text-sm,
        .reveal [class*="from-slate-800"] .text-xs,
        .reveal [class*="from-purple-900"] .text-sm,
        .reveal.from-purple-900 .text-sm,
        .reveal [class*="from-purple-900"] .text-xs,
        .reveal [class*="from-emerald-900"] .text-sm,
        .reveal.from-emerald-900 .text-sm,
        .reveal.from-emerald-900 .text-xs,
        .reveal [class*="from-emerald-900"] .text-xs {
            color: #e2e8f0 !important;
            /* Slate-200 */
            opacity: 1 !important;
            font-weight: 500 !important;
        }

        /* 3. Restore Specific Colors for emphasized text (High Specificity) */
        /* We use * selector to catch any element inside the dark card with these colors */
        .reveal [class*="from-slate-800"] .text-orange-400,
        .reveal [class*="bg-slate-800"] .text-orange-400 {
            color: #fb923c !important;
        }

        .reveal [class*="from-slate-800"] .text-orange-300 {
            color: #fdba74 !important;
        }

        .reveal [class*="from-slate-800"] .text-emerald-300 {
            color: #6ee7b7 !important;
        }

        .reveal [class*="from-slate-800"] .text-emerald-400 {
            color: #34d399 !important;
        }

        .reveal [class*="from-slate-800"] .text-blue-300 {
            color: #93c5fd !important;
        }

        .reveal [class*="from-slate-800"] .text-blue-400 {
            color: #60a5fa !important;
        }

        .reveal [class*="from-slate-800"] .text-cyan-300 {
            color: #67e8f9 !important;
        }

        .reveal [class*="from-slate-800"] .text-teal-300 {
            color: #5eead4 !important;
        }

        .reveal [class*="from-slate-800"] .text-purple-300 {
            color: #d8b4fe !important;
        }

        .reveal [class*="from-slate-800"] .text-yellow-400 {
            color: #facc15 !important;
        }

        /* Purple/Other Dark Cards Exceptions */
        .reveal [class*="from-purple-900"] .text-orange-300,
        .reveal [class*="from-purple-900"] .text-orange-400 {
            color: #fb923c !important;
        }

        .reveal [class*="from-purple-900"] .text-purple-300 {
            color: #d8b4fe !important;
        }

        /* Ensure bold text is white if no other color */
        .reveal [class*="from-slate-800"] strong,
        .reveal [class*="bg-slate-800"] strong {
            color: white !important;
        }

        /* Opcional: Si usas la clase 'bg-primary' de Tailwind */
        .bg-primary h1,
        .bg-primary h2,
        .bg-primary p {
            color: #ffffff !important;
        }

        /* =========================================
           INLINE TEXT INPUT STYLING
           ========================================= */
        .text-input-inline {
            display: inline-block;
            min-width: 100px;
            max-width: 150px;
            padding: 4px 8px;
            margin: 0 4px;
            border: none;
            border-bottom: 2px solid #10b981;
            background: transparent;
            font-size: inherit;
            font-weight: 600;
            color: #059669;
            text-align: center;
            transition: all 0.3s ease;
            outline: none;
        }

        .text-input-inline:focus {
            border-bottom-color: #f97316;
            background: #fef3c7;
            transform: scale(1.05);
        }

        .text-input-inline.correct {
            border-bottom-color: #10b981;
            background: #d1fae5;
            color: #047857;
        }

        .text-input-inline.incorrect {
            border-bottom-color: #ef4444;
            background: #fee2e2;
            color: #dc2626;
        }
    </style>




</head>

<body>

    <div id="header-container"></div>

    <div id="scroll-progress"></div>

    <img id="fixed-logo" src="https://tucaneo.com/wp-content/uploads/2025/11/Plantilla-2-e1764351536337.png"
        alt="Tucaneo Academy">
    <a href="https://tucaneo.com" id="floating-cta">TUCANEO.COM</a>

    <div id="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
        <i class="fas fa-arrow-up"></i>
    </div>

    <div id="tucaneo-drawer">
        <button id="safe-close-btn" onclick="toggleDrawer()"><i class="fas fa-times"></i></button>
        <div id="tools-root" style="width: 100%; height: 100%;"></div>
    </div>

    <div id="top-nav">
        <button id="btn-zoom" onclick="forceZoom()" class="nav-btn zoom" title="Modo Lectura"><i
                class="fas fa-search-plus"></i> <span>Zoom</span></button>
        <a href="#" class="nav-btn download" onclick="window.print()"><i class="fas fa-file-pdf"></i>
            <span>PDF</span></a>
        <a href="https://tucaneo.com/" class="nav-btn exit"><i class="fas fa-sign-out-alt"></i> <span>Salir</span></a>
    </div>

    <div id="premium-dock"
        class="fixed left-6 top-1/2 -translate-y-1/2 z-[6000] flex flex-col items-center gap-3 p-2 bg-white/80 backdrop-blur-xl rounded-full shadow-2xl border border-white/50 transition-all hover:scale-[1.02]">

        <div class="flex flex-col gap-2 bg-gray-100/50 p-1 rounded-full">
            <button onclick="openTool('board')" title="Abrir Pizarra"
                class="group relative w-12 h-12 rounded-full bg-white shadow-sm hover:shadow-md flex items-center justify-center text-orange-600 transition-all hover:translate-x-1 active:scale-95">
                <i class="fas fa-pen-nib text-xl"></i>
                <span
                    class="absolute left-full ml-3 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap z-50">Pizarra</span>
            </button>
            <button onclick="openTool('vocab')" title="Glosario"
                class="group relative w-12 h-12 rounded-full bg-white shadow-sm hover:shadow-md flex items-center justify-center text-emerald-700 transition-all hover:translate-x-1 active:scale-95">
                <i class="fas fa-book text-xl"></i>
                <span
                    class="absolute left-full ml-3 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap z-50">Glosario</span>
            </button>
        </div>

        <div class="h-px w-6 bg-gray-300/50 my-1"></div>

        <div class="flex flex-col gap-2">
            <button onclick="react('confetti')" title="Fiesta"
                class="group relative w-12 h-12 rounded-full bg-gradient-to-tr from-yellow-400 to-orange-500 shadow-lg hover:shadow-xl flex items-center justify-center text-white transition-all hover:translate-x-1 hover:rotate-12 active:scale-95">
                <i class="fas fa-party-popper text-xl"></i>
            </button>
            <button onclick="react('applause')" title="Aplausos"
                class="group relative w-12 h-12 rounded-full bg-gradient-to-tr from-blue-400 to-indigo-500 shadow-lg hover:shadow-xl flex items-center justify-center text-white transition-all hover:translate-x-1 hover:-rotate-12 active:scale-95">
                <i class="fas fa-hands-clapping text-xl"></i>
            </button>
        </div>

        <div class="h-px w-6 bg-gray-300/50 my-1"></div>

        <div class="flex flex-col gap-1 bg-gray-100/50 p-1 rounded-full">
            <button onclick="react('error')"
                class="w-10 h-10 rounded-full bg-white hover:bg-red-50 text-red-400 shadow-sm flex items-center justify-center transition-all border border-transparent hover:border-red-100 hover:scale-110"
                title="Error">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
    </div>

    <div class="reveal">
        <div class="slides">

            <section data-background-gradient="linear-gradient(135deg, #0f172a 0%, #042f2e 100%)">
    
    <div class="absolute inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] bg-emerald-500/20 rounded-full blur-3xl"></div>
        <div class="absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-amber-500/10 rounded-full blur-3xl"></div>
        <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#ffffff 1px, transparent 1px); background-size: 30px 30px;"></div>
    </div>

    <div class="relative z-10 flex items-center justify-center h-full p-4">
        
        <div class="bg-[#fdfbf7] text-slate-800 rounded-xl shadow-2xl max-w-6xl w-full flex flex-col md:flex-row overflow-hidden border border-slate-200">
            
            <div class="bg-slate-100 p-8 md:w-1/3 flex flex-col items-center justify-center border-b md:border-b-0 md:border-r border-slate-200 relative">
                <div class="absolute top-0 left-0 right-0 h-2 bg-gradient-to-r from-red-500 via-white to-blue-500 bg-[length:40px_100%]"></div>
                
                <div class="w-40 h-40 bg-white rounded-full flex items-center justify-center shadow-lg mb-6 border-4 border-amber-400 relative">
                    <i class="fas fa-plane-departure text-6xl text-slate-800 transform -rotate-12"></i>
                    <div class="absolute -bottom-2 -right-2 bg-emerald-600 text-white text-xs font-bold px-3 py-1 rounded-full uppercase tracking-widest shadow-md border-2 border-white">
                        Aprobado
                    </div>
                </div>
                
                <h1 class="font-playfair text-4xl font-black text-slate-800 text-center leading-tight mb-2">
                    Misi√≥n<br><span class="text-amber-600">Colombia</span>
                </h1>
                <p class="font-lato text-slate-500 uppercase tracking-[0.2em] text-sm font-bold">Diario del Viajero</p>
            </div>

            <div class="p-8 md:p-10 md:w-2/3 flex flex-col justify-center bg-white">
                
                <h3 class="text-xl text-slate-600 font-light mb-8 italic border-l-4 border-amber-400 pl-4">
                    "Para sobrevivir en este viaje, tu equipaje debe incluir tres herramientas esenciales:"
                </h3>

                <div class="grid grid-cols-1 gap-4 mb-8">
                    
                    <div class="flex items-center p-4 bg-amber-50 rounded-lg border border-amber-100 hover:shadow-md transition-shadow">
                        <div class="w-12 h-12 bg-amber-200 text-amber-700 rounded-full flex items-center justify-center text-xl mr-4 shrink-0">
                            <i class="fas fa-star"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 text-lg">Dominar tus Deseos</h4>
                            <span class="inline-block bg-slate-800 text-white text-xs px-2 py-0.5 rounded uppercase font-bold tracking-wide">El Subjuntivo</span>
                        </div>
                    </div>

                    <div class="flex items-center p-4 bg-sky-50 rounded-lg border border-sky-100 hover:shadow-md transition-shadow">
                        <div class="w-12 h-12 bg-sky-200 text-sky-700 rounded-full flex items-center justify-center text-xl mr-4 shrink-0">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 text-lg">Cuidar de ti mismo</h4>
                            <span class="inline-block bg-slate-800 text-white text-xs px-2 py-0.5 rounded uppercase font-bold tracking-wide">Verbos Reflexivos</span>
                        </div>
                    </div>

                    <div class="flex items-center p-4 bg-emerald-50 rounded-lg border border-emerald-100 hover:shadow-md transition-shadow">
                        <div class="w-12 h-12 bg-emerald-200 text-emerald-700 rounded-full flex items-center justify-center text-xl mr-4 shrink-0">
                            <i class="fas fa-hand-holding-heart"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 text-lg">Saber pedir las cosas</h4>
                            <span class="inline-block bg-slate-800 text-white text-xs px-2 py-0.5 rounded uppercase font-bold tracking-wide">Los Pronombres</span>
                        </div>
                    </div>

                </div>

                <div class="text-right">
                    <button onclick="Reveal.next()" class="group px-8 py-3 bg-slate-800 hover:bg-slate-700 text-white font-bold rounded-lg shadow-lg transition-all flex items-center gap-3 ml-auto">
                        <span>Iniciar Aventura</span>
                        <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform text-amber-400"></i>
                    </button>
                </div>

            </div>
        </div>
    </div>
</section>

            <section data-state="airport-challenge" data-background-gradient="linear-gradient(160deg, #e0f2fe 0%, #f0f9ff 100%)">
    
    <div class="absolute top-10 left-10 text-blue-100 opacity-50 text-9xl transform -rotate-12 pointer-events-none">
        <i class="fas fa-cloud"></i>
    </div>
    <div class="absolute bottom-20 right-10 text-blue-100 opacity-50 text-9xl pointer-events-none">
        <i class="fas fa-plane-departure"></i>
    </div>

    <div class="slide-container h-full flex flex-col justify-center items-center relative z-10 px-4">

        <div class="mb-8 text-center">
            <div class="inline-flex items-center gap-3 bg-blue-600 text-white px-6 py-2 rounded-full shadow-lg mb-4">
                <i class="fas fa-passport animate-pulse"></i>
                <span class="font-bold tracking-widest uppercase text-sm">Gate A2 ‚Ä¢ Subjuntivo</span>
            </div>
            <h2 class="text-4xl md:text-5xl font-black text-slate-800 drop-shadow-sm font-playfair">
                El √öltimo Consejo
            </h2>
        </div>

        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-5xl overflow-hidden flex flex-col md:flex-row border border-slate-200">
            
            <div class="bg-slate-50 p-8 md:w-1/3 flex flex-col items-center justify-center border-b md:border-b-0 md:border-r border-dashed border-slate-300 relative group">
                <div class="absolute top-4 left-4 border-2 border-red-400 text-red-400 px-2 py-1 text-xs font-bold uppercase transform -rotate-12 opacity-60">
                    Urgente
                </div>

                <div class="relative mb-6">
                    <div class="w-24 h-24 rounded-full bg-cover bg-center border-4 border-white shadow-xl relative z-10" 
                         style="background-image: url('https://img.freepik.com/free-photo/senior-woman-talking-phone_23-2148767937.jpg?w=360'); background-color: #ddd;">
                         <i class="fas fa-user text-4xl text-slate-400 absolute inset-0 flex items-center justify-center -z-10"></i>
                    </div>
                    <div class="absolute -bottom-2 -right-2 bg-green-500 text-white w-8 h-8 rounded-full flex items-center justify-center border-2 border-white shadow-md z-20">
                        <i class="fas fa-comment-dots"></i>
                    </div>
                </div>
                
                <h3 class="text-xl font-bold text-slate-800">Mam√°</h3>
                <p class="text-slate-500 text-sm mb-4">En l√≠nea hace un momento...</p>
                
                <div class="bg-white p-4 rounded-xl rounded-tl-none shadow-sm border border-slate-100 text-slate-600 italic text-center text-sm relative">
                    "Hijo, Bogot√° es muy fr√≠a. Por favor, completa mis frases antes de subir al avi√≥n."
                </div>
            </div>

            <div class="p-8 md:w-2/3 bg-white relative">
                
                <div class="space-y-6" id="boarding-form">
                    
                    <div class="flex items-center gap-4 group">
                        <div class="w-12 h-12 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center text-xl shadow-sm group-hover:scale-110 transition-transform">
                            <i class="fas fa-mitten"></i> </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wide mb-1">Es importante que...</label>
                            <div class="flex items-center gap-2 text-lg text-slate-700">
                                <span>(t√∫)</span>
                                <input type="text" data-answer="te abrigues" placeholder="verb: abrigarse" 
                                       class="bg-slate-50 border-b-2 border-slate-200 focus:border-orange-500 outline-none px-2 py-1 w-full font-medium text-slate-800 transition-colors placeholder:text-slate-300 placeholder:italic placeholder:text-sm">
                            </div>
                        </div>
                        <i class="fas fa-check-circle text-emerald-500 text-xl opacity-0 transition-opacity status-icon"></i>
                    </div>

                    <div class="flex items-center gap-4 group">
                        <div class="w-12 h-12 rounded-xl bg-red-100 text-red-600 flex items-center justify-center text-xl shadow-sm group-hover:scale-110 transition-transform">
                            <i class="fas fa-thermometer-half"></i> </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wide mb-1">No quiero que...</label>
                            <div class="flex items-center gap-2 text-lg text-slate-700">
                                <span>(t√∫)</span>
                                <input type="text" data-answer="te enfermes" placeholder="verb: enfermarse" 
                                       class="bg-slate-50 border-b-2 border-slate-200 focus:border-red-500 outline-none px-2 py-1 w-full font-medium text-slate-800 transition-colors placeholder:text-slate-300 placeholder:italic placeholder:text-sm">
                            </div>
                        </div>
                        <i class="fas fa-check-circle text-emerald-500 text-xl opacity-0 transition-opacity status-icon"></i>
                    </div>

                    <div class="flex items-center gap-4 group">
                        <div class="w-12 h-12 rounded-xl bg-emerald-100 text-emerald-600 flex items-center justify-center text-xl shadow-sm group-hover:scale-110 transition-transform">
                            <i class="fas fa-heart"></i> </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wide mb-1">Ojal√° que...</label>
                            <div class="flex items-center gap-2 text-lg text-slate-700">
                                <span>(t√∫)</span>
                                <input type="text" data-answer="te sientas" placeholder="verb: sentirse" 
                                       class="bg-slate-50 border-b-2 border-slate-200 focus:border-emerald-500 outline-none px-2 py-1 w-full font-medium text-slate-800 transition-colors placeholder:text-slate-300 placeholder:italic placeholder:text-sm">
                            </div>
                        </div>
                        <i class="fas fa-check-circle text-emerald-500 text-xl opacity-0 transition-opacity status-icon"></i>
                    </div>

                </div>

                <div class="mt-8 flex justify-between items-center border-t border-slate-100 pt-6">
                    <div class="text-xs text-slate-400">
                        <i class="fas fa-info-circle mr-1"></i> Recuerda: Pronombre + Verbo
                    </div>
                    <button onclick="checkAirportInputs()" class="bg-slate-800 hover:bg-slate-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg transition-all transform hover:-translate-y-1 flex items-center gap-2">
                        <span>Validar Pasaporte</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="airport-feedback" class="mt-6 font-bold text-xl text-emerald-600 opacity-0 transition-opacity min-h-[30px]">
            ¬°Buen viaje!
        </div>

    </div>

    <script>
        function checkAirportInputs() {
            const inputs = document.querySelectorAll('#boarding-form input');
            let correctCount = 0;
            
            inputs.forEach(input => {
                const userAnswer = input.value.trim().toLowerCase();
                // Limpiar tildes para validaci√≥n flexible si se desea, aqu√≠ validamos estricto pero normalizado
                const correctAnswer = input.getAttribute('data-answer').toLowerCase();
                const parentRow = input.closest('.group');
                const statusIcon = parentRow.querySelector('.status-icon');

                if (userAnswer === correctAnswer) {
                    correctCount++;
                    // Estilo Correcto
                    input.classList.remove('border-slate-200', 'border-red-500', 'text-red-500');
                    input.classList.add('border-emerald-500', 'text-emerald-700');
                    statusIcon.classList.remove('opacity-0', 'fa-times-circle', 'text-red-500');
                    statusIcon.classList.add('opacity-100', 'fa-check-circle', 'text-emerald-500');
                } else {
                    // Estilo Incorrecto
                    input.classList.remove('border-slate-200', 'border-emerald-500');
                    input.classList.add('border-red-500');
                    statusIcon.classList.remove('opacity-0', 'fa-check-circle', 'text-emerald-500');
                    statusIcon.classList.add('opacity-100', 'fa-times-circle', 'text-red-500');
                    
                    // Shake effect
                    input.classList.add('animate-pulse');
                    setTimeout(() => input.classList.remove('animate-pulse'), 500);
                }
            });

            const feedback = document.getElementById('airport-feedback');
            if (correctCount === inputs.length) {
                feedback.innerText = "¬°Todo listo! ¬°Buen viaje a la tierra del fr√≠o!";
                feedback.classList.remove('opacity-0', 'text-red-500');
                feedback.classList.add('opacity-100', 'text-emerald-600');
                
                // Disparar confetti si est√° disponible
                if(window.confetti) {
                    confetti({
                        particleCount: 150,
                        spread: 80,
                        origin: { y: 0.7 },
                        colors: ['#3b82f6', '#10b981']
                    });
                }
            } else {
                feedback.innerText = "Faltan documentos por corregir...";
                feedback.classList.remove('opacity-0', 'text-emerald-600');
                feedback.classList.add('opacity-100', 'text-red-500');
            }
        }
    </script>
</section>

            <section data-state="level-game-active" class="bg-slate-900">
    
    <div class="absolute inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-0 left-0 w-full h-full bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-800 via-slate-900 to-black opacity-80"></div>
        <div class="absolute top-20 right-20 w-72 h-72 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
        <div class="absolute top-20 left-20 w-72 h-72 bg-yellow-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-8 left-1/2 w-72 h-72 bg-pink-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-4000"></div>
    </div>

    <div class="slide-container h-full flex items-center justify-center relative z-10 p-4">

        <div class="w-full max-w-4xl bg-slate-50 rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col h-[600px] border-8 border-slate-800 relative">
            
            <div class="bg-slate-800 text-white p-4 flex justify-between items-center z-20 shadow-md">
                <div class="flex items-center gap-2">
                    <i class="fas fa-signal text-xs text-green-400"></i>
                    <span class="font-bold tracking-wider text-sm">TUCANEO AIRLINES</span>
                </div>
                <div class="flex gap-1" id="game-hearts">
                    </div>
            </div>

            <div class="bg-slate-200 h-2 w-full flex">
                <div id="lvl-1-bar" class="h-full w-1/5 bg-slate-300 transition-all duration-500 border-r border-white"></div>
                <div id="lvl-2-bar" class="h-full w-1/5 bg-slate-300 transition-all duration-500 border-r border-white"></div>
                <div id="lvl-3-bar" class="h-full w-1/5 bg-slate-300 transition-all duration-500 border-r border-white"></div>
                <div id="lvl-4-bar" class="h-full w-1/5 bg-slate-300 transition-all duration-500 border-r border-white"></div>
                <div id="lvl-5-bar" class="h-full w-1/5 bg-slate-300 transition-all duration-500"></div>
            </div>

            <div id="game-stage-area" class="flex-1 relative bg-white flex flex-col items-center justify-center p-8 overflow-y-auto">
                </div>

            <button id="next-level-btn" onclick="travelGame.nextLevel()" 
                    class="absolute bottom-8 right-8 bg-black text-white px-8 py-4 rounded-full font-bold shadow-lg transform translate-y-20 transition-all duration-300 hover:bg-emerald-600 hover:scale-105 z-30 hidden">
                Continuar <i class="fas fa-arrow-right ml-2"></i>
            </button>

            <div id="feedback-overlay" class="absolute inset-0 bg-white/90 backdrop-blur-sm z-40 hidden flex-col items-center justify-center text-center p-8">
                <div id="feedback-icon" class="text-6xl mb-4"></div>
                <h2 id="feedback-title" class="text-3xl font-black mb-2 text-slate-800"></h2>
                <p id="feedback-msg" class="text-xl text-slate-600 mb-6"></p>
                <button onclick="travelGame.closeFeedback()" class="px-6 py-2 bg-slate-800 text-white rounded-lg font-bold">Entendido</button>
            </div>

        </div>
    </div>

    <style>
        .animate-blob { animation: blob 7s infinite; }
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .selected-card { border-color: #3b82f6 !important; background-color: #eff6ff !important; transform: scale(1.05); }
    </style>

    <script>
        const travelGame = {
            state: {
                level: 1,
                lives: 3,
                maxLevels: 5,
                isGameOver: false
            },

            // DATOS DE LOS 5 NIVELES
            levelsData: {
                1: {
                    type: 'selection',
                    title: "Nivel 1: El Equipaje",
                    instruction: "Toca la frase que expresa una NECESIDAD (Subjuntivo).",
                    options: [
                        { id: 1, text: "Tengo una maleta que pesa mucho.", icon: "üéí", correct: false },
                        { id: 2, text: "Busco una maleta que sea ligera.", icon: "ü™∂", correct: true }, // Correcto (Busco... que sea)
                        { id: 3, text: "Uso la maleta que me regalaste.", icon: "üéÅ", correct: false }
                    ],
                    explanation: "'Busco... que sea' indica que no sabemos si existe. Es hipot√©tico."
                },
                2: {
                    type: 'binary',
                    title: "Nivel 2: Control de Seguridad",
                    instruction: "¬øEsta frase es Correcta o Incorrecta?",
                    question: "No creo que el vuelo llega a tiempo.",
                    isCorrect: false, // Deber√≠a ser 'llegue'
                    explanation: "Con 'No creo que' (Duda/Negaci√≥n) necesitas Subjuntivo: 'llegue'."
                },
                3: {
                    type: 'input',
                    title: "Nivel 3: Pasaporte",
                    instruction: "Completa la orden de la oficial.",
                    prefix: "Se√±or, quiero que usted me ",
                    verb: "(dar)",
                    suffix: " su pasaporte ahora.",
                    answer: "d√©",
                    explanation: "Quiero que usted... d√© (Dar en Subjuntivo)."
                },
                4: {
                    type: 'quiz',
                    title: "Nivel 4: Sala de Espera",
                    instruction: "¬øCu√°l es la reacci√≥n l√≥gica?",
                    context: "Tu amigo dice: '¬°Tengo miedo del avi√≥n!'",
                    options: [
                        { text: "Es bueno que tengas miedo.", correct: false },
                        { text: "Es normal que sientas miedo.", correct: true },
                        { text: "Es verdad que tengas miedo.", correct: false }
                    ],
                    explanation: "Usamos 'Es normal que' para valorar una emoci√≥n."
                },
                5: {
                    type: 'boss',
                    title: "Nivel 5: El Piloto",
                    instruction: "Elige la frase perfecta para despegar.",
                    options: [
                        { text: "¬°Ojal√° que tengamos un buen vuelo!", correct: true },
                        { text: "¬°Ojal√° que tenemos un buen vuelo!", correct: false },
                        { text: "¬°Espero que tuvimos un buen vuelo!", correct: false }
                    ],
                    explanation: "Ojal√° siempre dispara Subjuntivo."
                }
            },

            init: function() {
                this.state.level = 1;
                this.state.lives = 3;
                this.state.isGameOver = false;
                this.updateHearts();
                this.renderLevel();
                document.getElementById('next-level-btn').classList.add('hidden');
            },

            updateHearts: function() {
                const container = document.getElementById('game-hearts');
                container.innerHTML = '';
                for(let i=0; i<3; i++) {
                    const heart = document.createElement('i');
                    heart.className = `fas fa-heart ${i < this.state.lives ? 'text-red-500' : 'text-slate-600'}`;
                    container.appendChild(heart);
                }
            },

            updateProgress: function() {
                for(let i=1; i<=5; i++) {
                    const bar = document.getElementById(`lvl-${i}-bar`);
                    if (i < this.state.level) {
                        bar.className = "h-full w-1/5 bg-emerald-500 border-r border-white"; // Pasado
                    } else if (i === this.state.level) {
                        bar.className = "h-full w-1/5 bg-amber-400 animate-pulse border-r border-white"; // Actual
                    } else {
                        bar.className = "h-full w-1/5 bg-slate-300 border-r border-white"; // Futuro
                    }
                }
            },

            renderLevel: function() {
                if (this.state.lives <= 0) return this.showGameOver();
                if (this.state.level > 5) return this.showVictory();

                this.updateProgress();
                const data = this.levelsData[this.state.level];
                const stage = document.getElementById('game-stage-area');
                
                // HEADER COM√öN DEL NIVEL
                let html = `
                    <div class="text-center mb-8 animate-fade-in-up">
                        <span class="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-widest mb-2 inline-block">${data.title}</span>
                        <h3 class="text-3xl font-black text-slate-800">${data.instruction}</h3>
                    </div>
                `;

                // CONTENIDO ESPEC√çFICO SEG√öN TIPO
                if (data.type === 'selection') {
                    html += `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 w-full">`;
                    data.options.forEach(opt => {
                        html += `
                            <button onclick="travelGame.checkSelection(${opt.id})" class="p-6 rounded-2xl border-2 border-slate-100 hover:border-blue-400 bg-white shadow-sm hover:shadow-md transition-all group flex flex-col items-center gap-3">
                                <span class="text-4xl group-hover:scale-110 transition-transform">${opt.icon}</span>
                                <span class="text-slate-600 font-bold leading-tight">${opt.text}</span>
                            </button>
                        `;
                    });
                    html += `</div>`;
                } 
                else if (data.type === 'binary') {
                    html += `
                        <div class="bg-white border-2 border-dashed border-slate-300 p-8 rounded-xl mb-8 w-full text-center">
                            <p class="text-2xl font-serif italic text-slate-700">"${data.question}"</p>
                        </div>
                        <div class="flex gap-6 w-full justify-center">
                            <button onclick="travelGame.checkBinary(true)" class="w-1/3 py-4 bg-emerald-100 text-emerald-700 font-bold rounded-xl hover:bg-emerald-200 transition-colors flex flex-col items-center">
                                <i class="fas fa-check text-2xl mb-1"></i> Correcta
                            </button>
                            <button onclick="travelGame.checkBinary(false)" class="w-1/3 py-4 bg-red-100 text-red-700 font-bold rounded-xl hover:bg-red-200 transition-colors flex flex-col items-center">
                                <i class="fas fa-times text-2xl mb-1"></i> Incorrecta
                            </button>
                        </div>
                    `;
                }
                else if (data.type === 'input') {
                    html += `
                        <div class="w-full max-w-md bg-slate-50 p-6 rounded-2xl border border-slate-200 flex flex-col items-center">
                            <div class="text-xl text-slate-700 mb-4 text-center">
                                ${data.prefix} 
                                <span class="font-bold text-amber-600 bg-amber-50 px-2 rounded inline-block">${data.verb}</span> 
                                ${data.suffix}
                            </div>
                            <input type="text" id="lvl3-input" class="w-full text-center text-2xl font-bold border-b-4 border-slate-300 focus:border-amber-500 outline-none bg-transparent py-2 text-slate-800 placeholder-slate-300" placeholder="Escribe aqu√≠...">
                            <button onclick="travelGame.checkInput()" class="mt-6 w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-700">Verificar</button>
                        </div>
                    `;
                }
                else if (data.type === 'quiz' || data.type === 'boss') {
                    if(data.context) html += `<p class="text-lg text-slate-500 mb-6 italic">"${data.context}"</p>`;
                    html += `<div class="flex flex-col gap-3 w-full max-w-md">`;
                    data.options.forEach((opt, idx) => {
                        html += `
                            <button onclick="travelGame.checkQuiz(${idx})" class="w-full p-4 text-left bg-white border border-slate-200 rounded-xl hover:bg-blue-50 hover:border-blue-300 transition-all font-medium text-slate-700 flex justify-between items-center group">
                                ${opt.text}
                                <i class="fas fa-chevron-right text-slate-300 group-hover:text-blue-500"></i>
                            </button>
                        `;
                    });
                    html += `</div>`;
                }

                stage.innerHTML = html;
            },

            // --- FUNCIONES DE VERIFICACI√ìN ---

            checkSelection: function(id) {
                const data = this.levelsData[1];
                const selected = data.options.find(o => o.id === id);
                this.handleResult(selected.correct, data.explanation);
            },

            checkBinary: function(userSaysCorrect) {
                const data = this.levelsData[2];
                // La frase es incorrecta (isCorrect: false). 
                // Si el usuario dice que es Correcta (true), falla. Si dice Incorrecta (false), gana.
                const isWin = (userSaysCorrect === data.isCorrect); 
                
                // Ajuste de l√≥gica para feedback claro
                const feedbackText = isWin ? "¬°Bien visto! La frase tiene errores." : "Ups, la frase tiene un error.";
                this.handleResult(isWin, data.explanation);
            },

            checkInput: function() {
                const input = document.getElementById('lvl3-input');
                const val = input.value.trim().toLowerCase();
                const data = this.levelsData[3];
                // Normalizar tildes para ser amable (opcional)
                const isCorrect = (val === data.answer || val === "de"); 
                this.handleResult(isCorrect, data.explanation);
            },

            checkQuiz: function(idx) {
                const data = this.levelsData[this.state.level];
                const isCorrect = data.options[idx].correct;
                this.handleResult(isCorrect, data.explanation);
            },

            // --- SISTEMA CENTRAL DE RESULTADOS ---

            handleResult: function(isSuccess, explanation) {
                const overlay = document.getElementById('feedback-overlay');
                const title = document.getElementById('feedback-title');
                const msg = document.getElementById('feedback-msg');
                const icon = document.getElementById('feedback-icon');

                overlay.classList.remove('hidden');
                overlay.classList.add('flex');

                if (isSuccess) {
                    icon.innerHTML = "üåü";
                    title.innerText = "¬°Correcto!";
                    title.className = "text-3xl font-black mb-2 text-emerald-600";
                    msg.innerHTML = explanation;
                    this.state.level++; // Avanzar nivel internamente
                    
                    // Mostrar bot√≥n siguiente si no es el √∫ltimo
                    if(this.state.level <= this.state.maxLevels + 1) {
                         // Esperamos a que cierre el feedback para renderizar
                    }
                } else {
                    this.state.lives--;
                    this.updateHearts();
                    icon.innerHTML = "üí•";
                    title.innerText = "Cuidado";
                    title.className = "text-3xl font-black mb-2 text-red-500";
                    msg.innerHTML = explanation;
                }
            },

            closeFeedback: function() {
                document.getElementById('feedback-overlay').classList.add('hidden');
                document.getElementById('feedback-overlay').classList.remove('flex');
                
                if (this.state.lives <= 0) {
                    this.showGameOver();
                } else {
                    this.renderLevel(); // Renderiza el siguiente nivel o re-renderiza el actual
                }
            },

            showVictory: function() {
                const stage = document.getElementById('game-stage-area');
                stage.innerHTML = `
                    <div class="text-center animate-bounce-in">
                        <div class="text-8xl mb-4">‚úàÔ∏è</div>
                        <h2 class="text-4xl font-black text-slate-800 mb-2">¬°Est√°s Listo!</h2>
                        <p class="text-xl text-slate-500 mb-8">Has completado el entrenamiento de subjuntivo.</p>
                        <button onclick="Reveal.next()" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-10 py-4 rounded-full font-bold shadow-xl hover:scale-105 transition-transform">
                            Despegar <i class="fas fa-plane-departure ml-2"></i>
                        </button>
                        <br>
                        <button onclick="travelGame.init()" class="mt-4 text-slate-400 text-sm hover:text-slate-600 underline">Jugar de nuevo</button>
                    </div>
                `;
                if(window.confetti) confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
            },

            showGameOver: function() {
                const stage = document.getElementById('game-stage-area');
                stage.innerHTML = `
                    <div class="text-center">
                        <div class="text-8xl mb-4">‚õàÔ∏è</div>
                        <h2 class="text-4xl font-black text-slate-800 mb-2">Vuelo Cancelado</h2>
                        <p class="text-xl text-slate-500 mb-8">Te quedaste sin vidas.</p>
                        <button onclick="travelGame.init()" class="bg-slate-800 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-slate-700">
                            Intentar de nuevo <i class="fas fa-redo ml-2"></i>
                        </button>
                    </div>
                `;
            }
        };

        // Iniciar al cargar (o con un timeout si es Reveal)
        setTimeout(() => travelGame.init(), 500);
        
        // Hook para Reveal.js si existe
        if(window.Reveal) {
            Reveal.on('slidechanged', event => {
                if (event.currentSlide.getAttribute('data-state') === 'level-game-active') {
                    travelGame.init();
                }
            });
        }
    </script>
</section>

            <section data-state="clean-crisis-lab" class="bg-slate-50">
    
    <div class="absolute inset-0 overflow-hidden pointer-events-none opacity-40">
        <div class="absolute right-0 top-0 w-1/3 h-full bg-blue-50 border-l border-blue-100"></div>
        <div class="absolute bottom-10 left-10 w-64 h-64 bg-blue-200/20 rounded-full blur-3xl"></div>
        <div class="absolute inset-0" style="background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 40px 40px;"></div>
    </div>

    <div class="slide-container h-full flex flex-col relative z-10 p-6 max-w-7xl mx-auto">

        <div class="flex justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-red-100 text-red-600 rounded-lg flex items-center justify-center text-2xl animate-pulse">
                    <i class="fas fa-biohazard"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-black text-slate-800 tracking-tight m-0 leading-none">SALA DE CRISIS</h2>
                    <p class="text-slate-500 text-sm font-bold uppercase tracking-widest mt-1">Nivel de Amenaza: ACTIVO</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2 bg-slate-100 px-4 py-2 rounded-lg">
                <span class="text-xs font-bold text-slate-400 uppercase mr-2">Estabilidad:</span>
                <div id="lab-health" class="flex gap-1">
                    <div class="w-8 h-3 bg-emerald-500 rounded-full"></div>
                    <div class="w-8 h-3 bg-emerald-500 rounded-full"></div>
                    <div class="w-8 h-3 bg-emerald-500 rounded-full"></div>
                </div>
            </div>
        </div>

        <div class="flex-1 flex gap-8 items-stretch h-full">
            
            <div class="w-5/12 bg-white rounded-2xl shadow-xl border-2 border-slate-200 flex flex-col relative overflow-hidden">
                <div class="bg-slate-100 p-3 border-b border-slate-200 flex justify-between items-center">
                    <span class="font-mono text-xs font-bold text-slate-500">CAM_01: LABORATORIO</span>
                    <span class="w-2 h-2 bg-red-500 rounded-full animate-ping"></span>
                </div>
                
                <div class="flex-1 flex flex-col items-center justify-center p-6 text-center bg-slate-50 relative">
                    <div id="lab-icon" class="text-9xl text-slate-300 mb-6 transition-all duration-500 transform scale-100">
                        <i class="fas fa-flask"></i>
                    </div>
                    
                    <div class="z-10 bg-white/90 backdrop-blur p-4 rounded-xl shadow-sm border border-slate-200 w-full">
                        <h3 class="text-slate-400 text-xs font-bold uppercase mb-1">Situaci√≥n Actual:</h3>
                        <p id="lab-context" class="text-xl font-bold text-slate-800 leading-tight">
                            El experimento es inestable.
                        </p>
                    </div>
                </div>
            </div>

            <div class="w-7/12 flex flex-col justify-center">
                
                <div class="mb-6">
                    <div class="inline-block bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full mb-3 uppercase tracking-wide">
                        <i class="fas fa-terminal mr-1"></i> Protocolo Requerido
                    </div>
                    <h3 id="lab-instruction" class="text-3xl font-black text-slate-800 leading-tight mb-2">
                        Describe el problema.
                    </h3>
                    <p class="text-slate-500 text-lg">Selecciona la opci√≥n gramaticalmente perfecta.</p>
                </div>

                <div id="lab-options" class="flex flex-col gap-3">
                    </div>

                <div id="lab-feedback" class="mt-4 p-4 rounded-lg text-center font-bold text-lg opacity-0 transition-opacity min-h-[60px] flex items-center justify-center border-2 border-transparent">
                    Feedback here
                </div>

            </div>
        </div>

    </div>

    <script>
        const labGame = {
            step: 0,
            lives: 3,
            isLocked: false,
            
            // DATOS DEL JUEGO (Gram√°tica ajustada: Presente Irregular -> Subjuntivo -> Pronombres)
            steps: [
                {
                    // PASO 1: Presente Simple (Irregular) - Describir la realidad
                    title: "Paso 1: Diagn√≥stico (Presente)",
                    context: "¬°Alerta! El gas t√≥xico ___ mal.",
                    instruction: "Completa con el verbo OLER (Irregular Presente):",
                    icon: "fas fa-smog",
                    options: [
                        { text: "huele", sub: "Correcto (o-ue)", correct: true },
                        { text: "ole", sub: "Incorrecto", correct: false },
                        { text: "huela", sub: "Subjuntivo (No es real todav√≠a)", correct: false }
                    ]
                },
                {
                    // PASO 2: Subjuntivo (Influencia/Deseo)
                    title: "Paso 2: La Orden (Subjuntivo)",
                    context: "El jefe grita: '¬°Es urgente que t√∫ ___ la mezcla!'",
                    instruction: "Completa con el verbo DILUIR o PARAR (Subjuntivo):",
                    icon: "fas fa-exclamation-circle",
                    options: [
                        { text: "paras", sub: "Indicativo (Realidad)", correct: false },
                        { text: "pares", sub: "Subjuntivo (Deseo/Orden)", correct: true },
                        { text: "parar", sub: "Infinitivo", correct: false }
                    ]
                },
                {
                    // PASO 3: Subjuntivo Irregular (Tener/Hacer)
                    title: "Paso 3: Requisitos (Subjuntivo Irregular)",
                    context: "El sistema pide: 'Necesito una clave que ___ letras.'",
                    instruction: "Completa con TENER (Subjuntivo - 'Yo tengo' -> 'Que yo...')",
                    icon: "fas fa-key",
                    options: [
                        { text: "tenga", sub: "Subjuntivo (Ra√≠z 'Teng-')", correct: true },
                        { text: "tiene", sub: "Indicativo", correct: false },
                        { text: "tenia", sub: "Pasado (Prohibido)", correct: false }
                    ]
                },
                {
                    // PASO 4: Imperativo + Pronombres (Doble Objeto)
                    title: "Paso 4: Soluci√≥n Final",
                    context: "¬øLa mascarilla? ¬°El gas es fuerte!",
                    instruction: "Ordena: PONER + ME + LA",
                    icon: "fas fa-mask-ventilator",
                    options: [
                        { text: "¬°P√≥ntela!", sub: "Imperativo Irregular (Poner -> Pon)", correct: true },
                        { text: "¬°P√≥nmela!", sub: "(Pon + me + la)", correct: true }, // Ambas v√°lidas en contexto, priorizamos P√≥nmela para "a mi"
                        { text: "¬°Me la pones!", sub: "Indicativo", correct: false }
                    ]
                }
            ],

            init: function() {
                this.step = 0;
                this.lives = 3;
                this.isLocked = false;
                this.renderStep();
                this.updateHealth();
            },

            renderStep: function() {
                if (this.step >= this.steps.length) return this.showWin();
                if (this.lives <= 0) return this.showGameOver();

                const data = this.steps[this.step];
                
                // Actualizar Textos
                document.getElementById('lab-context').innerText = data.context;
                document.getElementById('lab-instruction').innerText = data.instruction;
                document.getElementById('lab-icon').innerHTML = `<i class="${data.icon}"></i>`;
                
                // Limpiar Feedback
                const fb = document.getElementById('lab-feedback');
                fb.className = "mt-4 p-4 rounded-lg text-center font-bold text-lg opacity-0 transition-opacity min-h-[60px] flex items-center justify-center border-2 border-transparent";

                // Generar Botones (Estilo Tarjeta Limpia)
                const container = document.getElementById('lab-options');
                container.innerHTML = '';
                
                data.options.forEach((opt, idx) => {
                    // Si hay dos correctas (caso especial), marcamos ambas
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-4 bg-white border-2 border-slate-200 rounded-xl hover:border-blue-500 hover:shadow-lg transition-all group flex justify-between items-center";
                    btn.onclick = () => this.check(idx, btn, opt.correct);
                    
                    btn.innerHTML = `
                        <div>
                            <span class="block text-xl font-bold text-slate-800 group-hover:text-blue-700">${opt.text}</span>
                            <span class="block text-xs font-bold text-slate-400 uppercase tracking-wider">${opt.sub}</span>
                        </div>
                        <i class="fas fa-chevron-right text-slate-300 group-hover:text-blue-500 transition-colors"></i>
                    `;
                    container.appendChild(btn);
                });
                
                this.isLocked = false;
            },

            check: function(idx, btn, isCorrect) {
                if (this.isLocked) return;
                this.isLocked = true;

                const fb = document.getElementById('lab-feedback');

                if (isCorrect) {
                    // √âxito
                    btn.classList.remove('border-slate-200');
                    btn.classList.add('border-emerald-500', 'bg-emerald-50');
                    btn.querySelector('i').className = "fas fa-check text-emerald-600 text-xl";
                    
                    fb.innerText = "¬°SISTEMA ESTABILIZADO!";
                    fb.className = "mt-4 p-4 rounded-lg text-center font-bold text-lg min-h-[60px] flex items-center justify-center border-2 border-emerald-100 bg-emerald-50 text-emerald-700 animate-bounce-short";
                    fb.classList.remove('opacity-0');

                    setTimeout(() => {
                        this.step++;
                        this.renderStep();
                    }, 1500);

                } else {
                    // Error
                    this.lives--;
                    this.updateHealth();
                    
                    btn.classList.remove('border-slate-200');
                    btn.classList.add('border-red-500', 'bg-red-50', 'animate-shake');
                    btn.querySelector('i').className = "fas fa-times text-red-600 text-xl";
                    
                    fb.innerText = "¬°ERROR DE SINTAXIS! INESTABILIDAD AUMENTA.";
                    fb.className = "mt-4 p-4 rounded-lg text-center font-bold text-lg min-h-[60px] flex items-center justify-center border-2 border-red-100 bg-red-50 text-red-700";
                    fb.classList.remove('opacity-0');

                    setTimeout(() => {
                        btn.classList.remove('border-red-500', 'bg-red-50', 'animate-shake');
                        btn.classList.add('border-slate-200');
                        btn.querySelector('i').className = "fas fa-chevron-right text-slate-300";
                        this.isLocked = false;
                        if(this.lives <= 0) this.renderStep(); // Trigger game over check
                    }, 1500);
                }
            },

            updateHealth: function() {
                const container = document.getElementById('lab-health');
                container.innerHTML = '';
                for(let i=0; i<3; i++) {
                    const bar = document.createElement('div');
                    // Barras verdes que se vuelven grises o rojas al perder
                    if (i < this.lives) {
                        bar.className = "w-8 h-3 bg-emerald-500 rounded-full shadow-sm";
                    } else {
                        bar.className = "w-8 h-3 bg-slate-200 rounded-full";
                    }
                    container.appendChild(bar);
                }
            },

            showWin: function() {
                const container = document.querySelector('.slide-container');
                container.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-center animate-fade-in-up">
                        <div class="w-40 h-40 bg-blue-50 rounded-full flex items-center justify-center mb-8 shadow-xl border-4 border-white">
                            <i class="fas fa-clipboard-check text-7xl text-blue-600"></i>
                        </div>
                        <h2 class="text-5xl font-black text-slate-800 mb-4">CRISIS RESUELTA</h2>
                        <p class="text-xl text-slate-500 max-w-2xl mx-auto mb-8">
                            Has aplicado correctamente los protocolos de seguridad gramatical. El laboratorio es seguro.
                        </p>
                        <button onclick="Reveal.next()" class="px-10 py-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 hover:scale-105 transition-all text-lg flex items-center gap-3">
                            Continuar Misi√≥n <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                `;
                if(window.confetti) confetti({ particleCount: 150, spread: 70, colors: ['#3b82f6', '#10b981'] });
            },

            showGameOver: function() {
                 const container = document.querySelector('.slide-container');
                container.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-center animate-shake">
                        <div class="text-8xl text-red-500 mb-6"><i class="fas fa-radiation-alt"></i></div>
                        <h2 class="text-5xl font-black text-slate-800 mb-2">EVACUACI√ìN</h2>
                        <p class="text-xl text-red-600 font-bold mb-8">Fallos cr√≠ticos en la gram√°tica.</p>
                        <button onclick="labGame.init()" class="px-8 py-3 border-2 border-slate-300 text-slate-600 font-bold rounded-xl hover:bg-slate-100 hover:text-slate-800 transition-all">
                            Reiniciar Protocolo
                        </button>
                    </div>
                `;
            }
        };

        // Auto-iniciar
        setTimeout(() => labGame.init(), 500);
        if(window.Reveal) {
            Reveal.on('slidechanged', event => {
                if (event.currentSlide.getAttribute('data-state') === 'clean-crisis-lab') {
                    labGame.init();
                }
            });
        }
    </script>
    
    <style>
        .animate-bounce-short { animation: bounce-short 0.5s; }
        @keyframes bounce-short {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .animate-shake { animation: shake 0.5s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</section>

           <section data-state="concierge-game" class="bg-slate-100">
    
    <div class="absolute inset-0 overflow-hidden pointer-events-none opacity-10">
        <div class="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-slate-900 to-transparent"></div>
        <i class="fas fa-church absolute bottom-10 left-10 text-9xl text-slate-800"></i>
        <i class="fas fa-dove absolute top-20 right-20 text-6xl text-slate-800 animate-pulse"></i>
    </div>

    <div class="slide-container h-full flex flex-col items-center justify-center relative z-10 p-4 max-w-5xl mx-auto">

        <div class="w-full flex justify-between items-center mb-6 bg-white px-6 py-3 rounded-full shadow-lg border border-slate-200">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-amber-400 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-sm">
                    <i class="fas fa-concierge-bell"></i>
                </div>
                <div>
                    <h2 class="text-sm font-bold text-slate-400 uppercase tracking-widest">Concierge Desk</h2>
                    <p class="text-slate-800 font-bold leading-none">Hotel Plaza Bol√≠var</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-slate-400 text-sm font-bold uppercase">Reputaci√≥n:</span>
                <div id="star-rating" class="flex text-slate-200 text-xl">
                    <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                </div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-8 w-full h-[500px]">
            
            <div class="md:w-5/12 flex flex-col justify-center relative">
                <div class="bg-white p-8 rounded-3xl rounded-bl-none shadow-xl border border-slate-100 relative mb-4 transform transition-all hover:scale-105">
                    <div class="absolute -bottom-4 left-0 w-8 h-8 bg-white border-b border-r border-slate-100 transform rotate-45"></div> <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-xs font-bold uppercase mb-3 inline-block">
                        <i class="fas fa-user-tourist mr-1"></i> Turista
                    </span>
                    
                    <h3 id="tourist-problem" class="text-2xl font-bold text-slate-700 leading-snug">
                        </h3>
                    
                    <div class="mt-4 pt-4 border-t border-slate-100 text-slate-400 text-sm italic flex items-center gap-2">
                        <i class="fas fa-info-circle"></i> Pista: <span id="tourist-hint">Objeto: Las Esmeraldas</span>
                    </div>
                </div>

                <div class="flex items-center gap-4 mt-2">
                    <img src="https://ui-avatars.com/api/?name=Gringo+Turista&background=ef4444&color=fff&size=128" 
                         class="w-16 h-16 rounded-full border-4 border-white shadow-md" alt="Tourist">
                    <div class="text-slate-500 text-sm">
                        <p class="font-bold">Mr. Smith</p>
                        <p>Hu√©sped Habitaci√≥n 402</p>
                    </div>
                </div>
            </div>

            <div class="md:w-7/12 flex flex-col justify-center gap-4" id="options-container">
                </div>

        </div>
        
        <div id="concierge-feedback" class="absolute inset-0 bg-white/95 z-50 hidden flex-col items-center justify-center text-center p-8 rounded-3xl">
            <div id="fb-icon" class="text-8xl mb-6 drop-shadow-lg"></div>
            <h2 id="fb-title" class="text-4xl font-black text-slate-800 mb-2"></h2>
            <p id="fb-msg" class="text-xl text-slate-600 mb-8 max-w-lg"></p>
            <button onclick="conciergeGame.next()" class="px-8 py-4 bg-slate-800 text-white font-bold rounded-xl shadow-xl hover:scale-105 transition-transform">
                Siguiente Cliente <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>

    </div>

    <script>
        const conciergeGame = {
            qIndex: 0,
            score: 0,
            questions: [
                {
                    // CASO 1: ESMERALDAS (Femenino Plural)
                    problem: "Quiero comprar <u>unas esmeraldas</u> para mi esposa, pero tengo miedo de que sean falsas.",
                    hint: "Sustituye 'Esmeraldas' (Las) + Subjuntivo",
                    options: [
                        { 
                            text: "Te aconsejo que <b>los</b> compres en una joyer√≠a certificada.", 
                            feedback: "Incorrecto. 'Esmeraldas' es femenino (Las), no masculino (Los).", 
                            correct: false,
                            type: "grammar" 
                        },
                        { 
                            text: "Sugiero que <b>las</b> compres en el mercado negro, es m√°s barato.", 
                            feedback: "¬°Peligroso! Gramaticalmente bien, pero l√≥gicamente es un p√©simo consejo.", 
                            correct: false,
                            type: "logic"
                        },
                        { 
                            text: "Es importante que <b>las</b> compres en el Centro Internacional.", 
                            feedback: "¬°Perfecto! 'Las' (esmeraldas) + 'Compres' (Subjuntivo) + Buen consejo.", 
                            correct: true,
                            type: "correct"
                        }
                    ]
                },
                {
                    // CASO 2: MUSEO DEL ORO (Masculino Singular)
                    problem: "No he visitado <u>el Museo del Oro</u> y me voy ma√±ana.",
                    hint: "Sustituye 'El Museo' (Lo) + Urgencia",
                    options: [
                        { 
                            text: "Te recomiendo que <b>lo</b> visites hoy mismo, cierra a las 6.", 
                            feedback: "¬°Exacto! 'Lo' (Museo) + Visites + L√≥gica de tiempo.", 
                            correct: true,
                            type: "correct"
                        },
                        { 
                            text: "Te recomiendo que <b>la</b> visites ma√±ana por la ma√±ana.", 
                            feedback: "Error. 'Museo' es masculino (Lo). Adem√°s, ma√±ana ya se va.", 
                            correct: false,
                            type: "grammar"
                        },
                        { 
                            text: "Es mejor que <b>lo</b> visitas ahora.", 
                            feedback: "Error gramatical. Con 'Es mejor que' necesitas Subjuntivo (Visites), no Indicativo (Visitas).", 
                            correct: false,
                            type: "grammar"
                        }
                    ]
                },
                {
                    // CASO 3: AJIACO (Masculino Singular) + GUSTO
                    problem: "Tengo mucha hambre y quiero probar <u>el ajiaco</u>.",
                    hint: "Sustituye 'Ajiaco' (Lo) + Sugerencia",
                    options: [
                        { 
                            text: "Dudo que <b>lo</b> pruebes, es muy feo.", 
                            feedback: "¬°Qu√© mal conserje! El ajiaco es delicioso y el cliente tiene hambre.", 
                            correct: false,
                            type: "logic"
                        },
                        { 
                            text: "Sugiero que <b>lo</b> pidas en La Puerta Falsa.", 
                            feedback: "¬°Excelente! Recomendaci√≥n cl√°sica + Gram√°tica perfecta.", 
                            correct: true,
                            type: "correct"
                        },
                        { 
                            text: "Quiero que <b>lo</b> pruebas con aguacate.", 
                            feedback: "Casi. 'Quiero que' exige Subjuntivo: PruebEs (no PruebAs).", 
                            correct: false,
                            type: "grammar"
                        }
                    ]
                }
            ],

            init: function() {
                this.qIndex = 0;
                this.score = 0;
                this.updateStars();
                this.renderQuestion();
                document.getElementById('concierge-feedback').classList.add('hidden');
                document.getElementById('concierge-feedback').classList.remove('flex');
            },

            renderQuestion: function() {
                if(this.qIndex >= this.questions.length) return this.finishGame();

                const q = this.questions[this.qIndex];
                
                // Render Problem
                document.getElementById('tourist-problem').innerHTML = q.problem;
                document.getElementById('tourist-hint').innerText = q.hint;

                // Render Options
                const container = document.getElementById('options-container');
                container.innerHTML = '';

                // Barajar opciones para que no siempre sea la misma posici√≥n
                const shuffledOptions = [...q.options].sort(() => Math.random() - 0.5);

                shuffledOptions.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left bg-white p-5 rounded-xl border-l-8 border-slate-300 shadow-sm hover:shadow-md hover:border-amber-400 hover:bg-amber-50 transition-all group relative overflow-hidden";
                    btn.onclick = () => this.checkAnswer(opt);
                    
                    btn.innerHTML = `
                        <div class="flex justify-between items-center relative z-10">
                            <span class="text-slate-700 text-lg group-hover:text-slate-900">${opt.text}</span>
                            <i class="fas fa-chevron-right text-slate-300 group-hover:text-amber-500 transition-colors"></i>
                        </div>
                    `;
                    container.appendChild(btn);
                });
            },

            checkAnswer: function(option) {
                const overlay = document.getElementById('concierge-feedback');
                const title = document.getElementById('fb-title');
                const msg = document.getElementById('fb-msg');
                const icon = document.getElementById('fb-icon');

                overlay.classList.remove('hidden');
                overlay.classList.add('flex');

                if (option.correct) {
                    this.score++;
                    this.updateStars();
                    title.innerText = "¬°Excelente Recomendaci√≥n!";
                    title.className = "text-3xl font-black text-emerald-600 mb-2";
                    msg.innerText = option.feedback;
                    icon.innerHTML = "üåü";
                    if(window.confetti) confetti({ particleCount: 100, spread: 60, origin: { y: 0.6 } });
                } else {
                    title.innerText = "Cliente Insatisfecho...";
                    title.className = "text-3xl font-black text-red-500 mb-2";
                    msg.innerText = option.feedback;
                    
                    if(option.type === 'logic') icon.innerHTML = "ü§¶‚Äç‚ôÇÔ∏è"; // Error l√≥gico
                    else icon.innerHTML = "üìñ"; // Error gramatical
                }
            },

            next: function() {
                document.getElementById('concierge-feedback').classList.add('hidden');
                document.getElementById('concierge-feedback').classList.remove('flex');
                this.qIndex++;
                this.renderQuestion();
            },

            updateStars: function() {
                const container = document.getElementById('star-rating');
                container.innerHTML = '';
                // Calculamos estrellas basadas en respuestas correctas acumuladas
                // Simple visual logic: gold stars for score
                for(let i=0; i<5; i++) {
                    const iTag = document.createElement('i');
                    // L√≥gica visual: pintar estrellas seg√∫n progreso
                    if (i < this.score + 2) iTag.className = "fas fa-star text-amber-400 drop-shadow-sm";
                    else iTag.className = "fas fa-star text-slate-200";
                    container.appendChild(iTag);
                }
            },

            finishGame: function() {
                const container = document.querySelector('.slide-container');
                container.innerHTML = `
                    <div class="text-center animate-fade-in-up p-8">
                        <div class="w-32 h-32 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-6 border-4 border-white shadow-xl">
                            <i class="fas fa-award text-6xl text-amber-500"></i>
                        </div>
                        <h2 class="text-4xl font-black text-slate-800 mb-4">¬°Empleado del Mes!</h2>
                        <p class="text-xl text-slate-600 mb-8 max-w-xl mx-auto">
                            Has demostrado que no solo sabes gram√°tica, sino que tienes sentido com√∫n para tratar a los turistas.
                        </p>
                        <div class="flex justify-center gap-4">
                            <button onclick="conciergeGame.init()" class="text-slate-500 font-bold hover:text-slate-800 underline">Reiniciar Turno</button>
                            <button onclick="Reveal.next()" class="bg-slate-800 text-white px-8 py-3 rounded-xl font-bold hover:bg-slate-700 shadow-lg">Terminar D√≠a</button>
                        </div>
                    </div>
                `;
            }
        };

        setTimeout(() => conciergeGame.init(), 500);
        if(window.Reveal) {
            Reveal.on('slidechanged', event => {
                if (event.currentSlide.getAttribute('data-state') === 'concierge-game') {
                    conciergeGame.init();
                }
            });
        }
    </script>
</section>

            <script>
                // 1. L√≥gica para botones de opci√≥n simple
                function selectOption(btn, isCorrect) {
                    // Reset siblings
                    let parent = btn.parentElement;
                    let siblings = parent.getElementsByTagName('button');
                    for (let s of siblings) {
                        s.classList.remove('bg-emerald-500', 'text-white', 'bg-red-500');
                        s.classList.add('text-slate-600');
                    }

                    if (isCorrect) {
                        btn.classList.remove('text-slate-600');
                        btn.classList.add('bg-emerald-500', 'text-white', 'border-emerald-500');
                        if (typeof react === 'function') react('confetti'); // Si existe la funci√≥n de confetti
                    } else {
                        btn.classList.remove('text-slate-600');
                        btn.classList.add('bg-red-500', 'text-white', 'border-red-500');
                        setTimeout(() => {
                            btn.classList.remove('bg-red-500', 'text-white', 'border-red-500');
                            btn.classList.add('text-slate-600');
                        }, 1000);
                    }
                }

                // 2. L√≥gica para Inputs de texto (Slide Hotel)
                function validateInput(input, correctAnswers) {
                    let val = input.value.toLowerCase().trim();
                    if (correctAnswers.includes(val)) {
                        input.classList.remove('incorrect');
                        input.classList.add('correct');
                    } else {
                        input.classList.add('incorrect');
                    }
                }

                // 3. L√≥gica para reemplazar texto (Slide Maleta)
                function checkAnswer(slotId, correctText, isCorrect) {
                    const slot = document.getElementById(slotId);
                    if (isCorrect) {
                        slot.innerText = correctText;
                        slot.classList.remove('text-orange-600', 'border-orange-400');
                        slot.classList.add('text-emerald-600', 'border-emerald-500');
                    }
                }

                // 4. L√≥gica de Matching (Slide 5)
                let selectedTrigger = null;

                // Asignar listeners a los botones de la izquierda
                document.querySelectorAll('.match-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        // Limpiar selecci√≥n previa
                        document.querySelectorAll('.match-btn').forEach(b => b.classList.remove('ring-4', 'ring-yellow-200', 'bg-yellow-50'));

                        // Activar actual
                        this.classList.add('ring-4', 'ring-yellow-200', 'bg-yellow-50');
                        selectedTrigger = this.dataset.pair;
                    });
                });

                function checkMatch(targetBtn, targetId) {
                    if (!selectedTrigger) return;

                    if (selectedTrigger === targetId) {
                        // Match Correcto
                        targetBtn.classList.remove('bg-slate-100', 'border-dashed');
                        targetBtn.classList.add('bg-emerald-100', 'border-emerald-500', 'text-emerald-800');
                        targetBtn.innerHTML = '<i class="fas fa-link mr-2"></i> ' + targetBtn.innerText;

                        // Deshabilitar el bot√≥n izquierdo
                        const triggerBtn = document.querySelector(`.match-btn[data-pair="${selectedTrigger}"]`);
                        triggerBtn.classList.add('opacity-50', 'pointer-events-none');
                        triggerBtn.classList.remove('ring-4', 'ring-yellow-200');

                        document.getElementById('match-feedback').style.opacity = '1';
                        setTimeout(() => document.getElementById('match-feedback').style.opacity = '0', 2000);

                        selectedTrigger = null;
                    } else {
                        // Error
                        targetBtn.classList.add('animate-shake', 'bg-red-100');
                        setTimeout(() => targetBtn.classList.remove('animate-shake', 'bg-red-100'), 500);
                    }
                }
            </script>


            

           

            <section data-state="homework-slide" class="bg-slate-900">

    <div class="absolute inset-0 overflow-hidden pointer-events-none">
        <div class="absolute inset-0 bg-cover bg-center opacity-30 saturate-50"
             style="background-image: url('https://images.unsplash.com/photo-1583531352515-8884af319dc1?q=80&w=1920&auto=format&fit=crop');">
        </div>
        <div class="absolute inset-0 bg-gradient-to-t from-slate-950 via-slate-900/80 to-slate-900/90"></div>
    </div>

    <div class="slide-container h-full flex flex-col items-center relative z-10 p-6 max-w-6xl mx-auto">

        <div class="mb-8 animate-fade-in">
            <img src="https://tucaneo.com/wp-content/uploads/2025/11/Plantilla-2-e1764351536337.png" 
                 alt="Tucaneo Logo" 
                 class="h-24 md:h-28 object-contain mx-auto drop-shadow-lg">
        </div>

        <div class="flex-1 w-full flex gap-8 items-stretch animate-fade-in-up">

            <div class="w-5/12 bg-white/10 backdrop-blur-md rounded-2xl border border-white/20 p-8 text-white flex flex-col justify-center shadow-2xl">
                
                <h2 class="text-3xl font-black mb-4 flex items-center gap-3 text-cyan-400">
                    <i class="fas fa-pencil-alt"></i>
                    Tarea Final: La Bit√°cora
                </h2>
                
                <p class="text-lg text-slate-200 leading-relaxed mb-8 font-light">
                    Tu viaje virtual ha terminado. Como explorador de Tucaneo, debes escribir la √∫ltima entrada en tu diario de viaje antes de regresar a casa.
                </p>

                <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                    <h3 class="text-sm font-bold uppercase tracking-widest text-cyan-500 mb-4">
                        Requisitos de Publicaci√≥n:
                    </h3>
                    <ul class="space-y-4 font-medium">
                        <li class="flex items-start gap-3">
                            <i class="fas fa-check-circle text-emerald-500 mt-1"></i>
                            <div>
                                <span class="block text-white">Usa 2 verbos de DESEO o ESPERANZA.</span>
                                <span class="text-slate-400 text-sm italic">(Ej: Ojal√° regrese pronto, Espero que...)</span>
                            </div>
                        </li>
                        <li class="flex items-start gap-3">
                            <i class="fas fa-check-circle text-emerald-500 mt-1"></i>
                            <div>
                                <span class="block text-white">Usa 1 expresi√≥n IMPERSONAL.</span>
                                <span class="text-slate-400 text-sm italic">(Ej: Es importante que los turistas...)</span>
                            </div>
                        </li>
                        <li class="flex items-start gap-3">
                            <i class="fas fa-check-circle text-emerald-500 mt-1"></i>
                            <div>
                                <span class="block text-white">Sustituye 2 objetos con PRONOMBRES (Lo, la, los, las...).</span>
                                <span class="text-slate-400 text-sm italic">(Ej: ¬øEl caf√©? ¬°Lo tom√© ayer!)</span>
                            </div>
                        </li>
                    </ul>
                </div>

            </div>

            <div class="w-7/12 relative group">
                <div class="absolute -inset-2 bg-gradient-to-r from-cyan-500 to-blue-600 rounded-3xl blur opacity-30 group-hover:opacity-50 transition duration-1000"></div>
                
                <div class="relative h-full bg-slate-50 rounded-2xl shadow-inner overflow-hidden flex flex-col">
                    <div class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center text-slate-400 text-sm">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-book-open text-cyan-600"></i>
                            <span class="font-bold text-slate-700">Tucaneo Travel Journal_</span>
                        </div>
                        <span>Borrador Guardado <i class="fas fa-check ml-1"></i></span>
                    </div>
                    
                    <div class="flex-1 p-8 text-slate-600 font-serif text-lg leading-loose overflow-y-auto"
                         style="background-image: linear-gradient(#e2e8f0 1px, transparent 1px); background-size: 100% 2rem; background-position-y: 1.9rem;">
                        
                        <p class="text-slate-400 italic mb-4">[Escribe tu entrada aqu√≠...]</p>
                        
                        <p>
                            <span class="font-bold text-slate-800">Fecha:</span> 15 de Octubre, 2023<br>
                            <span class="font-bold text-slate-800">Ubicaci√≥n:</span> Aeropuerto El Dorado, Bogot√°
                            <br><br>
                            ¬°Qu√© viaje incre√≠ble! No puedo creer que ya termin√≥. Es una l√°stima que el tiempo pase tan r√°pido... 
                            <br><br>
                            (Contin√∫a tu historia...)
                        </p>
                        
                        <span class="inline-block w-0.5 h-5 bg-cyan-500 animate-pulse ml-1"></span>
                    </div>

                    <div class="p-4 bg-white border-t border-slate-100 text-right">
                        <button class="px-6 py-2 bg-cyan-600 text-white font-bold rounded-lg shadow hover:bg-cyan-700 flex items-center gap-2 ml-auto pointer-events-none opacity-80">
                            Publicar Entrada <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>

                </div>
            </div>

        </div>

    </div>
</section>



            

            <script>
                const logicGame = {
                    state: {
                        level: 0,
                        do: { gender: null, number: null },
                        io: { person: null },
                        doResult: null,
                        ioResult: null,
                        sequence: []
                    },
                    levels: [
                        {
                            sentence: '¬°<span class="text-blue-400 font-bold border-b border-blue-400/50">Da</span> <span class="text-cyan-300 bg-cyan-900/30 px-1 rounded">la comida</span> <span class="text-purple-300 bg-purple-900/30 px-1 rounded">a los cerdos</span>!',
                            doTarget: 'la comida',
                            ioTarget: 'a los cerdos',
                            solutions: { // Target properties to check logic
                                do: { g: 'f', n: 's' },
                                io: { p: 'les' }
                            },
                            generated: { do: 'LA', io: 'LES' },
                            verb: 'DA',
                            mode: 'imperative', // Verb comes first, pronouns attached
                            correctSequence: ['DA', 'SE', 'LA'], // Logic handles transformation
                            displayVerb: 'DA'
                        },
                        {
                            sentence: '¬°<span class="text-red-400 font-bold">No</span> <span class="text-blue-400 font-bold border-b border-blue-400/50">abras</span> <span class="text-cyan-300 bg-cyan-900/30 px-1 rounded">la puerta</span> <span class="text-purple-300 bg-purple-900/30 px-1 rounded">al toro</span>!',
                            doTarget: 'la puerta',
                            ioTarget: 'al toro',
                            solutions: {
                                do: { g: 'f', n: 's' },
                                io: { p: 'le' }
                            },
                            generated: { do: 'LA', io: 'LE' },
                            verb: 'ABRAS',
                            mode: 'negative', // No + Pronoun + Pronoun + Verb
                            correctSequence: ['NO', 'SE', 'LA', 'ABRAS'],
                            displayVerb: 'ABRAS'
                        }
                    ],

                    init: function () {
                        this.loadLevel(0);
                    },

                    loadLevel: function (idx) {
                        this.state.level = idx;
                        this.state.do = { gender: null, number: null };
                        this.state.io = { person: null };
                        this.state.doResult = null;
                        this.state.ioResult = null;
                        this.state.sequence = [];

                        const lvl = this.levels[idx];

                        // UI Reset
                        document.getElementById('logic-sentence').innerHTML = lvl.sentence;
                        document.getElementById('do-target').innerText = lvl.doTarget.toUpperCase();
                        document.getElementById('io-target').innerText = lvl.ioTarget.toUpperCase();

                        document.getElementById('do-result').classList.add('scale-0');
                        document.getElementById('io-result').classList.add('scale-0');
                        document.getElementById('assembly-area').classList.add('hidden');
                        document.getElementById('analysis-panel').classList.remove('opacity-50', 'pointer-events-none');

                        // Reset buttons
                        document.querySelectorAll('.logic-btn').forEach(b => {
                            b.classList.remove('bg-cyan-500', 'text-white', 'border-cyan-400', 'shadow-[0_0_15px_rgba(6,182,212,0.5)]');
                            b.classList.add('text-slate-400', 'border-slate-700');
                        });

                        // Level dots
                        const dotsContainer = document.getElementById('level-dots');
                        dotsContainer.innerHTML = '';
                        this.levels.forEach((_, i) => {
                            let dot = document.createElement('div');
                            dot.className = `w-3 h-3 rounded-full ${i === idx ? 'bg-cyan-400 shadow-[0_0_10px_rgb(34,211,238)]' : 'bg-slate-700'}`;
                            dotsContainer.appendChild(dot);
                        });
                    },

                    setProp: function (type, prop, val, btn) {
                        // Update State
                        if (type === 'do') this.state.do[prop] = val;
                        if (type === 'io') this.state.io[prop] = val;

                        // Visuals for buttons
                        let parent = btn.parentElement;
                        Array.from(parent.children).forEach(b => {
                            b.classList.remove('bg-cyan-500', 'text-white', 'border-cyan-400', 'shadow-[0_0_15px_rgba(6,182,212,0.5)]');
                            b.classList.add('text-slate-400', 'border-slate-700');
                        });
                        btn.classList.remove('text-slate-400', 'border-slate-700');
                        btn.classList.add('bg-cyan-500', 'text-white', 'border-cyan-400', 'shadow-[0_0_15px_rgba(6,182,212,0.5)]');

                        this.checkAnalysis();
                    },

                    checkAnalysis: function () {
                        const lvl = this.levels[this.state.level];

                        // Check DO
                        if (this.state.do.gender && this.state.do.number) {
                            let res = '';
                            if (this.state.do.gender === 'm' && this.state.do.number === 's') res = 'LO';
                            else if (this.state.do.gender === 'f' && this.state.do.number === 's') res = 'LA';
                            else if (this.state.do.gender === 'm' && this.state.do.number === 'p') res = 'LOS';
                            else if (this.state.do.gender === 'f' && this.state.do.number === 'p') res = 'LAS';

                            this.state.doResult = res;
                            let el = document.getElementById('do-result');
                            el.innerText = res;
                            el.classList.remove('scale-0');
                        }

                        // Check IO
                        if (this.state.io.person) {
                            let p = this.state.io.person;
                            let res = 'SE'; // Default fallback?
                            if (p === 'me') res = 'ME';
                            else if (p === 'te') res = 'TE';
                            else if (p === 'le') res = 'LE';
                            else if (p === 'nos') res = 'NOS';
                            else if (p === 'os') res = 'OS';
                            else if (p === 'les') res = 'LES';

                            this.state.ioResult = res;
                            let el = document.getElementById('io-result');
                            el.innerText = res;
                            el.classList.remove('scale-0');
                        }

                        // Unlocking Phase 2
                        if (this.state.doResult && this.state.ioResult) {
                            setTimeout(() => {
                                this.startAssembly();
                            }, 500);
                        }
                    },

                    startAssembly: function () {
                        const lvl = this.levels[this.state.level];
                        document.getElementById('analysis-panel').classList.add('opacity-50', 'pointer-events-none');
                        document.getElementById('assembly-area').classList.remove('hidden');

                        // Prepare Tokens
                        const pool = document.getElementById('token-pool');
                        pool.innerHTML = '';
                        this.state.sequence = [];

                        // Correct items based on USER selection (allowing for errors)
                        let items = [lvl.displayVerb, this.state.ioResult, this.state.doResult];
                        if (lvl.mode === 'negative') items.push('NO');

                        // Create tokens
                        items.forEach(txt => {
                            let btn = document.createElement('button');
                            btn.className = 'token-btn px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded border border-slate-500 shadow-lg transform transition active:scale-95';
                            btn.innerText = txt;
                            btn.onclick = () => this.addToSequence(txt, btn);
                            pool.appendChild(btn);
                        });

                        this.renderSlots();
                    },

                    addToSequence: function (txt, btn) {
                        this.state.sequence.push(txt);
                        btn.remove();
                        this.renderSlots();
                    },

                    renderSlots: function () {
                        const container = document.getElementById('sequence-slots');
                        container.innerHTML = '';

                        // Render current sequence
                        this.state.sequence.forEach((txt, idx) => {
                            let div = document.createElement('div');
                            div.className = 'p-3 bg-cyan-900/50 border border-cyan-500 text-cyan-100 font-bold rounded animate-bounce-short cursor-pointer hover:bg-red-900/50';
                            div.innerText = txt;
                            div.title = "Clic para quitar";
                            div.onclick = () => this.removeFromSequence(idx, txt);
                            container.appendChild(div);
                        });

                        // Empty slot hint
                        if (this.state.sequence.length < (this.levels[this.state.level].mode === 'negative' ? 4 : 3)) {
                            let div = document.createElement('div');
                            div.className = 'w-12 h-12 border-2 border-dashed border-slate-600 rounded flex items-center justify-center text-slate-600';
                            div.innerText = '+';
                            container.appendChild(div);
                        }
                    },

                    removeFromSequence: function (idx, txt) {
                        this.state.sequence.splice(idx, 1);

                        // Return to pool
                        const pool = document.getElementById('token-pool');
                        let btn = document.createElement('button');
                        btn.className = 'token-btn px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded border border-slate-500 shadow-lg transform transition active:scale-95';
                        btn.innerText = txt;
                        btn.onclick = () => this.addToSequence(txt, btn);
                        pool.appendChild(btn);

                        this.renderSlots();
                    },

                    execute: function () {
                        const lvl = this.levels[this.state.level];
                        const seq = this.state.sequence;
                        const errorMsg = document.getElementById('logic-error-msg');

                        let compiled = [...seq];

                        // "Lala" Rule Check (Le la -> Se la)
                        let hasLala = false;
                        for (let i = 0; i < compiled.length - 1; i++) {
                            if ((compiled[i] === 'LE' || compiled[i] === 'LES') &&
                                (compiled[i + 1] === 'LO' || compiled[i + 1] === 'LA' || compiled[i + 1] === 'LOS' || compiled[i + 1] === 'LAS')) {
                                hasLala = true;
                                compiled[i] = 'SE'; // Auto-fix with effect
                            }
                        }

                        // Compare with correct sequence
                        let isCorrect = JSON.stringify(compiled) === JSON.stringify(lvl.correctSequence);

                        const container = document.getElementById('sequence-slots');

                        if (isCorrect) {
                            // Success
                            container.innerHTML = `<div class="text-3xl text-green-400 font-bold tracking-widest animate-pulse drop-shadow-[0_0_10px_rgba(74,222,128,0.8)]">
                                ${compiled.join('')}
                            </div>`;
                            document.getElementById('btn-execute').classList.add('hidden');
                            document.getElementById('token-pool').innerHTML = '';

                            // Play success sound logic if available
                            if (typeof react === 'function') react('confetti');

                            setTimeout(() => {
                                if (this.state.level < this.levels.length - 1) {
                                    this.loadLevel(this.state.level + 1);
                                } else {
                                    alert("¬°TODAS LAS COMUNICACIONES COMPLETADAS!");
                                }
                            }, 2500);

                        } else {
                            // Fail
                            errorMsg.classList.remove('hidden');
                            container.classList.add('animate-shake');
                            setTimeout(() => {
                                container.classList.remove('animate-shake');
                                errorMsg.classList.add('hidden');
                            }, 1000);
                        }
                    }
                };

                // Init game when slide loads or script runs
                setTimeout(() => logicGame.init(), 500);
            </script>



            <script>
                // 1. LOGICA DE SELECCI√ìN SIMPLE (Slide 12)
                function farmCheck(btn, isCorrect) {
                    // Reset styles in current group
                    let parent = btn.parentElement;
                    let siblings = parent.getElementsByTagName('button');
                    for (let s of siblings) {
                        s.classList.remove('bg-red-500', 'text-white', 'hover:bg-red-500', 'bg-emerald-500', 'hover:bg-emerald-500');
                        s.classList.add('bg-stone-100');

                        // remove icons if any
                        let icon = s.querySelector('.fas');
                        if (icon && !s.classList.contains('group-btn')) icon.remove();
                    }

                    if (isCorrect) {
                        btn.classList.remove('bg-stone-100');
                        btn.classList.add('bg-emerald-500', 'text-white');
                        if (typeof react === 'function') react('success');
                    } else {
                        btn.classList.remove('bg-stone-100');
                        btn.classList.add('bg-red-500', 'text-white');
                        setTimeout(() => {
                            btn.classList.remove('bg-red-500', 'text-white');
                            btn.classList.add('bg-stone-100');
                        }, 1000);
                        if (typeof react === 'function') react('error');
                    }
                }

                // NEW: Chat Validation Logic
                function validateChat(input, correctAnswers, step) {
                    let val = input.value.toLowerCase().trim();
                    let card = input.closest('.bg-blue-600\\/90'); // Find the card container
                    let feedback = card.querySelector('.feedback-msg');

                    // Allow partial matching if needed, but here we want strict phrasing
                    if (correctAnswers.includes(val)) {
                        // Correct
                        input.classList.remove('border-blue-300', 'text-white');
                        input.classList.add('bg-emerald-500', 'border-emerald-400', 'text-white', 'shadow-[0_0_10px_rgba(16,185,129,0.5)]');
                        input.disabled = true; // Lock input

                        feedback.innerText = "¬°Excelente!";
                        feedback.classList.add('text-green-300');

                        // Play sound or effect
                        if (typeof react === 'function') react('success');

                        // Unlock next step
                        if (step === 1) {
                            document.getElementById('chat-step-2').classList.remove('hidden-step', 'opacity-0');
                            document.getElementById('water-level').style.height = '30%'; // Visual Flair

                            setTimeout(() => {
                                let nextInputContainer = document.getElementById('chat-input-2');
                                nextInputContainer.classList.remove('hidden-step', 'opacity-0', 'translate-y-4');
                                nextInputContainer.querySelector('input').focus();
                            }, 1500);
                        } else if (step === 2) {
                            document.getElementById('chat-step-3').classList.remove('hidden-step', 'opacity-0');
                            document.getElementById('water-level').style.height = '60%';

                            setTimeout(() => {
                                let nextInputContainer = document.getElementById('chat-input-3');
                                nextInputContainer.classList.remove('hidden-step', 'opacity-0', 'translate-y-4');
                                nextInputContainer.querySelector('input').focus();
                            }, 1500);
                        } else if (step === 3) {
                            document.getElementById('water-level').style.height = '0%'; // Fix problem
                            document.getElementById('water-level').classList.remove('from-blue-500/20');
                            document.getElementById('water-level').classList.add('from-emerald-500/20');

                            setTimeout(() => {
                                document.getElementById('chat-success').classList.remove('hidden-step', 'opacity-0', 'scale-90');
                                if (typeof react === 'function') react('party');
                            }, 500);
                        }

                    } else {
                        // Incorrect
                        input.classList.add('animate-shake', 'bg-red-500/50', 'border-red-400');
                        feedback.innerText = "Intenta otra vez...";
                        feedback.classList.add('text-red-300');

                        setTimeout(() => {
                            input.classList.remove('animate-shake', 'bg-red-500/50', 'border-red-400');
                            feedback.innerText = "";
                        }, 1000);
                    }
                }


                // 2. LOGICA DE SELECT (Slide 13 - Accidentes)
                function checkAccident(select, correctVal) {
                    let parent = select.parentElement.parentElement;
                    let feedback = parent.querySelector('.feedback-text');

                    if (select.value === correctVal) {
                        select.classList.remove('border-stone-500', 'text-white');
                        select.classList.add('border-green-500', 'text-green-400', 'font-bold');
                        feedback.innerText = "¬°Bien! No fue tu culpa üòâ";
                    } else {
                        select.classList.add('border-red-500');
                        feedback.innerText = "Incorrecto. Usa 'Se me...'";
                        setTimeout(() => select.classList.remove('border-red-500'), 1000);
                    }
                }

                // 3. LOGICA DE ORDENES (Slide 14)
                function orderCheck(btn, isCorrect) {
                    if (isCorrect) {
                        btn.innerHTML = '<i class="fas fa-check mr-2"></i> ¬°Exacto!';
                        btn.classList.remove('bg-white', 'text-stone-600', 'hover:border-blue-500', 'hover:text-blue-600');
                        btn.classList.add('bg-green-600', 'text-white', 'border-green-600');
                    } else {
                        btn.classList.add('bg-red-100', 'animate-shake');
                        setTimeout(() => btn.classList.remove('bg-red-100', 'animate-shake'), 500);
                    }
                }

                // 4. LOGICA DE COSECHA (Slide 15)
                let harvestScore = 0;
                function fillHarvest(spanId, text, isCorrect) {
                    let span = document.getElementById(spanId);
                    if (isCorrect) {
                        span.innerText = text;
                        span.classList.remove('border-white');
                        span.classList.add('text-green-400', 'border-green-400', 'font-bold');

                        // Visual effect
                        harvestScore++;
                        if (harvestScore >= 1) { // Simple logic: grow on first correct
                            document.getElementById('plant-grow').classList.remove('scale-0');
                            document.getElementById('plant-grow').classList.add('scale-100');
                        }
                        if (harvestScore >= 2) {
                            document.getElementById('plant-msg').classList.remove('opacity-0');
                            if (typeof react === 'function') react('confetti');
                        }
                    } else {
                        span.innerText = text;
                        span.classList.add('text-red-400', 'line-through');
                        setTimeout(() => {
                            span.innerText = "_____";
                            span.classList.remove('text-red-400', 'line-through');
                        }, 1000);
                    }
                }
            </script>




        </div>
    </div>

    <script type="text/babel">
        // --- REACT COMPONENTS (L√≥gica Corregida) ---
        const { useState, useEffect, useRef, useLayoutEffect } = React;

        // Iconos
        const Icon = ({ p }) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{p}</svg>;
        const I = {
            Pencil: <Icon p={<><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" /><path d="m15 5 4 4" /></>} />,
            Eraser: <Icon p={<><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21" /><path d="M22 21H7" /><path d="m5 11 9 9" /></>} />,
            Square: <Icon p={<rect width="18" height="18" x="3" y="3" rx="2" />} />,
            Circle: <Icon p={<circle cx="12" cy="12" r="10" />} />,
            Type: <Icon p={<><polyline points="4 7 4 4 20 4 20 7" /><line x1="9" x2="15" y1="20" y2="20" /><line x1="12" x2="12" y1="4" y2="20" /></>} />,
            Line: <Icon p={<line x1="5" y1="12" x2="19" y2="12" />} />,
            Undo: <Icon p={<><path d="M3 7v6h6" /><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13" /></>} />,
            Redo: <Icon p={<><path d="M21 7v6h-6" /><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 3.7" /></>} />,
            Trash: <Icon p={<><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></>} />,
            Save: <Icon p={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></>} />,
            Pointer: <Icon p={<><path d="m3 3 7.07 16.97 2.51-7.39 7.39-2.51L3 3z" /><path d="m13 13 6 6" /></>} />,
            Book: <Icon p={<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />} />,
            Art: <Icon p={<circle cx="13.5" cy="6.5" r=".5" />} />,
            Copy: <Icon p={<rect width="14" height="14" x="8" y="8" rx="2" />} />
        };

        const getHandles = (el) => { const pad = 0; const x = el.x; const y = el.y; const w = el.width; const h = el.height; return { tl: { x: x - pad, y: y - pad, cursor: 'nwse-resize' }, tr: { x: x + w + pad, y: y - pad, cursor: 'nesw-resize' }, bl: { x: x - pad, y: y + h + pad, cursor: 'nesw-resize' }, br: { x: x + w + pad, y: y + h + pad, cursor: 'nwse-resize' } }; };
        const isPointInHandle = (x, y, handle) => { const size = 12; return x >= handle.x - size && x <= handle.x + size && y >= handle.y - size && y <= handle.y + size; };

        // --- GLOSARIO (Sin cambios) ---
        function VocabModule() { const [list, setList] = useState(() => { try { return JSON.parse(localStorage.getItem('tucaneo_vocab') || '[]'); } catch { return []; } }); const [w, setW] = useState(''); const [d, setD] = useState(''); const [manualCopy, setManualCopy] = useState(null); useEffect(() => { try { localStorage.setItem('tucaneo_vocab', JSON.stringify(list)); } catch { } }, [list]); const add = (e) => { e.preventDefault(); if (!w.trim()) return; setList([...list, { w, d }]); setW(''); setD(''); }; const copy = () => { const text = list.map(i => `${i.w}: ${i.d}`).join('\n'); if (!text) return alert("Lista vac√≠a"); try { navigator.clipboard.writeText(text).then(() => alert("Copiado!"), () => setManualCopy(text)); } catch { setManualCopy(text); } }; return (<div className="flex flex-col h-full bg-slate-50 p-6 pt-8 relative font-sans"> {manualCopy && <div className="absolute inset-0 bg-black/50 z-50 flex items-center justify-center p-4"><div className="bg-white p-4 rounded-xl w-full max-w-sm shadow-2xl"><p className="font-bold mb-2 text-emerald-800 font-playfair">Copiar datos:</p><textarea className="w-full h-32 border p-2 rounded-lg" readOnly value={manualCopy} onClick={e => e.target.select()} /><button onClick={() => setManualCopy(null)} className="w-full bg-slate-800 text-white py-2 mt-2 rounded-lg">Cerrar</button></div></div>} <h2 className="text-xl font-bold text-emerald-800 mb-4 flex gap-2 font-playfair">{I.Book} Glosario</h2> <form onSubmit={add} className="bg-white p-4 rounded-xl shadow-sm mb-4 border border-emerald-100"><input value={w} onChange={e => setW(e.target.value)} placeholder="T√©rmino" className="w-full border-b p-2 mb-2 outline-none focus:border-orange-500 font-bold text-slate-700" /><input value={d} onChange={e => setD(e.target.value)} placeholder="Definici√≥n" className="w-full border-b p-2 outline-none focus:border-orange-500 text-slate-500" /><button type="submit" className="w-full bg-orange-500 text-white py-2 rounded-lg font-bold hover:bg-orange-600 mt-2 shadow-md transition">A√±adir</button></form> <div className="flex-1 overflow-y-auto bg-white rounded-xl border border-slate-200 p-4 shadow-inner mb-4"><ul className="space-y-3">{list.map((i, k) => (<li key={k} className="flex justify-between border-b border-slate-50 pb-2"><div><span className="block font-bold text-slate-700">{i.w}</span><span className="text-sm text-slate-400 italic">{i.d}</span></div><button onClick={() => setList(list.filter((_, x) => x !== k))} className="text-red-300 hover:text-red-500 bg-red-50 w-6 h-6 rounded-full flex items-center justify-center">√ó</button></li>))}</ul></div> <button onClick={copy} className="bg-emerald-600 text-white py-2 rounded-lg font-bold flex justify-center gap-2 hover:bg-emerald-700 shadow-lg">{I.Copy} Copiar Lista</button> </div>); }

        // --- PIZARRA (Corregida) ---
        function WhiteboardModule() {
            const [elements, setElements] = useState([]);
            const [history, setHistory] = useState([]);
            const [historyStep, setHistoryStep] = useState(0);
            const [tool, setTool] = useState('pencil');
            const [action, setAction] = useState('none');
            const [panOffset, setPanOffset] = useState({ x: 0, y: 0 });
            const [writingPos, setWritingPos] = useState(null);
            const [defaultText, setDefaultText] = useState(''); // Estado para edici√≥n
            const [selectedId, setSelectedId] = useState(null);
            const [confirmClear, setConfirmClear] = useState(false);
            const [resizeHandle, setResizeHandle] = useState(null);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
            const [color, setColor] = useState('#004d40');
            const [strokeWidth, setStrokeWidth] = useState(3);
            const [size, setSize] = useState({ w: 0, h: 0 });
            const [hoverCursor, setHoverCursor] = useState(null);
            const containerRef = useRef(null);
            const canvasRef = useRef(null);
            const textAreaRef = useRef(null);
            const generateId = () => Math.random().toString(36).substr(2, 9);

            useEffect(() => {
                if (!containerRef.current) return;
                const obs = new ResizeObserver(() => setSize({ w: containerRef.current.offsetWidth, h: containerRef.current.offsetHeight }));
                obs.observe(containerRef.current);
                return () => obs.disconnect();
            }, []);

            useEffect(() => {
                if (tool !== 'selection') { setSelectedId(null); setResizeHandle(null); }
                if (confirmClear) setConfirmClear(false);
                // Si cambiamos de herramienta escribiendo, guardamos
                if (action === 'writing' && tool !== 'text') finishWriting();
            }, [tool]);

            // Enfocar textarea al escribir
            useEffect(() => {
                if (action === 'writing' && textAreaRef.current) {
                    textAreaRef.current.value = defaultText; // Poner texto existente si es edici√≥n
                    setTimeout(() => {
                        textAreaRef.current?.focus();
                        textAreaRef.current.scrollTop = textAreaRef.current.scrollHeight;
                    }, 10);
                }
            }, [action, writingPos]);

            // Actualizar propiedades al seleccionar
            useEffect(() => {
                if (selectedId && !resizeHandle && action !== 'moving') {
                    const index = elements.findIndex(el => el.id === selectedId);
                    if (index !== -1) {
                        const el = elements[index];
                        if (el.color !== color || el.strokeWidth !== strokeWidth) {
                            const newEls = [...elements];
                            // Recalcular tama√±o si es texto
                            let newW = el.width;
                            let newH = el.height;
                            if (el.type === 'text') {
                                const fontSize = Math.max(12, strokeWidth * 4);
                                const lines = el.text.split('\n');
                                newH = lines.length * fontSize * 1.2;
                                const maxLineLen = Math.max(...lines.map(l => l.length));
                                newW = maxLineLen * fontSize * 0.6;
                            }
                            newEls[index] = { ...el, color, strokeWidth, width: newW, height: newH };
                            setElements(newEls);
                        }
                    }
                }
            }, [color, strokeWidth]);

            useEffect(() => {
                if (selectedId) {
                    const el = elements.find(e => e.id === selectedId);
                    if (el) { setColor(el.color); setStrokeWidth(el.strokeWidth); }
                }
            }, [selectedId]);

            // RENDERIZADO (Con soporte multil√≠nea)
            useLayoutEffect(() => {
                const ctx = canvasRef.current?.getContext('2d');
                if (!ctx || size.w === 0) return;
                canvasRef.current.width = size.w;
                canvasRef.current.height = size.h;
                ctx.clearRect(0, 0, size.w, size.h);

                // Grid
                ctx.save();
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, size.w, size.h);
                ctx.strokeStyle = '#f1f5f9';
                ctx.lineWidth = 1;
                ctx.beginPath();
                const gridSize = 40;
                const offsetX = panOffset.x % gridSize;
                const offsetY = panOffset.y % gridSize;
                for (let x = offsetX; x < size.w; x += gridSize) { ctx.moveTo(x, 0); ctx.lineTo(x, size.h); }
                for (let y = offsetY; y < size.h; y += gridSize) { ctx.moveTo(0, y); ctx.lineTo(size.w, y); }
                ctx.stroke();
                ctx.restore();

                ctx.save();
                ctx.translate(panOffset.x, panOffset.y);

                elements.forEach(el => {
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    if (el.type === 'eraser') { ctx.strokeStyle = '#ffffff'; ctx.lineWidth = el.strokeWidth * 4; }
                    else { ctx.strokeStyle = el.color; ctx.lineWidth = el.strokeWidth; ctx.fillStyle = el.color; }

                    if ((el.type === 'pencil' || el.type === 'eraser') && el.points.length > 0) {
                        ctx.beginPath();
                        ctx.moveTo(el.points[0].x, el.points[0].y);
                        for (let i = 1; i < el.points.length; i++) ctx.lineTo(el.points[i].x, el.points[i].y);
                        ctx.stroke();
                    } else if (el.type === 'rectangle') {
                        ctx.strokeRect(el.x, el.y, el.width, el.height);
                    } else if (el.type === 'circle') {
                        ctx.beginPath();
                        const r = Math.sqrt(Math.pow(el.width, 2) + Math.pow(el.height, 2)) / 2;
                        ctx.arc(el.x + el.width / 2, el.y + el.height / 2, Math.abs(r), 0, 2 * Math.PI);
                        ctx.stroke();
                    } else if (el.type === 'line') {
                        ctx.beginPath();
                        ctx.moveTo(el.x, el.y);
                        ctx.lineTo(el.x + el.width, el.y + el.height);
                        ctx.stroke();
                    } else if (el.type === 'text' && el.text) {
                        const fontSize = Math.max(12, el.strokeWidth * 4);
                        ctx.font = `${fontSize}px 'Lato', sans-serif`;
                        ctx.textBaseline = 'top';

                        // L√ìGICA DE MULTIL√çNEA
                        const lines = el.text.split('\n');
                        let maxWidth = 0;
                        lines.forEach((line, index) => {
                            ctx.fillText(line, el.x, el.y + (index * fontSize * 1.2));
                            const m = ctx.measureText(line);
                            if (m.width > maxWidth) maxWidth = m.width;
                        });

                        el.width = maxWidth;
                        el.height = lines.length * fontSize * 1.2;
                    }
                });

                if (selectedId) {
                    const el = elements.find(e => e.id === selectedId);
                    if (el) {
                        const isPencil = el.type === 'pencil' || el.type === 'eraser';
                        ctx.strokeStyle = '#ff6f00';
                        ctx.lineWidth = 1;
                        ctx.setLineDash([5, 5]);
                        let bx = el.x, by = el.y, bw = el.width, bh = el.height;
                        if (isPencil) {
                            const xs = el.points.map(p => p.x); const ys = el.points.map(p => p.y);
                            bx = Math.min(...xs); by = Math.min(...ys); bw = Math.max(...xs) - bx; bh = Math.max(...ys) - by;
                        } else {
                            if (bw < 0) { bx += bw; bw = Math.abs(bw); }
                            if (bh < 0) { by += bh; bh = Math.abs(bh); }
                        }
                        ctx.strokeRect(bx - 5, by - 5, bw + 10, bh + 10);
                        ctx.setLineDash([]);
                        if (!isPencil) {
                            const handles = getHandles({ x: bx, y: by, width: bw, height: bh });
                            ctx.fillStyle = '#ffffff'; ctx.strokeStyle = '#ff6f00'; ctx.lineWidth = 2;
                            Object.values(handles).forEach(h => { ctx.beginPath(); ctx.rect(h.x - 4, h.y - 4, 8, 8); ctx.fill(); ctx.stroke(); });
                        }
                    }
                }
                ctx.restore();
            }, [elements, size, panOffset, selectedId]);

            const updateHistory = (newEls) => {
                const newHist = history.slice(0, historyStep + 1);
                newHist.push(newEls);
                setHistory(newHist);
                setHistoryStep(newHist.length - 1);
            };
            const undo = () => { if (historyStep > 0) { setHistoryStep(s => s - 1); setElements(history[historyStep - 1]); setSelectedId(null); } else { setHistoryStep(-1); setElements([]); setSelectedId(null); } };
            const redo = () => { if (historyStep < history.length - 1) { setHistoryStep(s => s + 1); setElements(history[historyStep + 1]); setSelectedId(null); } };
            const getPos = (e) => {
                const rect = canvasRef.current.getBoundingClientRect();
                const cx = e.touches ? e.touches[0].clientX : e.clientX;
                const cy = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: cx - rect.left - panOffset.x, y: cy - rect.top - panOffset.y };
            };

            const isPointInElement = (x, y, el) => {
                const padding = 10;
                let bx = el.x, by = el.y, bw = el.width, bh = el.height;
                if (el.type === 'pencil' || el.type === 'eraser') {
                    const xs = el.points.map(p => p.x); const ys = el.points.map(p => p.y);
                    bx = Math.min(...xs); by = Math.min(...ys); bw = Math.max(...xs) - bx; bh = Math.max(...ys) - by;
                } else {
                    if (bw < 0) { bx += bw; bw = Math.abs(bw); }
                    if (bh < 0) { by += bh; bh = Math.abs(bh); }
                }
                return x >= bx - padding && x <= bx + bw + padding && y >= by - padding && y <= by + bh + padding;
            };

            // MANEJO DE DOBLE CLIC (EDITAR)
            const handleDoubleClick = (e) => {
                const { x, y } = getPos(e);
                for (let i = elements.length - 1; i >= 0; i--) {
                    const el = elements[i];
                    if (el.type === 'text' && isPointInElement(x, y, el)) {
                        setDefaultText(el.text);
                        setWritingPos({ x: el.x, y: el.y });
                        setTool('text');
                        setAction('writing');
                        setColor(el.color);
                        setStrokeWidth(el.strokeWidth);
                        const newEls = elements.filter(item => item.id !== el.id);
                        setElements(newEls);
                        return;
                    }
                }
            };

            const handleDown = (e) => {
                if (['BUTTON', 'INPUT', 'TEXTAREA', 'LABEL', 'SELECT'].includes(e.target.tagName)) return;
                e.preventDefault();

                const { x, y } = getPos(e);

                if (tool === 'selection') {
                    if (selectedId) {
                        const el = elements.find(e => e.id === selectedId);
                        if (el && (el.type !== 'pencil' && el.type !== 'eraser')) {
                            let bx = el.x, by = el.y, bw = el.width, bh = el.height;
                            if (bw < 0) { bx += bw; bw = Math.abs(bw); }
                            if (bh < 0) { by += bh; bh = Math.abs(bh); }
                            const handles = getHandles({ x: bx, y: by, width: bw, height: bh });
                            for (const key in handles) {
                                if (isPointInHandle(x, y, handles[key])) { setResizeHandle(key); setAction('resizing'); return; }
                            }
                        }
                    }
                    let foundId = null;
                    if (selectedId) {
                        const el = elements.find(e => e.id === selectedId);
                        if (el && isPointInElement(x, y, el)) foundId = selectedId;
                    }
                    if (!foundId) {
                        for (let i = elements.length - 1; i >= 0; i--) {
                            if (isPointInElement(x, y, elements[i])) { foundId = elements[i].id; break; }
                        }
                    }
                    setSelectedId(foundId);
                    if (foundId) {
                        setAction('moving');
                        const el = elements.find(e => e.id === foundId);
                        setDragOffset({ x: x - el.x, y: y - el.y });
                    } else {
                        setAction('panning');
                    }
                    return;
                }

                if (tool === 'text') {
                    if (action === 'writing') {
                        finishWriting();
                    } else {
                        setDefaultText('');
                        setAction('writing');
                        setWritingPos({ x, y });
                    }
                    return;
                }

                setAction('drawing');
                const newEl = {
                    id: generateId(),
                    type: tool,
                    x, y,
                    width: 0, height: 0,
                    color, strokeWidth,
                    points: (tool === 'pencil' || tool === 'eraser') ? [{ x, y }] : undefined
                };
                setElements(prev => [...prev, newEl]);
            };

            const handleMove = (e) => {
                const { x, y } = getPos(e);
                if (tool === 'selection' && selectedId && action === 'none') {
                    const el = elements.find(e => e.id === selectedId);
                    if (el) {
                        if (el.type !== 'pencil' && el.type !== 'eraser') {
                            let bx = el.x, by = el.y, bw = el.width, bh = el.height;
                            if (bw < 0) { bx += bw; bw = Math.abs(bw); }
                            if (bh < 0) { by += bh; bh = Math.abs(bh); }
                            const handles = getHandles({ x: bx, y: by, width: bw, height: bh });
                            let cursor = null;
                            for (const key in handles) { if (isPointInHandle(x, y, handles[key])) cursor = handles[key].cursor; }
                            setHoverCursor(cursor);
                        }
                        if (!hoverCursor && isPointInElement(x, y, el)) { setHoverCursor('move'); }
                    } else { setHoverCursor(null); }
                } else if (action === 'none') { setHoverCursor(null); }

                if (action === 'panning') { setPanOffset(p => ({ x: p.x + (e.movementX || 0), y: p.y + (e.movementY || 0) })); return; }

                if (action === 'moving' && selectedId) {
                    const els = [...elements];
                    const index = els.findIndex(e => e.id === selectedId);
                    const el = els[index];
                    const newX = x - dragOffset.x;
                    const newY = y - dragOffset.y;
                    if (el.type === 'pencil' || el.type === 'eraser') {
                        const dx = newX - el.x; const dy = newY - el.y;
                        const newPoints = el.points.map(p => ({ x: p.x + dx, y: p.y + dy }));
                        els[index] = { ...el, x: newX, y: newY, points: newPoints };
                    } else {
                        els[index] = { ...el, x: newX, y: newY };
                    }
                    setElements(els);
                    return;
                }

                if (action === 'resizing' && selectedId && resizeHandle) {
                    const els = [...elements];
                    const index = els.findIndex(e => e.id === selectedId);
                    const el = els[index];
                    if (el.type === 'text') {
                        let newHeight = el.height;
                        if (resizeHandle.includes('b')) newHeight = y - el.y;
                        if (resizeHandle.includes('t')) newHeight = el.y + el.height - y;
                        if (newHeight < 10) newHeight = 10;
                        const newStrokeWidth = newHeight / 4;
                        const lines = el.text.split('\n');
                        const maxLen = Math.max(...lines.map(l => l.length));
                        els[index] = {
                            ...el,
                            strokeWidth: newStrokeWidth,
                            height: lines.length * newHeight * 1.2,
                            width: maxLen * newHeight * 0.6
                        };
                    } else {
                        let newX = el.x, newY = el.y, newW = el.width, newH = el.height;
                        if (resizeHandle === 'br') { newW = x - newX; newH = y - newY; }
                        else if (resizeHandle === 'bl') { newW = (newX + newW) - x; newX = x; newH = y - newY; }
                        else if (resizeHandle === 'tr') { newW = x - newX; newH = (newY + newH) - y; newY = y; }
                        else if (resizeHandle === 'tl') { newW = (newX + newW) - x; newX = x; newH = (newY + newH) - y; newY = y; }
                        els[index] = { ...el, x: newX, y: newY, width: newW, height: newH };
                    }
                    setElements(els);
                    return;
                }

                if (action === 'drawing') {
                    const els = [...elements];
                    const curr = els[els.length - 1];
                    if (tool === 'pencil' || tool === 'eraser') curr.points.push({ x, y });
                    else { curr.width = x - curr.x; curr.height = y - curr.y; }
                    setElements(els);
                }
            };

            const handleUp = () => {
                if (action === 'drawing' || action === 'resizing' || action === 'moving') updateHistory(elements);
                if (action !== 'writing') { setAction('none'); setResizeHandle(null); }
            };

            const finishWriting = () => {
                if (!textAreaRef.current || !writingPos) {
                    setAction('none'); setWritingPos(null); return;
                }
                const text = textAreaRef.current.value.trim();
                if (text) {
                    const fontSize = Math.max(12, strokeWidth * 4);
                    const lines = text.split('\n');
                    const totalHeight = lines.length * fontSize * 1.2;
                    const maxLineLen = Math.max(...lines.map(l => l.length));
                    const approxWidth = maxLineLen * fontSize * 0.6;

                    const newEls = [...elements, {
                        id: generateId(),
                        type: 'text',
                        x: writingPos.x,
                        y: writingPos.y,
                        text, color, strokeWidth,
                        width: approxWidth,
                        height: totalHeight
                    }];
                    setElements(newEls);
                    updateHistory(newEls);
                }
                setAction('none');
                setWritingPos(null);
                setDefaultText('');
            };

            const save = () => {
                const a = document.createElement('a'); a.download = 'pizarra-tucaneo.png'; a.href = canvasRef.current.toDataURL(); a.click();
            };

            let cursorClass = 'cursor-crosshair';
            if (hoverCursor) cursorClass = `cursor-${hoverCursor}`;
            else if (tool === 'selection') cursorClass = action === 'panning' ? 'cursor-grabbing' : 'cursor-default';
            else if (tool === 'text') cursorClass = 'cursor-text';
            else if (tool === 'eraser') cursorClass = 'cursor-eraser';

            return (
                <div ref={containerRef}
                    onDoubleClick={handleDoubleClick}
                    className={`absolute inset-0 bg-white select-none touch-none overflow-hidden ${cursorClass}`}>

                    <div className="absolute top-1/2 -translate-y-1/2 left-4 z-50 flex flex-col gap-2 bg-white/95 p-2 rounded-xl shadow-lg border border-slate-200">
                        <button onClick={() => setTool('selection')} title="Seleccionar (Mover y Editar)" className={`p-3 rounded-lg transition-colors ${tool === 'selection' ? 'bg-orange-100 text-orange-600' : 'text-gray-400 hover:bg-gray-100'}`}>{I.Pointer}</button>
                        <div className="w-full h-px bg-gray-200 my-1"></div>
                        <button onClick={() => setTool('eraser')} title="Borrador" className={`p-3 rounded-lg transition-colors ${tool === 'eraser' ? 'bg-orange-100 text-orange-600' : 'text-gray-400 hover:bg-gray-100'}`}>{I.Eraser}</button>
                        {[{ id: 'pencil', i: I.Pencil, t: 'L√°piz' }, { id: 'rectangle', i: I.Square, t: 'Cuadrado' }, { id: 'circle', i: I.Circle, t: 'C√≠rculo' }, { id: 'line', i: I.Line, t: 'L√≠nea' }, { id: 'text', i: I.Type, t: 'Texto' }].map(t => (
                            <button key={t.id} onClick={() => setTool(t.id)} title={t.t} className={`p-3 rounded-lg transition-colors ${tool === t.id ? 'bg-orange-100 text-orange-600' : 'text-gray-400 hover:bg-gray-100'}`}>{t.i}</button>
                        ))}
                    </div>

                    <div className="absolute bottom-4 left-1/2 -translate-x-1/2 z-50 bg-white/95 px-6 py-3 rounded-full shadow-lg border border-slate-200 flex items-center gap-4 w-max max-w-[90vw] overflow-x-auto">
                        <input type="color" value={color} onChange={e => setColor(e.target.value)} className="w-8 h-8 rounded-full border-none cursor-pointer flex-shrink-0" title="Color" />
                        <div className="flex items-center gap-2 flex-shrink-0">
                            <span className="text-xs font-bold text-gray-400 hidden md:block">GROSOR</span>
                            <input type="range" min="1" max="20" value={strokeWidth} onChange={e => setStrokeWidth(Number(e.target.value))} className="w-24 accent-emerald-500" title="Tama√±o" />
                        </div>
                        <div className="w-px h-8 bg-gray-200 mx-1 hidden md:block"></div>
                        <div className="flex gap-1 flex-shrink-0">
                            <button onClick={undo} disabled={historyStep < 0} className="p-2 text-gray-500 hover:bg-gray-100 rounded-full disabled:opacity-30">{I.Undo}</button>
                            <button onClick={redo} disabled={historyStep >= history.length - 1} className="p-2 text-gray-500 hover:bg-gray-100 rounded-full disabled:opacity-30">{I.Redo}</button>
                            <button onClick={() => { if (!confirmClear) { setConfirmClear(true); setTimeout(() => setConfirmClear(false), 3000) } else { setElements([]); setConfirmClear(false); } }} className={`p-2 rounded-full font-bold text-xs transition-colors ${confirmClear ? 'bg-red-500 text-white px-3' : 'text-red-500 hover:bg-red-50'}`}>{confirmClear ? 'CONFIRMAR' : I.Trash}</button>
                        </div>
                        <button onClick={save} className="ml-2 bg-slate-800 text-white px-4 py-2 rounded-full text-sm font-bold flex gap-2 items-center hover:bg-slate-900 transition-colors flex-shrink-0 uppercase tracking-wider">{I.Save} <span className="hidden md:inline">Guardar</span></button>
                    </div>

                    <canvas ref={canvasRef} onMouseDown={handleDown} onMouseMove={handleMove} onMouseUp={handleUp} onMouseLeave={handleUp} onTouchStart={handleDown} onTouchMove={handleMove} onTouchEnd={handleUp} className="absolute inset-0 w-full h-full z-20" />

                    {action === 'writing' && writingPos && (
                        <div className="fixed z-[100] fade-in" style={{ left: writingPos.x + panOffset.x + (containerRef.current?.getBoundingClientRect().left || 0), top: writingPos.y + panOffset.y, }}>
                            <textarea
                                ref={textAreaRef}
                                onKeyDown={(e) => {
                                    // Evitar que el evento suba a Reveal.js
                                    e.stopPropagation();
                                    // Si es ESC, cerramos, pero ENTER ahora funciona normal (salto de l√≠nea)
                                    if (e.key === 'Escape') finishWriting();
                                }}
                                onBlur={finishWriting}
                                className="bg-white border-2 border-emerald-500 rounded-lg p-3 shadow-2xl outline-none text-slate-900 placeholder-slate-400 overflow-hidden resize-both font-sans"
                                style={{ font: `${Math.max(12, strokeWidth * 4)}px 'Lato', sans-serif`, minWidth: '200px', minHeight: '60px' }}
                                placeholder="Escriba aqu√≠..."
                            />
                        </div>
                    )}
                </div>
            );
        }

        // --- APP PRINCIPAL (Contenedor) ---
        function App() {
            const [tab, setTab] = useState('board');
            const close = () => window.toggleDrawer();
            useEffect(() => {
                const handler = (e) => {
                    if (e.key.toLowerCase() === 'h' && !['INPUT', 'TEXTAREA'].includes(e.target.tagName)) close();
                };
                window.addEventListener('keydown', handler);
                const toolHandler = (e) => {
                    const toolName = e.detail;
                    setTab(toolName);
                    const drawer = document.getElementById('tucaneo-drawer');
                    if (drawer && !drawer.classList.contains('is-open')) {
                        drawer.classList.add('is-open');
                    }
                };
                window.addEventListener('open-tool', toolHandler);
                return () => {
                    window.removeEventListener('keydown', handler);
                    window.removeEventListener('open-tool', toolHandler);
                };
            }, []);
            return (
                <div className="h-full flex flex-col bg-slate-50">
                    <div className="bg-white border-b border-slate-200 h-14 shrink-0 flex items-center px-4 gap-6">
                        <button onClick={() => setTab('board')} className={`h-full flex items-center gap-2 border-b-2 font-bold px-2 transition-colors ${tab === 'board' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-gray-400'}`}>{I.Art} Pizarra</button>
                        <button onClick={() => setTab('vocab')} className={`h-full flex items-center gap-2 border-b-2 font-bold px-2 transition-colors ${tab === 'vocab' ? 'border-emerald-500 text-emerald-600' : 'border-transparent text-gray-400'}`}>{I.Book} Glosario</button>
                        <div className="flex-1"></div>
                    </div>
                    <div className="flex-1 relative overflow-hidden">
                        <div className={`absolute inset-0 ${tab === 'board' ? 'z-10' : '-z-10 opacity-0 pointer-events-none'}`}><WhiteboardModule /></div>
                        <div className={`absolute inset-0 ${tab === 'vocab' ? 'z-10' : '-z-10 opacity-0 pointer-events-none'}`}><VocabModule /></div>
                    </div>
                </div>
            );
        }

        // RENDERIZADO FINAL
        const root = ReactDOM.createRoot(document.getElementById('tools-root'));
        root.render(<App />);
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.5.0/reveal.min.js"></script>

    <script>
        // L√≥gica Principal
        const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        const isSmallScreen = window.innerWidth < 1024;
        const isMobile = isTouch || isSmallScreen;

        if (isMobile) {
            console.log("Modo M√≥vil: Desactivando l√≥gica de presentaci√≥n.");
            document.body.classList.add('is-mobile');

            // NO INICIAMOS REVEAL.JS EN M√ìVIL
            // Dejamos que el CSS haga todo el trabajo de scroll vertical.

            // Barra de progreso manual
            window.addEventListener('scroll', () => {
                const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
                const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                const scrolled = (winScroll / height) * 100;
                const progressBar = document.getElementById('scroll-progress');
                if (progressBar) progressBar.style.width = scrolled + '%';

                const btn = document.getElementById('back-to-top');
                if (btn) (winScroll > 300) ? btn.classList.add('visible') : btn.classList.remove('visible');
            });
        } else {
            // PC: Iniciamos Reveal (Solo aqu√≠)
            Reveal.initialize({
                // ... tu configuraci√≥n de PC ...
                width: "100%", height: "100%", margin: 0, minScale: 1, maxScale: 1,
                transition: 'slide', backgroundTransition: 'fade', background: '#fefce8'
            });
        }

        function toggleDrawer() { document.getElementById('tucaneo-drawer').classList.toggle('is-open'); }
        function openTool(toolName) { window.dispatchEvent(new CustomEvent('open-tool', { detail: toolName })); }

        // --- CONTROL INTELIGENTE DE TECLAS (VERSI√ìN FINAL) ---
        function handleZoomNavigation(e) {
            // 1. Ignorar si el usuario escribe en un input
            if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;

            // 2. Guardamos la posici√≥n EXACTA (diapositiva H y V) antes de movernos
            const indicesBefore = Reveal.getIndices();
            let actionTriggered = false;

            // 3. Ejecutamos la acci√≥n de Reveal
            if (e.key === 'ArrowLeft') {
                Reveal.prev();
                actionTriggered = true;
            } else if (e.key === 'ArrowRight' || e.code === 'Space') {
                Reveal.next();
                actionTriggered = true;
            }

            // 4. Decidimos si hacer scroll arriba o no
            if (actionTriggered) {
                const indicesAfter = Reveal.getIndices();

                // L√ìGICA: Si la diapositiva Horizontal (h) o Vertical (v) cambi√≥, es una diapositiva nueva -> SCROLL TOP
                // Si h y v son iguales, significa que solo cambi√≥ el fragmento (f) -> NO SCROLL
                if (indicesBefore.h !== indicesAfter.h || indicesBefore.v !== indicesAfter.v) {
                    window.scrollTo(0, 0);
                }
                // Si no, nos quedamos quietos para ver la respuesta que acabamos de revelar.
            }
        }

        function forceZoom() {
            if (isMobile) return;

            const container = document.querySelector('.reveal');
            const btn = document.getElementById('btn-zoom');
            const html = document.documentElement;
            const body = document.body;

            const isActive = container.classList.contains('is-zoomed');

            if (!isActive) {
                // --- ACTIVAR ZOOM ---
                html.classList.add('is-scrollable');
                body.classList.add('is-scrollable');
                container.classList.add('is-zoomed');

                // Apagamos teclado nativo de Reveal y encendemos el nuestro
                Reveal.configure({ keyboard: false });
                document.addEventListener('keydown', handleZoomNavigation);

                btn.classList.add('active');

            } else {
                // --- DESACTIVAR ZOOM ---
                window.scrollTo(0, 0);
                html.classList.remove('is-scrollable');
                body.classList.remove('is-scrollable');
                container.classList.remove('is-zoomed');

                // Restauramos todo
                Reveal.configure({ keyboard: true });
                document.removeEventListener('keydown', handleZoomNavigation);
                Reveal.layout();

                btn.classList.remove('active');
            }
        }

        const sounds = {
            confetti: new Audio('https://www.myinstants.com/media/sounds/success-sound-effect.mp3'),
            applause: new Audio('https://www.myinstants.com/media/sounds/kids-cheering.mp3'),
            error: new Audio('https://www.myinstants.com/media/sounds/error-sound.mp3')
        };

        function playSound(name) {
            console.log("Playing sound:", name);
            if (sounds[name]) {
                sounds[name].currentTime = 0;
                sounds[name].volume = 0.5;
                sounds[name].play().then(() => {
                    console.log("Sound played successfully");
                }).catch(e => {
                    console.warn("Audio play failed:", e);
                });
            }
        }

        function react(type) {
            playSound(type);
            switch (type) {
                case 'confetti':
                    var duration = 2000; var end = Date.now() + duration;
                    (function frame() {
                        confetti({ particleCount: 4, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#004d40', '#ff6f00'], zIndex: 8000 });
                        confetti({ particleCount: 4, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#004d40', '#ff6f00'], zIndex: 8000 });
                        if (Date.now() < end) requestAnimationFrame(frame);
                    }());
                    break;
                case 'applause':
                    confetti({ shapes: ['emoji'], emoji: ['üëè', 'ü¶ú', '‚òÄÔ∏è'], scalar: 3, spread: 100, particleCount: 30, origin: { y: 1 }, zIndex: 8000, startVelocity: 45 });
                    break;
                case 'error':
                    break;
            }
        }

        // Mental Agility Check Function
        function checkMentalAgility() {
            const inputs = document.querySelectorAll('#mental-agility-exercises input[data-correct]');
            let correctCount = 0;
            let totalCount = inputs.length;

            inputs.forEach((input, index) => {
                const userAnswer = input.value.trim().toLowerCase();
                const correctAnswer = input.getAttribute('data-correct').toLowerCase();
                const resultIcon = input.parentElement.querySelector('.result-icon');
                const exerciseDiv = input.parentElement;

                // Normalize answers (remove accents for comparison)
                const normalizeText = (text) => {
                    return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                };

                const isCorrect = normalizeText(userAnswer) === normalizeText(correctAnswer) || userAnswer === correctAnswer;

                if (isCorrect) {
                    correctCount++;
                    resultIcon.innerHTML = '<i class="fas fa-check-circle text-emerald-500 text-xl"></i>';
                    exerciseDiv.classList.remove('border-red-300', 'bg-red-50');
                    exerciseDiv.classList.add('border-emerald-300', 'bg-emerald-50');
                    input.classList.add('text-emerald-700', 'font-bold');
                } else {
                    resultIcon.innerHTML = '<i class="fas fa-times-circle text-red-500 text-xl"></i>';
                    exerciseDiv.classList.remove('border-emerald-300', 'bg-emerald-50');
                    exerciseDiv.classList.add('border-red-300', 'bg-red-50');
                    input.classList.add('text-red-600');

                    // Show correct answer
                    if (!input.nextElementSibling || !input.nextElementSibling.classList.contains('correct-answer')) {
                        const correctSpan = document.createElement('span');
                        correctSpan.className = 'correct-answer text-emerald-600 font-bold text-sm ml-2';
                        correctSpan.textContent = `‚úì ${correctAnswer}`;
                        resultIcon.after(correctSpan);
                    }
                }
            });

            // Display results
            const resultDiv = document.getElementById('mental-agility-result');
            const percentage = Math.round((correctCount / totalCount) * 100);

            if (correctCount === totalCount) {
                resultDiv.innerHTML = `<span class="text-emerald-600">üéâ Perfect! ${correctCount}/${totalCount} - ¬°Perfecto!</span>`;
                react('confetti');
            } else if (percentage >= 70) {
                resultDiv.innerHTML = `<span class="text-orange-600">üëç Good! ${correctCount}/${totalCount} (${percentage}%) - ¬°Bien!</span>`;
                playSound('applause');
            } else {
                resultDiv.innerHTML = `<span class="text-slate-600">üìù Keep practicing! ${correctCount}/${totalCount} (${percentage}%) - ¬°Sigue practicando!</span>`;
            }
        }

        // Translation Challenge Check Function
        function checkTranslation() {
            const inputs = document.querySelectorAll('#translation-exercises input[data-correct]');
            let correctCount = 0;
            let totalCount = inputs.length;

            inputs.forEach((input, index) => {
                const userAnswer = input.value.trim().toLowerCase();
                const correctAnswer = input.getAttribute('data-correct').toLowerCase();
                const feedbackDiv = input.parentElement.querySelector('.result-feedback');
                const exerciseDiv = input.parentElement;

                // Normalize answers (remove accents and punctuation for comparison)
                const normalizeText = (text) => {
                    return text
                        .normalize("NFD")
                        .replace(/[\u0300-\u036f]/g, "")
                        .replace(/[¬ø?¬°!.,;:]/g, "")
                        .trim();
                };

                const isCorrect = normalizeText(userAnswer) === normalizeText(correctAnswer) || userAnswer === correctAnswer;

                if (isCorrect) {
                    correctCount++;
                    feedbackDiv.innerHTML = '<div class="flex items-center gap-2"><i class="fas fa-check-circle text-emerald-500 text-lg"></i><span class="text-emerald-600 font-bold text-sm">¬°Correcto! / Correct!</span></div>';
                    exerciseDiv.classList.remove('border-red-300', 'bg-red-50');
                    exerciseDiv.classList.add('border-emerald-300', 'bg-emerald-50');
                    input.classList.add('text-emerald-700', 'font-bold');
                    input.classList.remove('text-red-600');
                } else {
                    feedbackDiv.innerHTML = `<div class="flex flex-col gap-1"><div class="flex items-center gap-2"><i class="fas fa-times-circle text-red-500 text-lg"></i><span class="text-red-600 font-bold text-sm">Incorrecto / Incorrect</span></div><div class="text-emerald-600 font-bold text-sm">‚úì ${correctAnswer}</div></div>`;
                    exerciseDiv.classList.remove('border-emerald-300', 'bg-emerald-50');
                    exerciseDiv.classList.add('border-red-300', 'bg-red-50');
                    input.classList.add('text-red-600');
                    input.classList.remove('text-emerald-700', 'font-bold');
                }
            });

            // Display results
            const resultDiv = document.getElementById('translation-result');
            const percentage = Math.round((correctCount / totalCount) * 100);

            if (correctCount === totalCount) {
                resultDiv.innerHTML = `<span class="text-emerald-600">üéâ Perfect! ${correctCount}/${totalCount} - ¬°Perfecto!</span>`;
                react('confetti');
            } else if (percentage >= 70) {
                resultDiv.innerHTML = `<span class="text-orange-600">üëç Good! ${correctCount}/${totalCount} (${percentage}%) - ¬°Bien!</span>`;
                playSound('applause');
            } else {
                resultDiv.innerHTML = `<span class="text-slate-600">üìù Keep practicing! ${correctCount}/${totalCount} (${percentage}%) - ¬°Sigue practicando!</span>`;
            }
        }

        // Check Colombia Text Exercise
        function checkColombiaText() {
            const inputs = document.querySelectorAll('#colombia-text-exercise .text-input-inline');
            let correctCount = 0;
            const totalCount = inputs.length;

            inputs.forEach(input => {
                const userAnswer = input.value.trim();
                const correctAnswer = input.getAttribute('data-correct');

                // Normalize text for comparison (case-insensitive)
                const normalizeText = (text) => {
                    return text
                        .toLowerCase()
                        .normalize("NFD")
                        .replace(/[\u0300-\u036f]/g, "")
                        .trim();
                };

                const isCorrect = normalizeText(userAnswer) === normalizeText(correctAnswer);

                // Remove previous classes
                input.classList.remove('correct', 'incorrect');

                if (isCorrect) {
                    correctCount++;
                    input.classList.add('correct');
                } else {
                    input.classList.add('incorrect');
                }
            });

            // Display results
            const resultDiv2 = document.getElementById('colombia-result');
            const percentage2 = Math.round((correctCount / totalCount) * 100);

            if (correctCount === totalCount) {
                resultDiv2.innerHTML = `<span class="text-emerald-600">üéâ ¬°Perfecto! ${correctCount}/${totalCount} - Perfect!</span>`;
                if (typeof confetti !== 'undefined') {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }
            } else if (percentage2 >= 70) {
                resultDiv2.innerHTML = `<span class="text-orange-600">üëç ¬°Bien! ${correctCount}/${totalCount} (${percentage2}%) - Good!</span>`;
            } else {
                resultDiv2.innerHTML = `<span class="text-slate-600">üìù Sigue practicando - ${correctCount}/${totalCount} (${percentage2}%)</span>`;
            }
        }


        // Check Despedida Challenge
        function checkDespedida() {
            const card = document.getElementById('despedida-card');
            const inputs = card.querySelectorAll('input');
            let allCorrect = true;
            let count = 0;

            inputs.forEach(input => {
                const answer = input.getAttribute('data-answer').toLowerCase();
                const userVal = input.value.trim().toLowerCase();
                const icon = input.nextElementSibling;

                const normalize = (s) => s.normalize("NFD").replace(/[\u0300-\u036f]/g, "");

                if (normalize(userVal) === normalize(answer)) {
                    input.classList.add('border-emerald-500', 'bg-emerald-50', 'text-emerald-700');
                    input.classList.remove('border-red-300', 'bg-red-50', 'text-red-700');
                    icon.innerHTML = '<i class="fas fa-check-circle text-emerald-500"></i>';
                    icon.classList.remove('opacity-0');
                    count++;
                } else {
                    allCorrect = false;
                    input.classList.add('border-red-300', 'bg-red-50', 'text-red-700');
                    input.classList.remove('border-emerald-500', 'bg-emerald-50', 'text-emerald-700');
                    icon.innerHTML = '<i class="fas fa-times-circle text-red-500"></i>';
                    icon.classList.remove('opacity-0');
                }
            });

            const feedback = document.getElementById('despedida-feedback');
            if (allCorrect) {
                feedback.innerHTML = '<span class="text-emerald-600">üéâ ¬°Excelente! Mam√° est√° feliz.</span>';
                if (typeof confetti !== 'undefined') confetti({ spread: 70, origin: { y: 0.8 } });
                if (typeof playSound === 'function') playSound('confetti');
            } else {
                feedback.innerHTML = `<span class="text-orange-600">Tienes ${count} de ${inputs.length} correctas. ¬°Int√©ntalo de nuevo!</span>`;
                if (typeof playSound === 'function') playSound('error');
            }
        }

    </script>
    <style>
        @keyframes spin-slow {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        @keyframes spin-reverse {
            from {
                transform: rotate(360deg);
            }

            to {
                transform: rotate(0deg);
            }
        }

        @keyframes float-up {

            0%,
            100% {
                transform: translateY(0) translateX(-50%);
            }

            50% {
                transform: translateY(-10px) translateX(-50%);
            }
        }

        /* Custom Classes for JS injection */
        .animate-spin-slow {
            animation: spin-slow 10s linear infinite;
        }

        .animate-spin-reverse {
            animation: spin-reverse 8s linear infinite;
        }

        .animate-shake {
            animation: shake 0.4s ease-in-out;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }
    </style>

    <script>
        // --- GAME LOGIC: ENERGY CORE ---
        const CoreGame = {
            state: {
                level: 0,
                score: 0,
                maxLevels: 10,
                currentVerb: null,
                isLocked: false
            },
            data: [
                { verb: "HACER", yo: "Hago", distractors: ["Haco", "Haca", "Hacer"] },
                { verb: "PONER", yo: "Pongo", distractors: ["Pono", "Pona", "Poni"] },
                { verb: "SALIR", yo: "Salgo", distractors: ["Salo", "Sali", "Sala"] },
                { verb: "TRAER", yo: "Traigo", distractors: ["Traio", "Trao", "Trae"] },
                { verb: "VER", yo: "Veo", distractors: ["Vo", "Voi", "Vi"] },
                { verb: "SABER", yo: "S√©", distractors: ["Sabo", "Se", "Sabe"] },
                { verb: "DAR", yo: "Doy", distractors: ["Do", "Da", "Dio"] },
                { verb: "IR", yo: "Voy", distractors: ["Iro", "Yo", "Va"] },
                { verb: "ESTAR", yo: "Estoy", distractors: ["Esto", "Estoy", "Esta"] },
                { verb: "CONOCER", yo: "Conozco", distractors: ["Conoco", "Conoce", "Conoca"] }
            ],

            init: function () {
                this.state.level = 0;
                this.state.score = 0;
                this.state.isLocked = false;

                // Shuffle data
                this.data.sort(() => Math.random() - 0.5);

                document.getElementById('game-intro').classList.remove('hidden');
                document.getElementById('game-interface').classList.add('hidden');
                document.getElementById('game-result').classList.add('hidden');

                // Reset HUD
                this.updateHUD();
            },

            start: function () {
                document.getElementById('game-intro').classList.add('hidden');
                document.getElementById('game-interface').classList.remove('hidden');
                this.loadLevel();
            },

            loadLevel: function () {
                if (this.state.level >= this.state.maxLevels) {
                    this.endGame();
                    return;
                }

                this.state.isLocked = false;
                const currentData = this.data[this.state.level];
                this.state.currentVerb = currentData;

                // Update HUD
                this.updateHUD();

                // Set Core Verb
                const coreOrb = document.getElementById('core-orb');
                coreOrb.className = "w-32 h-32 rounded-full bg-gradient-to-br from-purple-500 via-indigo-600 to-purple-800 shadow-[0_0_50px_rgba(124,58,237,0.5)] flex items-center justify-center transform transition-all duration-300 z-10 relative overflow-hidden";
                document.getElementById('target-verb').innerText = currentData.verb;

                // Generate Options
                const options = [currentData.yo, ...currentData.distractors];
                options.sort(() => Math.random() - 0.5);

                const container = document.getElementById('options-container');
                container.innerHTML = '';

                // Positions for 4 satellites (Top, Right, Bottom, Left) - Handling positioning via translate classes to center them relative to container center
                const positions = [
                    "top-4 left-1/2 -translate-x-1/2",           // Top
                    "top-1/2 right-4 translate-x-1/2 -translate-y-1/2", // Right
                    "bottom-4 left-1/2 -translate-x-1/2",        // Bottom
                    "top-1/2 left-4 -translate-x-1/2 -translate-y-1/2"  // Left
                ];

                options.forEach((opt, index) => {
                    const btn = document.createElement('button');
                    // Add some randomness to float animation delay
                    const delay = Math.random() * 2;
                    // We use inline style for delay
                    // Note: 'absolute' positioning with specific coordinate classes
                    btn.className = `absolute ${positions[index]} pointer-events-auto bg-white hover:bg-purple-50 text-slate-800 font-bold py-3 px-6 rounded-full shadow-lg transform transition-all hover:scale-110 active:scale-95 border-2 border-slate-100`;
                    btn.innerText = opt;
                    btn.style.animation = `float-up 3s ease-in-out infinite ${delay}s`; // Use custom keyframe

                    btn.onclick = () => this.handleChoice(opt, btn);
                    container.appendChild(btn);
                });
            },

            updateHUD: function () {
                const levelContainer = document.getElementById('level-indicator');
                if (!levelContainer) return;
                levelContainer.innerHTML = '';
                for (let i = 0; i < this.state.maxLevels; i++) {
                    const dot = document.createElement('div');
                    dot.className = `w-2 h-2 rounded-full transition-colors ${i < this.state.level ? 'bg-purple-500' : 'bg-slate-200'}`;
                    levelContainer.appendChild(dot);
                }
                const scoreDisplay = document.getElementById('score-display');
                if (scoreDisplay) scoreDisplay.innerText = this.state.score.toString().padStart(4, '0');
            },

            handleChoice: function (choice, btnElement) {
                if (this.state.isLocked) return;
                this.state.isLocked = true;

                const correct = this.state.currentVerb.yo;
                const coreOrb = document.getElementById('core-orb');

                // Disable all buttons
                const allBtns = document.getElementById('options-container').querySelectorAll('button');
                allBtns.forEach(b => b.classList.add('pointer-events-none', 'opacity-50'));
                btnElement.classList.remove('opacity-50');

                if (choice === correct) {
                    // Correct
                    this.state.score += 100;
                    if (typeof playSound === 'function') playSound('confetti');

                    // Visuals
                    btnElement.classList.remove('bg-white', 'text-slate-800');
                    btnElement.classList.add('bg-green-500', 'text-white', 'border-green-400', 'scale-125');

                    coreOrb.className = "w-32 h-32 rounded-full bg-gradient-to-br from-green-400 via-emerald-500 to-green-600 shadow-[0_0_50px_rgba(16,185,129,0.8)] flex items-center justify-center transform scale-110 transition-all duration-300 z-10 relative overflow-hidden";

                    setTimeout(() => {
                        this.state.level++;
                        this.loadLevel();
                    }, 1200);
                } else {
                    // Incorrect
                    if (typeof playSound === 'function') playSound('error');
                    this.state.score = Math.max(0, this.state.score - 50);

                    btnElement.classList.add('bg-red-500', 'text-white', 'animate-shake');

                    // Shake core
                    coreOrb.classList.add('animate-shake');
                    setTimeout(() => coreOrb.classList.remove('animate-shake'), 500);

                    setTimeout(() => {
                        this.state.isLocked = false;
                        // Re-enable buttons
                        allBtns.forEach(b => {
                            b.classList.remove('pointer-events-none', 'opacity-50', 'bg-red-500', 'text-white', 'animate-shake');
                            // Reset style if needed, but simplest is just continue
                            if (b === btnElement) {
                                b.classList.add('bg-white', 'text-slate-800');
                                b.classList.remove('bg-red-500', 'text-white');
                            }
                        });
                        this.updateHUD();
                    }, 1000);
                }
            },

            endGame: function () {
                document.getElementById('game-interface').classList.add('hidden');
                document.getElementById('game-result').classList.remove('hidden');
                document.getElementById('final-score').innerText = this.state.score;

                const msg = document.getElementById('result-message');
                if (this.state.score >= 800) {
                    msg.innerText = "Amazing! The core is fully charged!";
                    if (typeof react === 'function') react('confetti');
                } else {
                    msg.innerText = "Good effort! Try again for 100% efficiency.";
                }
            }
        };

        // Expose to global
        window.CoreGame = CoreGame;
    </script>
    <style>
        /* BORDER GAME STYLES */
        @keyframes float-slow {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .animate-float-slow {
            animation: float-slow 4s ease-in-out infinite;
        }

        @keyframes slam {
            0% {
                transform: scale(5) rotate(15deg);
                opacity: 0;
            }

            50% {
                transform: scale(0.8) rotate(-5deg);
                opacity: 1;
            }

            70% {
                transform: scale(1.1) rotate(2deg);
            }

            100% {
                transform: scale(1) rotate(0);
            }
        }

        .stamp-animation {
            animation: slam 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .text-shadow-lg {
            text-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }
    </style>

    <!-- ============================================
         MISI√ìN: PLAZA DE BOL√çVAR - DETECTIVE GAME
         ============================================ -->
    <section class="bg-gradient-to-br from-blue-900 via-indigo-800 to-purple-900 relative overflow-hidden">
        <div class="slide-container h-full flex flex-col relative z-10">
            <!-- Animated Background Elements -->
            <div class="absolute inset-0 opacity-10">
                <div class="absolute top-10 left-10 w-32 h-32 bg-yellow-300 rounded-full blur-3xl animate-pulse"></div>
                <div class="absolute bottom-20 right-20 w-40 h-40 bg-cyan-300 rounded-full blur-3xl animate-pulse"
                    style="animation-delay: 1s;"></div>
            </div>

            <div id="plaza-intro" class="flex flex-col items-center justify-center h-full text-center">
                <div
                    class="w-48 h-48 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mb-8 animate-bounce shadow-2xl">
                    <i class="fas fa-user-secret text-8xl text-white drop-shadow-lg"></i>
                </div>
                <h1 class="font-handlee text-7xl text-yellow-300 mb-4 drop-shadow-lg text-shadow-lg">
                    üïµÔ∏è Misi√≥n: Plaza de Bol√≠var
                </h1>
                <h3 class="font-lato text-2xl tracking-widest uppercase text-cyan-200 mb-6">
                    Detective del Subjuntivo
                </h3>
                <div class="mt-8 p-8 bg-black/40 border-l-4 border-yellow-400 max-w-3xl rounded-r-xl backdrop-blur-sm">
                    <p class="text-xl italic text-gray-100 leading-relaxed">
                        "Un misterioso robo ha ocurrido en la Plaza de Bol√≠var. Como detective biling√ºe,
                        debes interrogar a los sospechosos y usar el <span
                            class="text-yellow-300 font-bold">SUBJUNTIVO</span>
                        correctamente para resolver el caso. Cada error te cuesta credibilidad...
                        ¬°y el ladr√≥n podr√≠a escapar!"
                    </p>
                </div>
                <div class="mt-10 flex gap-4">
                    <button onclick="PlazaGame.start()"
                        class="px-10 py-4 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-400 hover:to-orange-400 text-gray-900 font-black text-xl rounded-full transition-all transform hover:scale-110 shadow-2xl border-b-4 border-orange-700 uppercase tracking-wide">
                        ¬°Iniciar Investigaci√≥n! <i class="fas fa-search ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Game UI -->
            <div id="plaza-game-ui" class="hidden flex flex-col h-full">
                <!-- Header with Progress -->
                <div class="flex justify-between items-center mb-6 bg-black/30 p-4 rounded-xl backdrop-blur-sm">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-fingerprint text-yellow-400 text-2xl"></i>
                        <span class="text-white font-bold text-lg">Caso <span id="plaza-case-number">1</span>/5</span>
                    </div>
                    <div class="flex items-center gap-2" id="plaza-credibility">
                        <!-- Stars will be inserted here -->
                    </div>
                    <div class="text-cyan-300 font-mono text-sm">
                        <i class="fas fa-clock mr-2"></i>
                        <span id="plaza-timer">00:00</span>
                    </div>
                </div>

                <!-- Scene Display -->
                <div
                    class="flex-grow bg-black/40 rounded-2xl p-8 mb-6 backdrop-blur-sm border-2 border-cyan-500/30 relative overflow-hidden">
                    <!-- Animated Scene Icon -->
                    <div class="absolute top-4 right-4 opacity-20">
                        <i id="plaza-scene-icon" class="fas fa-landmark text-9xl text-yellow-300"></i>
                    </div>

                    <div class="relative z-10">
                        <div class="flex items-start gap-4 mb-6">
                            <div
                                class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center flex-shrink-0 shadow-xl">
                                <i id="plaza-character-icon" class="fas fa-user text-4xl text-white"></i>
                            </div>
                            <div class="flex-grow">
                                <h3 id="plaza-character-name" class="text-2xl font-bold text-yellow-300 mb-2">Sospechoso
                                </h3>
                                <p id="plaza-scene-description" class="text-gray-200 text-lg leading-relaxed italic">
                                    Descripci√≥n de la escena...
                                </p>
                            </div>
                        </div>

                        <div
                            class="bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border-l-4 border-yellow-400 p-6 rounded-r-xl mt-6">
                            <p class="text-sm text-cyan-200 mb-2 uppercase tracking-wide font-bold">
                                <i class="fas fa-comment-dots mr-2"></i>Tu pregunta:
                            </p>
                            <p id="plaza-question" class="text-white text-2xl font-bold leading-relaxed">
                                Pregunta del detective...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Options -->
                <div id="plaza-options" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Options will be inserted here -->
                </div>

                <!-- Feedback Area -->
                <div id="plaza-feedback" class="h-16 flex items-center justify-center">
                    <!-- Feedback will appear here -->
                </div>
            </div>

            <!-- Win Screen -->
            <div id="plaza-win" class="hidden flex flex-col items-center justify-center h-full text-center">
                <div
                    class="w-56 h-56 bg-gradient-to-br from-green-400 to-emerald-500 rounded-full flex items-center justify-center mb-8 shadow-2xl animate-bounce">
                    <i class="fas fa-trophy text-9xl text-white drop-shadow-lg"></i>
                </div>
                <h1 class="font-handlee text-6xl text-yellow-300 mb-4 drop-shadow-lg">
                    ¬°Caso Resuelto! üéâ
                </h1>
                <p class="text-2xl text-cyan-200 mb-8 max-w-2xl">
                    Has capturado al ladr√≥n usando el subjuntivo perfectamente.
                    ¬°Eres un verdadero detective biling√ºe!
                </p>
                <div class="flex gap-4">
                    <button onclick="PlazaGame.init()"
                        class="px-8 py-3 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 text-white font-bold rounded-full transition-all transform hover:scale-110 shadow-lg">
                        <i class="fas fa-redo mr-2"></i>Jugar de Nuevo
                    </button>
                    <button onclick="Reveal.next()"
                        class="px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-400 hover:to-pink-400 text-white font-bold rounded-full transition-all transform hover:scale-110 shadow-lg">
                        Continuar <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Loss Screen -->
            <div id="plaza-loss" class="hidden flex flex-col items-center justify-center h-full text-center">
                <div
                    class="w-56 h-56 bg-gradient-to-br from-red-500 to-orange-600 rounded-full flex items-center justify-center mb-8 shadow-2xl">
                    <i class="fas fa-running text-9xl text-white drop-shadow-lg"></i>
                </div>
                <h1 class="font-handlee text-6xl text-red-300 mb-4 drop-shadow-lg">
                    ¬°El Ladr√≥n Escap√≥! üò±
                </h1>
                <p class="text-2xl text-gray-200 mb-8 max-w-2xl">
                    Perdiste toda tu credibilidad. El sospechoso huy√≥ de la escena.
                    ¬°Estudia el subjuntivo y vuelve a intentarlo!
                </p>
                <button onclick="PlazaGame.init()"
                    class="px-10 py-4 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-400 hover:to-orange-400 text-gray-900 font-black text-xl rounded-full transition-all transform hover:scale-110 shadow-2xl border-b-4 border-orange-700">
                    <i class="fas fa-redo mr-2"></i>Reintentar Misi√≥n
                </button>
            </div>

            <!-- Stamp Overlay for Feedback -->
            <div id="plaza-stamp-overlay"
                class="absolute inset-0 pointer-events-none flex items-center justify-center z-50">
                <!-- Stamps will appear here -->
            </div>
        </div>
    </section>

    <style>
        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }

        #plaza-scene-icon {
            animation: float 6s ease-in-out infinite;
        }
    </style>

    <script>
        // --- PLAZA DE BOL√çVAR DETECTIVE GAME LOGIC ---
        const PlazaGame = {
            state: {
                case: 0,
                credibility: 3,
                maxCredibility: 3,
                isProcessing: false,
                startTime: null,
                timerInterval: null,
                cases: [
                    {
                        character: "El Gu√≠a Tur√≠stico",
                        icon: "fa-user-tie",
                        scene: "fa-monument",
                        description: "Un gu√≠a tur√≠stico nervioso te mira con sospecha. Parece que sabe algo sobre el robo...",
                        question: "Se√±or gu√≠a, necesito que usted me ____ toda la verdad sobre lo que vio.",
                        options: ["dice", "diga", "dices", "digas"],
                        correct: 1,
                        feedback: "¬°Correcto! 'Necesito que' + Subjuntivo (Ud.) ‚Üí diga",
                        hint: "Influencia + Formalidad (Ud.)"
                    },
                    {
                        character: "La Vendedora de Flores",
                        icon: "fa-user-nurse",
                        scene: "fa-seedling",
                        description: "Una vendedora de flores estaba cerca cuando ocurri√≥ el robo. Est√° muy preocupada...",
                        question: "Es una l√°stima que el museo ____ cerrado justo cuando necesitamos investigar.",
                        options: ["est√°", "est√©", "est√°s", "est√©s"],
                        correct: 1,
                        feedback: "¬°Excelente! 'Es una l√°stima que' (emoci√≥n) ‚Üí Subjuntivo (est√©)",
                        hint: "Emoci√≥n/Valoraci√≥n ‚Üí Subjuntivo"
                    },
                    {
                        character: "El Turista Perdido",
                        icon: "fa-user-astronaut",
                        scene: "fa-map-marked-alt",
                        description: "Un turista confundido busca ayuda. Quiz√°s vio algo importante sin darse cuenta...",
                        question: "Busco un restaurante que ____ comida vegetariana cerca de aqu√≠.",
                        options: ["tiene", "tenga", "tienes", "tengas"],
                        correct: 1,
                        feedback: "¬°Perfecto! Antecedente indefinido/hipot√©tico ‚Üí Subjuntivo (tenga)",
                        hint: "¬øExiste o no existe? ‚Üí Subjuntivo si es hipot√©tico"
                    },
                    {
                        character: "El Fot√≥grafo Sospechoso",
                        icon: "fa-camera",
                        scene: "fa-camera-retro",
                        description: "Un fot√≥grafo con una c√°mara cara. ¬øEstaba documentando la plaza o planeando algo?",
                        question: "Dudo que √©l ____ inocente. Sus fotos muestran el museo desde todos los √°ngulos.",
                        options: ["es", "sea", "eres", "seas"],
                        correct: 1,
                        feedback: "¬°Brillante! 'Dudar que' (duda) ‚Üí Subjuntivo (sea)",
                        hint: "Duda/Negaci√≥n ‚Üí Subjuntivo"
                    },
                    {
                        character: "El Caricaturista",
                        icon: "fa-palette",
                        scene: "fa-paint-brush",
                        description: "Un artista callejero dibujaba retratos. Tiene una memoria visual excepcional...",
                        question: "Espero que usted ____ recordar los rostros de todas las personas que vio ayer.",
                        options: ["puede", "pueda", "puedes", "puedas"],
                        correct: 1,
                        feedback: "¬°Magistral! 'Esperar que' (deseo) + Ud. ‚Üí Subjuntivo (pueda)",
                        hint: "Deseo/Esperanza + Formalidad"
                    }
                ]
            },

            init: function () {
                this.state.case = 0;
                this.state.credibility = 3;
                this.state.isProcessing = false;
                this.state.startTime = null;

                if (this.state.timerInterval) {
                    clearInterval(this.state.timerInterval);
                }

                document.getElementById('plaza-intro').classList.remove('hidden');
                document.getElementById('plaza-game-ui').classList.add('hidden');
                document.getElementById('plaza-win').classList.add('hidden');
                document.getElementById('plaza-loss').classList.add('hidden');

                this.updateCredibilityUI();
            },

            start: function () {
                document.getElementById('plaza-intro').classList.add('hidden');
                document.getElementById('plaza-game-ui').classList.remove('hidden');

                this.state.startTime = Date.now();
                this.startTimer();
                this.loadCase();
            },

            startTimer: function () {
                this.state.timerInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.state.startTime) / 1000);
                    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const seconds = (elapsed % 60).toString().padStart(2, '0');
                    document.getElementById('plaza-timer').textContent = `${minutes}:${seconds}`;
                }, 1000);
            },

            loadCase: function () {
                if (this.state.case >= this.state.cases.length) {
                    this.showWin();
                    return;
                }

                const c = this.state.cases[this.state.case];

                // Update case number
                document.getElementById('plaza-case-number').textContent = this.state.case + 1;

                // Update character
                document.getElementById('plaza-character-name').textContent = c.character;
                document.getElementById('plaza-character-icon').className = `fas ${c.icon} text-4xl text-white`;

                // Update scene
                document.getElementById('plaza-scene-icon').className = `fas ${c.scene} text-9xl text-yellow-300`;
                document.getElementById('plaza-scene-description').textContent = c.description;

                // Update question
                document.getElementById('plaza-question').textContent = c.question;

                // Create options
                const optsContainer = document.getElementById('plaza-options');
                optsContainer.innerHTML = '';

                c.options.forEach((optText, idx) => {
                    const btn = document.createElement('button');
                    btn.className = "group relative p-6 bg-gradient-to-br from-slate-700 to-slate-800 border-2 border-cyan-500/30 rounded-xl text-left text-white font-bold hover:from-cyan-600 hover:to-blue-600 hover:border-cyan-400 transition-all shadow-lg hover:shadow-2xl hover:scale-105 transform";
                    btn.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-cyan-500/20 border-2 border-cyan-400 flex items-center justify-center text-lg group-hover:bg-cyan-400 group-hover:text-gray-900 transition-colors font-black">
                                ${String.fromCharCode(65 + idx)}
                            </div>
                            <span class="text-xl">${optText}</span>
                        </div>
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fas fa-arrow-right text-yellow-300"></i>
                        </div>
                    `;
                    btn.onclick = () => this.handleAnswer(idx);
                    optsContainer.appendChild(btn);
                });

                // Clear feedback
                document.getElementById('plaza-feedback').innerHTML = '';
                this.state.isProcessing = false;
            },

            handleAnswer: function (selectedIndex) {
                if (this.state.isProcessing) return;
                this.state.isProcessing = true;

                const c = this.state.cases[this.state.case];
                const isCorrect = selectedIndex === c.correct;

                // Visual feedback on button
                const opts = document.getElementById('plaza-options').children;
                if (opts[selectedIndex]) {
                    opts[selectedIndex].classList.remove('from-slate-700', 'to-slate-800', 'border-cyan-500/30');
                    if (isCorrect) {
                        opts[selectedIndex].classList.add('from-green-500', 'to-emerald-600', 'border-green-400');
                    } else {
                        opts[selectedIndex].classList.add('from-red-500', 'to-red-700', 'border-red-400', 'animate-shake');
                    }
                }

                // Show stamp
                const stampOverlay = document.getElementById('plaza-stamp-overlay');
                stampOverlay.innerHTML = '';

                const stamp = document.createElement('div');
                stamp.className = `stamp-animation border-8 font-black uppercase text-5xl px-10 py-6 rounded-xl transform rotate-12 bg-white/90 backdrop-blur-sm shadow-2xl ${isCorrect ? 'border-emerald-600 text-emerald-600' : 'border-red-600 text-red-600'}`;
                stamp.innerHTML = isCorrect ? '<i class="fas fa-check-circle mr-3"></i>CORRECTO' : '<i class="fas fa-times-circle mr-3"></i>ERROR';
                stampOverlay.appendChild(stamp);

                // Show feedback
                const feedbackDiv = document.getElementById('plaza-feedback');
                feedbackDiv.innerHTML = `
                    <div class="px-6 py-3 rounded-full ${isCorrect ? 'bg-green-500/20 border-2 border-green-400' : 'bg-red-500/20 border-2 border-red-400'}">
                        <p class="text-lg font-bold ${isCorrect ? 'text-green-300' : 'text-red-300'}">
                            <i class="fas ${isCorrect ? 'fa-lightbulb' : 'fa-exclamation-triangle'} mr-2"></i>
                            ${isCorrect ? c.feedback : c.hint}
                        </p>
                    </div>
                `;

                if (isCorrect) {
                    playSound('confetti');
                    if (typeof confetti !== 'undefined') {
                        confetti({
                            particleCount: 100,
                            spread: 70,
                            origin: { y: 0.6 }
                        });
                    }
                    setTimeout(() => {
                        this.state.case++;
                        this.loadCase();
                        stampOverlay.innerHTML = '';
                    }, 2500);
                } else {
                    playSound('error');
                    this.state.credibility--;
                    this.updateCredibilityUI();

                    if (this.state.credibility <= 0) {
                        setTimeout(() => this.showLoss(), 2000);
                    } else {
                        setTimeout(() => {
                            stampOverlay.innerHTML = '';
                            feedbackDiv.innerHTML = '';
                            // Reset button styles
                            Array.from(opts).forEach(b => {
                                b.classList.remove('from-red-500', 'to-red-700', 'border-red-400', 'animate-shake', 'from-green-500', 'to-emerald-600', 'border-green-400');
                                b.classList.add('from-slate-700', 'to-slate-800', 'border-cyan-500/30');
                            });
                            this.state.isProcessing = false;
                        }, 2500);
                    }
                }
            },

            updateCredibilityUI: function () {
                const container = document.getElementById('plaza-credibility');
                container.innerHTML = '';
                for (let i = 0; i < this.state.maxCredibility; i++) {
                    const star = document.createElement('i');
                    star.className = `fas fa-star drop-shadow-md text-2xl transition-all ${i < this.state.credibility ? 'text-yellow-400' : 'text-slate-600 opacity-30'}`;
                    container.appendChild(star);
                }
            },

            showWin: function () {
                if (this.state.timerInterval) {
                    clearInterval(this.state.timerInterval);
                }
                document.getElementById('plaza-game-ui').classList.add('hidden');
                document.getElementById('plaza-win').classList.remove('hidden');

                if (typeof confetti !== 'undefined') {
                    confetti({
                        particleCount: 200,
                        spread: 100,
                        origin: { y: 0.5 }
                    });
                }
                playSound('confetti');
            },

            showLoss: function () {
                if (this.state.timerInterval) {
                    clearInterval(this.state.timerInterval);
                }
                document.getElementById('plaza-game-ui').classList.add('hidden');
                document.getElementById('plaza-loss').classList.remove('hidden');
            }
        };

        // Initialize on load
        window.PlazaGame = PlazaGame;
    </script>

    <script>
        // --- BORDER CONTROL GAME LOGIC ---
        const BorderGame = {
            state: {
                level: 0,
                lives: 3,
                maxLives: 3,
                isProcessing: false,
                questions: [
                    {
                        text: "Necesito que me ____ su pasaporte.",
                        options: ["entregue", "entrega", "entregues"],
                        correct: 0,
                        feedback: "Formalidad (Ud.) + Influencia (Subjuntivo)"
                    },
                    {
                        text: "¬øTiene frutas? Es prohibido que las ____.",
                        options: ["trae", "traiga", "traigas"],
                        correct: 1,
                        feedback: "Es prohibido que (Impersonal) + Subjuntivo"
                    },
                    {
                        text: "Oficial: '¬øLe dio la maleta a mi compa√±ero?'<br>T√∫: 'S√≠, ya ____ di.'",
                        options: ["se la", "le la", "se lo"],
                        correct: 0,
                        feedback: "Le->Se ante Lo/La. Maleta=La. -> Se la di."
                    },
                    {
                        text: "Buscamos a un pasajero que ____ hablar tres idiomas.",
                        options: ["sabe", "sepa", "sab√©"],
                        correct: 1,
                        feedback: "Pasajero desconocido/hipot√©tico -> Subjuntivo (Sepa)"
                    },
                    {
                        text: "No quiero que usted ____ problemas. Vaya tranquilo.",
                        options: ["tenga", "tiene", "tengas"],
                        correct: 0,
                        feedback: "Deseo(No quiero) + Ud -> Tenga"
                    }
                ]
            },

            init: function () {
                this.state.level = 0;
                this.state.lives = 3;
                this.state.isProcessing = false;

                document.getElementById('border-intro').classList.remove('hidden');
                document.getElementById('border-game-ui').classList.add('hidden');
                document.getElementById('border-win').classList.add('hidden');
                document.getElementById('border-loss').classList.add('hidden');

                this.updateLivesUI();
            },

            start: function () {
                document.getElementById('border-intro').classList.add('hidden');
                document.getElementById('border-game-ui').classList.remove('hidden');
                this.loadLevel();
            },

            loadLevel: function () {
                if (this.state.level >= this.state.questions.length) {
                    this.showWin();
                    return;
                }

                const q = this.state.questions[this.state.level];
                document.getElementById('border-question-text').innerHTML = `"${q.text}"`;

                const optsContainer = document.getElementById('border-options');
                optsContainer.innerHTML = '';

                // Shuffle options visual order but keep track of indices or use string comparison?
                // Plan used indices. Let's map indices to buttons.

                q.options.forEach((optText, idx) => {
                    const btn = document.createElement('button');
                    btn.className = "w-full p-4 bg-white border-2 border-amber-200 rounded-lg text-left text-amber-900 font-bold hover:bg-amber-50 hover:border-amber-400 hover:pl-6 transition-all shadow-sm flex items-center gap-3 group";
                    btn.innerHTML = `
                        <div class="w-6 h-6 rounded-full border-2 border-amber-300 flex items-center justify-center text-xs group-hover:bg-amber-400 group-hover:text-white transition-colors">${String.fromCharCode(65 + idx)}</div>
                        <span>${optText}</span>
                    `;
                    btn.onclick = () => this.handleAnswer(idx);
                    optsContainer.appendChild(btn);
                });

                this.state.isProcessing = false;
            },

            handleAnswer: function (selectedIndex) {
                if (this.state.isProcessing) return;
                this.state.isProcessing = true;

                const q = this.state.questions[this.state.level];
                const isCorrect = selectedIndex === q.correct;

                const stampOverlay = document.getElementById('stamp-overlay');
                stampOverlay.innerHTML = '';

                const stamp = document.createElement('div');
                stamp.className = `stamp-animation border-4 font-black uppercase text-3xl px-6 py-2 rounded transform rotate-12 absolute bg-white/80 backdrop-blur-sm shadow-2xl ${isCorrect ? 'border-emerald-600 text-emerald-600' : 'border-red-600 text-red-600'}`;
                stamp.innerText = isCorrect ? 'ADMITIDO' : 'ERROR';
                stamp.style.top = '40%';
                stampOverlay.appendChild(stamp);

                const opts = document.getElementById('border-options').children;
                if (opts[selectedIndex]) {
                    opts[selectedIndex].classList.remove('bg-white', 'border-amber-200');
                    opts[selectedIndex].classList.add(isCorrect ? 'bg-emerald-100' : 'bg-red-100', isCorrect ? 'border-emerald-500' : 'border-red-500');
                }

                if (isCorrect) {
                    playSound('confetti'); // Assuming playSound exists globally
                    setTimeout(() => {
                        this.state.level++;
                        this.loadLevel();
                        stampOverlay.innerHTML = '';
                    }, 1500);
                } else {
                    playSound('error');
                    this.state.lives--;
                    this.updateLivesUI();

                    if (this.state.lives <= 0) {
                        setTimeout(() => this.showLoss(), 1000);
                    } else {
                        setTimeout(() => {
                            stampOverlay.innerHTML = '';
                            this.state.isProcessing = false;
                            // Optionally highlight correct? Nah, harder is better.
                            // Reset button styles
                            Array.from(opts).forEach(b => {
                                b.classList.remove('bg-red-100', 'border-red-500');
                                b.classList.add('bg-white', 'border-amber-200');
                            });
                        }, 1500);
                    }
                }
            },

            updateLivesUI: function () {
                const container = document.getElementById('border-lives');
                container.innerHTML = '';
                for (let i = 0; i < this.state.maxLives; i++) {
                    const heart = document.createElement('i');
                    heart.className = `fas fa-heart drop-shadow-md text-lg transition-all ${i < this.state.lives ? 'text-red-500' : 'text-slate-600 opacity-30'}`;
                    container.appendChild(heart);
                }
            },

            showWin: function () {
                document.getElementById('border-game-ui').classList.add('hidden');
                document.getElementById('border-win').classList.remove('hidden');
                if (typeof react === 'function') react('confetti');
            },

            showLoss: function () {
                document.getElementById('border-game-ui').classList.add('hidden');
                document.getElementById('border-loss').classList.remove('hidden');
            }
        };

        // Initialize on load if needed, or wait for user interaction
        // Expose to window
        window.BorderGame = BorderGame;
    </script>

  <script>
    fetch('/nav.html').then(function(r){ return r.text(); }).then(function(data){
      var el = document.getElementById('header-container');
      if (el) {
      el.innerHTML = data;
      var scripts = el.querySelectorAll('script');
      for (var i = 0; i < scripts.length; i++) {
        var sc = scripts[i];
        var ns = document.createElement('script');
        if (sc.src) ns.src = sc.src; else ns.textContent = sc.textContent;
        document.body.appendChild(ns);
      }
    }
    });
  </script>

</body>

</html>